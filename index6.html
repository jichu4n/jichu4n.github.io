<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?918c51a9" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html" rel="bookmark">
      NITDroid kernel 2.6.38 - 1st pass
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-09-20T02:44:27-07:00">
          Sep 20, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>It&#8217;s been a while since I last updated this blog - the summer has been unsurprisingly busy, and as school has started again my hiatus is now officially over. But first, a HUGE thanks to all who inquired about and commented on the NITDroid project in the meantime, as even though I haven&#8217;t been able to get back to you individually your support has meant a lot to me.</p></div>
<div class="paragraph"><p>The first challenge I decided to tackle was improving the kernel I used. The kernel I had gotten working was based on Android OMAP 2.6.32 and contained many patches and copied files from various sources that I did not understand and could not hope to port to a newer kernel if needed. Looking through the diff files revealed many unnecessary or irrelevant changes that made them essentially useless beyond Android OMAP 2.6.32, and given the availability of Gingerbread, I figured that it would be beneficial in the long run if I could 1) minimize the modifications to the kernel required, and 2) port these changes to a newer version of the kernel.</p></div>
<div class="paragraph"><p>I started working, therefore, with Android OMAP 2.6.38 (since <a href="http://git.kernel.org">kernel.org</a> is down <a href="http://linearfix.wordpress.com/2011/09/12/linux-com-and-linuxfoundation-org-down-after-security-breach/">due to a security breach</a>, I had to use a mirror at <a href="http://git.omapzoom.org/?p=kernel/omap.git;a=summary">git.omapzoom.org</a>). I spent two days porting each necessary change manually, but to no avail. I was able to fix a problem introduced in 2.6.38 where the LCD was being reset by inserting <code>for (;;) {}</code> to determine the source of the problem; only later did I discover <a href="http://www.mail-archive.com/linux-omap@vger.kernel.org/msg45684.html">this email by Michael Buesch</a> which proposed a much simpler solution. But even then I did not get far; I was still stuck with the Nokia logo screen and could go no further. I had forgotten how painful debugging kernel builds were: there are no error messages or debugging output, and the only thing observable would be a frozen Nokia logo.</p></div>
<div class="paragraph"><p>Then, at wit&#8217;s end a couple of hours ago, I searched for the author of said email on Google and found <a href="http://bu3sch.de/cms/hacking/n810-openwrt.html">Michael Buesch&#8217;s page about his and others' work on OpenWRT on the N810</a>. I followed the instructions and was able to build a working kernel for the N810 with some minor fixes. The truly marvellous thing about this work, however, is that the exact patches that are used against a vanilla kernel are provided; they can be viewed <a href="https://dev.openwrt.org/browser/trunk/target/linux/omap24xx/patches-2.6.38">in the OpenWRT SVN repo</a> for instance. I went ahead and applied all their patches to a vanilla Android OMAP 2.6.38 kernel, but the resulting kernel still refused to boot. I ended up comparing each affected file painstakingly to its counterpart in the OpenWRT tree and was finally able to find the culprit: <code>arch/arm/mach-omap2/clock2420_data.c</code>; the problem was so dumb that I cannot believe it has been checked in at all. Here&#8217;s the diff:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="gh">diff --git a/arch/arm/mach-omap2/clock2420_data.c b/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gh">index 3c1712b..0a992bc 100644</span>
<span class="gd">--- a/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gi">+++ b/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gu">@@ -1786,10 +1786,10 @@ static struct omap_clk omap2420_clks[] = {</span>
        CLK(NULL,       &quot;gfx_2d_fck&quot;,   &amp;gfx_2d_fck,    CK_242X),
        CLK(NULL,       &quot;gfx_ick&quot;,      &amp;gfx_ick,       CK_242X),
        /* DSS domain clocks */
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;ick&quot;,          &amp;dss_ick,       CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;fck&quot;,          &amp;dss1_fck,      CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;sys_clk&quot;,      &amp;dss2_fck,      CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;tv_clk&quot;,       &amp;dss_54m_fck,   CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;ick&quot;,          &amp;dss_ick,       CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;dss1_fck&quot;,     &amp;dss1_fck,      CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;dss2_fck&quot;,     &amp;dss2_fck,      CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;tv_fck&quot;,       &amp;dss_54m_fck,   CK_242X),</span>
        /* L3 domain clocks */
        CLK(NULL,       &quot;core_l3_ck&quot;,   &amp;core_l3_ck,    CK_242X),
        CLK(NULL,       &quot;ssi_fck&quot;,      &amp;ssi_ssr_sst_fck, CK_242X),
</pre></div></div></div>
<div class="paragraph"><p>With all of these changes, and essentially the same <code>n810_defconfig</code> from before, the produced kernel boots up to Android, but dies when it tries to initialize the GUI. I have not found a solution to that yet, but at least it boots to console and prints out error messages. I will need to investigate the issue further next time.</p></div>
<div class="paragraph"><p>From now on, I think I will no longer reinvent the wheel and rely on OpenWRT patches for the N810 as much as possible. Thanks, Michael Buesch and everyone at OpenWRT!</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Sep 20, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/qemu-arm-boot-tags.html" rel="bookmark">
      QEMU ARM boot tags
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-18T16:22:35-07:00">
          May 18, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/misc.html">Misc</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/qemu-arm-boot-tags.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I had to fight against a "feature" in QEMU today as I was screwing around. Normally when QEMU ARM boots a Linux kernel it sets up a tag list with all sorts of good information like available memory regions as explained <a href="http://www.arm.linux.org.uk/developer/booting.php">here</a>. This is the Linux&#8217;s standard for ARM and any ARM bootloader that loads Linux must do this. However, when I was booting my custom kernel with <code>qemu-system-arm</code> I discovered that R1 and R2 were empty upon boot using the switch <code>-monitor stdio</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>QEMU 0.13.0 monitor - type 'help' for more information
(qemu) info registers
R00=00000000 R01=00000000 R02=00000000 R03=00000000
R04=00000000 R05=00000000 R06=00000000 R07=00000000
R08=00000000 R09=00000000 R10=00000000 R11=00000000
R12=00000000 R13=00000000 R14=00000000 R15=00000020
PSR=400001d3 -Z-- A svc32</code></pre>
</div></div>
<div class="paragraph"><p>This meant of course that the kernel refused to load at all. In addition, nowhere in memory could the tag list be found, as I saw with a quick assembly search through memory space.</p></div>
<div class="paragraph"><p>So I downloaded the QEMU source code and found the relevant code in <code>hw/arm_boot.c</code>. The code there is pretty straightforward, and it turns out that QEMU ARM will only install a tag list if it determines kernel to be Linux. This is fine in itself, but the way it figures out if a given kernel is Linux is really stupid - as a comment in the file reads:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cm">/* Assume that raw images are linux kernels, and ELF images are not.  */</span>
</pre></div></div></div>
<div class="paragraph"><p>This is really silly as one just <code>objcopy -O binary</code> any kernel into a raw image anyway. So I just set the initial assignment to <code>is_linux = 1;</code> in <code>arm_load_kernel(&#8230;)</code>, compiled the ARM version, and copied it into my <code>/usr/bin</code>. Sigh.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 18, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/misc.html">Misc</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/qemu-arm-boot-tags.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/qemu-arm-boot-tags.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html" rel="bookmark">
      NITDroid userland update IV
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-14T22:14:26-07:00">
          May 14, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I was able to get hardware keys to work last night. After a deep dive into the Android event handling system (see <a href="?p=162">my previous post</a>), I inserted log outputs in strategic positions and determined that the hardware keys were indeed sending events through the keyboard controller like the keys on the hardware keyboard. This made my life immensely easier; all I had to do was create a custom keyboard layout and set the corresponding key codes to HOME, BACK and so on.</p></div>
<div class="paragraph"><p>The scan codes I found for the hardware keys through my experiments and the corresponding functions I assigned them under Android are summarized in the following table:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top"> Key                </th>
<th align="left" valign="top"> Code   </th>
<th align="left" valign="top"> Mapped to</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Switch application</p></td>
<td align="left" valign="top"><p class="table">63</p></td>
<td align="left" valign="top"><p class="table">Home</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Back</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">Back</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Full screen</p></td>
<td align="left" valign="top"><p class="table">64</p></td>
<td align="left" valign="top"><p class="table">Menu</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Minus sign</p></td>
<td align="left" valign="top"><p class="table">66</p></td>
<td align="left" valign="top"><p class="table">Vol down</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Plus sign</p></td>
<td align="left" valign="top"><p class="table">65</p></td>
<td align="left" valign="top"><p class="table">vol up</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Power</p></td>
<td align="left" valign="top"><p class="table">116</p></td>
<td align="left" valign="top"><p class="table">Power</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Menu</p></td>
<td align="left" valign="top"><p class="table">62</p></td>
<td align="left" valign="top"><p class="table">Menu</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>So I created a new board and a new product in the <code>build/</code> directory and defined the affected keys as follows in a new keyboard layout file, following the above results:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>key 1     BACK              WAKE_DROPPED
key 62    MENU              WAKE_DROPPED
key 63    HOME              WAKE
key 64    MENU              WAKE_DROPPED
key 65    VOLUME_UP
key 66    VOLUME_DOWN
key 116   POWER             WAKE</code></pre>
</div></div>
<div class="paragraph"><p>I also had to investigate how Android determined which keyboard layout file to look for. My search turned up this code in <code>EventHub::openDevice(&#8230;)</code> in <code>frameworks/base/libs/ui/EventHub.cpp</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">int</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">open_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deviceName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">EVIOCGNAME</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//fprintf(stderr, &quot;could not get device name for %s, %sn&quot;, deviceName, strerror(errno));</span>
        <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">CLASS_KEYBOARD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">tmpfn</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)];</span>
        <span class="kt">char</span> <span class="n">keylayoutFilename</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>

        <span class="c1">// a more descriptive name</span>
        <span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

        <span class="c1">// replace all the spaces with underscores</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
            <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

        <span class="c1">// find the .kl file we need for this device</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">root</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;ANDROID_ROOT&quot;</span><span class="p">);</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">),</span>
                 <span class="s">&quot;%s/usr/keylayout/%s.kl&quot;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tmpfn</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">defaultKeymap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">),</span>
                     <span class="s">&quot;%s/usr/keylayout/%s&quot;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s">&quot;qwerty.kl&quot;</span><span class="p">);</span>
            <span class="n">defaultKeymap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">device</span><span class="o">-&gt;</span><span class="n">layoutMap</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In other words, Android gets the device name from the device itself using <a href="http://linux.die.net/man/2/ioctl"><code>ioctl(2)</code></a>, replaces all spaces in it by underscores, and tries to load the keyboard layout file <code>/system/usr/keylayout/device_name.kl</code>. Originally in my kernel the N8x0 board initialization routines were overriding the device name to be "Internal Keyboard"; I felt that was a bit awkward and instead let the LM8323 driver itself assign the name to the default "LM8323 keypad". Therefore, my keyboard layout has to be named <code>LM8323_keypad.kl</code>. The Android build process automatically (well, I had to specify it in <code>BoardConfig.mk</code>) copies the keyboard layout file over to the correct location.</p></div>
<div class="paragraph"><p>Now when I tried building using my newly created board and product definitions, the build process was failing with the following error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>target thumb C++: libcameraservice &lt;= frameworks/base/camera/libcameraservice/CameraService.cpp
make: *** No rule to make target `out/target/product/n8x0/obj/lib/libcamera.so', needed by `out/target/product/n8x0/obj/SHARED_LIBRARIES/libcameraservice_intermediates/LINKED/libcameraservice.so'.  Stop.</code></pre>
</div></div>
<div class="paragraph"><p>It took me quite a while to figure out what was going on. Apparently, Android expects every new board to provide a camera / audio implementation; otherwise, one has to enable the stub camera implementation with the following line in <code>BoardConfig.mk</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">USE_CAMERA_STUB</span> <span class="o">:=</span> <span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>I found this after a long search in <a href="http://www.mail-archive.com/android-porting@googlegroups.com/msg05382.html">this thread</a>. The annoying thing is that while the generic board explicitly uses the stub audio implementation, it does not say anything about the stub camera implementation; why then does it compile thus without a problem whereas my custom board doesn&#8217;t?</p></div>
<div class="paragraph"><p>Finally, after a silly incident where the build system failed to copy over my modified keyboard layout file, I was able to use the hardware keys without further problems.</p></div>
<div class="paragraph"><p>As a safeguard, I set up some projects on <a href="http://github.com">GitHub</a> to track my work on NITDroid. Since they are also public they&#8217;re also effectively hosting my work. The projects are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-Kernel">The NITDroid kernel</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-UL-build">The <code>build/</code> directory in the Android source tree</a>, with my custom additions including the keyboard layout
</p>
</li>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-UL-frameworks-base">The <code>frameworks/base/</code> directory in the Android source tree</a>, with several mods discussed in previous posts such as <a href="?p=142">disabling the battery service</a> and <a href="?p=153">disabling screen power state reporting</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Moving forward, I will next try to work out power. A stable power management implementation is the basis for a stable system; without it the system is essentially a house of cards. But that will have to wait until next week.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 14, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html" rel="bookmark">
      Internal input event handling in the Linux kernel and the Android userspace
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-14T20:53:39-07:00">
          May 14, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>While figuring out hardware buttons for my NITDroid project, I had the opportunity of exploring the way Linux and Android handle input events internally before passing them through to the user application. This post traces the propagation of an input event from the Linux kernel through the Android userspace as far as I understand it. Although the principles are likely the same for essentially any input device, I will be drawing on my investigations of the drivers for the LM8323 hardware keyboard (<code>drivers/input/keyboard/lm8323.c</code>) and the TSC2005 touchscreen (<code>drivers/input/touchscreen/tsc2005.c</code>) which are both found inside the Nokia N810.</p></div>
<div class="sect2">
<h3 id="_i_inside_the_linux_kernel">I. Inside the Linux kernel</h3>
<div class="paragraph"><p>Firstly, Linux exposes externally a uniform input event interface for each device as <code>/dev/input/eventX</code> where <code>X</code> is an integer. This means these "devices" can be polled in the same way and the events they produce are in the same uniform format. To accomplish this, Linux has a standard set of routines that every device driver uses to register / unregister the hardware it manages and publish input events it receives.</p></div>
<div class="paragraph"><p>When the driver module of an input device is first loaded into the kernel, its initialization routine usually sets up some sort of probing to detect the presence of the types of hardware it is supposed to manage. This probing is of course device-specific; however, if it is successful, the module will eventually invoke the function <code>input_register_device(&#8230;)</code> in <code>include/linux/input.h</code> which sets up a file representing the physical device as <code>/dev/input/eventX</code> where <code>X</code> is some integer. The module will also register a function to handle IRQs originating from the hardware it manages via <code>request_irq(&#8230;)</code> (<code>include/linux/interrupt.h</code>) so that the module will be notified when the user interacts with the physical device it manages.</p></div>
<div class="paragraph"><p>When the user physically interacts with the hardware (for instance by pushing / releasing a key or exerting / lifting pressure on the touchscreen), an IRQ is fired and Linux invokes the IRQ handler registered by the corresponding device driver. However, IRQ handlers by custom must return quickly as they essentially block the entire system when executing and thus cannot perform any lengthy processing; typically, therefore, an IRQ handler would merely 1) save the data carried by the IRQ, 2) ask the kernel to schedule a method that would process the event later on when we have exited IRQ mode, and 3) tell the kernel we have handled the IRQ and exit. This could be very straightforward, as the IRQ handler in the driver for the LM8323 keyboard inside the N810:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * We cannot use I2C in interrupt context, so we just schedule work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">irqreturn_t</span> <span class="nf">lm8323_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">lm8323_chip</span> <span class="o">*</span><span class="n">lm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

        <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>It could also be more complex as the one in the driver of the TSC2005 touchscreen controller (<code>tsc2005_ts_irq_handler(&#8230;)</code>) as it integrates into the SPI framework (which I have never looked into&#8230;).</p></div>
<div class="paragraph"><p>Some time later, the kernel executes the scheduled method to process the recently saved event. Invariably, this method would report the event in a standard format by calling one or more of the <code>input_*</code> functions in <code>include/linux/input.h</code>; these include <code>input_event(&#8230;)</code> (general purpose), <code>input_report_key(&#8230;)</code> (for key down and key up events), <code>input_report_abs(&#8230;)</code> (for position events e.g. from a touchscreen) among others. Note that the <code>input_report_*(&#8230;)</code> functions are really just convenience functions that call <code>input_event(&#8230;)</code> internally, as defined in <code>include/linux/input.h</code>. It is likely that a lot of processing happens before the event is published via these methods; the LM8323 driver for instance does an internal key code mapping step and the TSC2005 driver goes through this crazy arithmetic involving Ohms (to calculate a pressure index from resistance data?). Furthermore, one physical IRQ could correspond to multiple published input events, and vice versa. Finally, when all event publishing is finished, the event processing method calls <code>input_sync(&#8230;)</code> to flush the event out. The event is now ready to be accessed by the userspace at <code>/dev/input/eventX</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_ii_inside_the_android_userspace">II. Inside the Android userspace</h3>
<div class="paragraph"><p>When the Android GUI starts up, an instance of the class <code>WindowManagerService</code> (<code>frameworks/base/services/java/com/android/server/WindowManagerservice.java</code>) is created. This class, when constructed, initializes the member field</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">final</span> <span class="n">KeyQ</span> <span class="n">mQueue</span><span class="o">;</span>
</pre></div></div></div>
<div class="paragraph"><p>where <code>KeyQ</code>, defined as a private class inside the same file, extends Android&#8217;s basic input handling class, the abstract class <code>KeyInputQueue</code> (<code>frameworks/base/services/java/com/android/server/KeyInputQueue.java</code> and <code>frameworks/base/services/jni/com_android_server_KeyInputQueue.cpp</code>). As <code>mQueue</code> is instantiated, it of course calls the constructor of <code>KeyInputQueue</code>; the latter, inconspicuously, starts an anonymous thread it owns that is at the heart of the event handling system in Android:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">Thread</span> <span class="n">mThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&quot;InputDeviceReader&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">RawInputEvent</span> <span class="n">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RawInputEvent</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">readEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  <span class="c1">// block, doesn&#39;t release the monitor</span>

                <span class="kt">boolean</span> <span class="n">send</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_DEVICE_ADDED</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_DEVICE_REMOVED</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">di</span> <span class="o">=</span> <span class="n">getInputDevice</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
                    <span class="o">...</span>
                    <span class="c1">// first crack at it</span>
                    <span class="n">send</span> <span class="o">=</span> <span class="n">preprocessEvent</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">ev</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">send</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mFirst</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                    <span class="c1">// Is it a key event?</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_KEY</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">scancode</span> <span class="o">&lt;</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">BTN_FIRST</span> <span class="o">||</span>
                                    <span class="n">scancode</span> <span class="o">&gt;</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">BTN_LAST</span><span class="o">))</span> <span class="o">{</span>
                        <span class="kt">boolean</span> <span class="n">down</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">down</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">di</span><span class="o">.</span><span class="na">mKeyDownTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">down</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="kt">int</span> <span class="n">keycode</span> <span class="o">=</span> <span class="n">rotateKeyCodeLocked</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">keycode</span><span class="o">);</span>
                        <span class="n">addLocked</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">curTimeNano</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span>
                                <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">,</span>
                                <span class="n">newKeyEvent</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">di</span><span class="o">.</span><span class="na">mKeyDownTime</span><span class="o">,</span> <span class="n">curTime</span><span class="o">,</span> <span class="n">down</span><span class="o">,</span>
                                        <span class="n">keycode</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">scancode</span><span class="o">,</span>
                                        <span class="o">((</span><span class="n">ev</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">FLAG_WOKE_HERE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                                         <span class="o">?</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">FLAG_WOKE_HERE</span> <span class="o">:</span> <span class="mi">0</span><span class="o">));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_KEY</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_ABS</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN_MT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process position events from multitouch protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_ABS</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process position events from single touch protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_REL</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process movement events from trackball (mouse) protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                <span class="o">}</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exc</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;InputReaderThread uncaught exception&quot;</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div></div></div>
<div class="paragraph"><p>I have removed most of this ~350 lined function that is irrelevant to our discussion and reformatted the code for easier reading. The key idea is that this independent thread will</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Read an event
</p>
</li>
<li>
<p>
Call the <code>preprocess(&#8230;)</code> method of its derived class, offering the latter a chance to prevent the event from being propagated further
</p>
</li>
</ol></div>
<div class="paragraph"><p>3.Add it to the event queue owned by the class</p></div>
<div class="paragraph"><p>This <code>InputDeviceReader</code> thread started by <code>WindowManagerService</code> (indirectly via <code>KeyInputQueue&#8217;s constructor</code>) is thus THE event loop of the Android UI.</p></div>
<div class="paragraph"><p>But we are still missing the link from the kernel to this <code>InputDeviceReader</code>. What exactly is this magical <code>readEvent(&#8230;)</code>? It turns out that this is actually a native method implemented in the C++ half of <code>KeyInputQueue</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">static</span> <span class="n">Mutex</span> <span class="n">gLock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">EventHub</span><span class="o">&gt;</span> <span class="n">gHub</span><span class="p">;</span>

<span class="k">static</span> <span class="n">jboolean</span>
<span class="nf">android_server_KeyInputQueue_readEvent</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span>
                                          <span class="n">jobject</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">EventHub</span><span class="o">&gt;</span> <span class="n">hub</span> <span class="o">=</span> <span class="n">gHub</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hub</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">hub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventHub</span><span class="p">;</span>
        <span class="n">gHub</span> <span class="o">=</span> <span class="n">hub</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>

    <span class="p">...</span>
    <span class="kt">bool</span> <span class="n">res</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">getEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deviceId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keycode</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">when</span><span class="p">);</span>
    <span class="p">...</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ah, so <code>readEvent</code> is really just a proxy for <code>EventHub::getEvent(&#8230;)</code>. If we proceed to look up <code>EventHub</code> in <code>frameworks/base/libs/ui/EventHub.cpp</code>, we find</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">int</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">scan_dir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirname</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dirname</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">)))</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">open_device</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_path</span> <span class="o">=</span> <span class="s">&quot;/dev/input&quot;</span><span class="p">;</span>
<span class="p">...</span>

<span class="kt">bool</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">openPlatformInput</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scan_dir</span><span class="p">(</span><span class="n">device_path</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">getEvent</span><span class="p">(</span><span class="kt">int32_t</span><span class="o">*</span> <span class="n">outDeviceId</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outType</span><span class="p">,</span>
        <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outScancode</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outKeycode</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">outFlags</span><span class="p">,</span>
        <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outValue</span><span class="p">,</span> <span class="kt">nsecs_t</span><span class="o">*</span> <span class="n">outWhen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mOpened</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mError</span> <span class="o">=</span> <span class="n">openPlatformInput</span><span class="p">()</span> <span class="o">?</span> <span class="nl">NO_ERROR</span> <span class="p">:</span> <span class="n">UNKNOWN_ERROR</span><span class="p">;</span>
        <span class="n">mOpened</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// First, report any devices that had last been added/removed.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mClosingDevices</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">DEVICE_REMOVED</span><span class="p">;</span>
            <span class="k">delete</span> <span class="n">device</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mOpeningDevices</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">DEVICE_ADDED</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">...</span>
        <span class="n">pollres</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">mFDs</span><span class="p">,</span> <span class="n">mFDCount</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">...</span>

        <span class="c1">// mFDs[0] is used for inotify, so process regular events starting at mFDs[1]</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mFDCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iev</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iev</span><span class="p">))</span> <span class="p">{</span>
                        <span class="p">...</span>
                        <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
                        <span class="o">*</span><span class="n">outScancode</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">iev</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="n">mDevices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">layoutMap</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">outKeycode</span><span class="p">,</span> <span class="n">outFlags</span><span class="p">);</span>
                            <span class="p">...</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="o">*</span><span class="n">outKeycode</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="p">...</span>
                        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="c1">// Error handling</span>
                        <span class="p">...</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Again, most of the details have been stripped out from the above code, but we now see how <code>readEvent()</code> in <code>KeyInputQueue</code> is getting these events from Linux: on first call, <code>EventHub::getEvent</code> scans the directory <code>/dev/input</code> for input devices, opens them and saves their file descriptors in an array called <code>mFDs</code>. Then whenever it is called again, it tries to read from each of these input devices by simply calling the <a href="http://linux.die.net/man/2/read"><code>read(2)</code></a> Linux system call.</p></div>
<div class="paragraph"><p>OK, now we know how an event propagates through <code>EventHub::getEvent(&#8230;)</code> to <code>KeyInputQueue::readEvent(&#8230;)</code> then to <code>InputDeviceReader.run(&#8230;)</code> where it could get queued inside <code>WindowManagerService.mQueue</code> (which, as a reminder, extends the otherwise abstract <code>KeyInputQueue</code>). But what happens then? How does that event get to the client application?</p></div>
<div class="paragraph"><p>Well, it turns out that <code>WindowManagerService</code> has yet another private member class that handles just that:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InputDispatcherThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">process</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Exception in input dispatcher&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
                <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_URGENT_DISPLAY</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="c1">// Retrieve next event, waiting only as long as the next</span>
            <span class="c1">// repeat timeout.  If the configuration has changed, then</span>
            <span class="c1">// don&#39;t wait at all -- we&#39;ll report the change as soon as</span>
            <span class="c1">// we have processed all events.</span>
            <span class="n">QueuedEvent</span> <span class="n">ev</span> <span class="o">=</span> <span class="n">mQueue</span><span class="o">.</span><span class="na">getEvent</span><span class="o">(</span>
                <span class="o">(</span><span class="kt">int</span><span class="o">)((!</span><span class="n">configChanged</span> <span class="o">&amp;&amp;</span> <span class="n">curTime</span> <span class="o">&lt;</span> <span class="n">nextKeyTime</span><span class="o">)</span>
                        <span class="o">?</span> <span class="o">(</span><span class="n">nextKeyTime</span><span class="o">-</span><span class="n">curTime</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span><span class="o">));</span>
            <span class="o">...</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ev</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">curTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">eventType</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">eventType</span><span class="o">((</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span> <span class="o">||</span>
                                <span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">LocalPowerManager</span><span class="o">.</span><span class="na">BUTTON_EVENT</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">LocalPowerManager</span><span class="o">.</span><span class="na">OTHER_EVENT</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">:</span>
                            <span class="n">KeyEvent</span> <span class="n">ke</span> <span class="o">=</span> <span class="o">(</span><span class="n">KeyEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">ke</span><span class="o">.</span><span class="na">isDown</span><span class="o">())</span> <span class="o">{</span>
                                <span class="n">lastKey</span> <span class="o">=</span> <span class="n">ke</span><span class="o">;</span>
                                <span class="n">downTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">keyRepeatCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                                <span class="n">lastKeyTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">nextKeyTime</span> <span class="o">=</span> <span class="n">lastKeyTime</span>
                                        <span class="o">+</span> <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">getLongPressTimeout</span><span class="o">();</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">lastKey</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                                <span class="n">downTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                                <span class="c1">// Arbitrary long timeout.</span>
                                <span class="n">lastKeyTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">nextKeyTime</span> <span class="o">=</span> <span class="n">curTime</span> <span class="o">+</span> <span class="n">LONG_WAIT</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">dispatchKey</span><span class="o">((</span><span class="n">KeyEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="n">mQueue</span><span class="o">.</span><span class="na">recycleEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">:</span>
                            <span class="n">dispatchPointer</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="o">(</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">:</span>
                            <span class="n">dispatchTrackball</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="o">(</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_CONFIGURATION_CHANGED</span><span class="o">:</span>
                            <span class="n">configChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="n">mQueue</span><span class="o">.</span><span class="na">recycleEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">configChanged</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">lastKey</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span>
                    <span class="s">&quot;Input thread received uncaught exception: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>As we can see, this thread started by <code>WindowManagerService</code> is very simple; all it does is</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Grabs events queued into <code>WindowManagerService.mQueue</code>
</p>
</li>
<li>
<p>
Calls <code>WindowManagerService.dispatchKey(&#8230;)</code> when appropriate.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If we next inspect <code>WindowManagerService.dispatchKey(&#8230;)</code>, we would see that it checks the currently focused window, and calls <code>android.view.IWindow.dispatchKey(&#8230;)</code> on that window. The event is now in the user space.</p></div>
<div class="paragraph"><p>I put together some nice diagrams that illustrate these interactions. The conceptual model:</p></div>
<div class="paragraph"><p><div align="center">
<strong>Event propagation flow on Android - simplified version</strong>
<img
src="https://docs.google.com/drawings/d/1qgD3O5ZZk1cC5tq6kLd_jKEtXx4P1Ty4wsSAHRKfhiU/pub?w=962&h=422"
style="width: 100%; max-width: 962px;"
alt="Event propagation flow on Android - simplified version">
</div></p></div>
<div class="paragraph"><p>The full model:
<div align="center">
<strong>Event propagation flow on Android</strong>
<img
src="https://docs.google.com/drawings/d/1VNaRYLdN5fOEz32XMzIR-ygphE-VD16CZltgV3aXavs/pub?w=750&h=902"
style="width: 100%; max-width: 750px;"
alt="Event propagation flow on Android">
</div></p></div>
<div class="paragraph"><p>The yellow boxes are Java implementations, and the blue boxes native or other.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 14, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/prevent-android-app-from-restarting-on-rotate-hardware-keyboard-state-change.html" rel="bookmark">
      Prevent Android app from restarting on rotate / hardware keyboard state change
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-13T03:19:41-07:00">
          May 13, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/prevent-android-app-from-restarting-on-rotate-hardware-keyboard-state-change.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I came across a puzzling phenomenon while working on an Android
application today.</p></div>
<div class="sect2">
<h3 id="_problem">Problem</h3>
<div class="paragraph"><p>When I rotate the device (change orientation) or pop out the hardware keyboard,
my <code>Activity</code> gets paused (<code>onPause()</code>), stopped (<code>onStop()</code>), destroyed
(<code>onDestroy()</code>), then recreated (<code>onCreate()</code>), started (<code>onStart()</code>), and
resumed (<code>onResume()</code>). It was as if the user had quit the application and
killed it and launched it again.  It was crashing my application as nowhere in
the documentation had I ever read that rotating the deviced would cause such a
strange chain of events to happen.</p></div>
<div class="paragraph"><p>Although my app had implemented its <code>onSurfaceChanged()</code> method which, according
to the documentation, should be called when the device is rotated among other
things, it wasn&#8217;t happening according to my logs.</p></div>
</div>
<div class="sect2">
<h3 id="_solution">Solution</h3>
<div class="paragraph"><p>It turns out that the <code>&lt;activity&gt;</code> tags in the <code>AndroidManifest.xml</code> have a
<code>configChanges</code> attribute that specifies which of a number of events the
application is set up to handle itself. Any of the events, if not explicitly
listed in an <code>&lt;activity&gt;</code> tag in <code>AndroidManifest.xml</code>, would cause Android to
destroy and then restart the <code>Activity</code> anew. (See
<a href="http://developer.android.com/guide/topics/manifest/activity-element.html#config">official
documentation</a>.)</p></div>
<div class="paragraph"><p>These include notably the orientation change (rotation) and the hardware
keyboard state. To handle these, the <code>&lt;activity&gt;</code> tag in your
<code>AndroidManifest.xml</code> must contain at least the following:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nt">&lt;activity</span>
    <span class="err">...</span>
    <span class="na">android:configChanges=</span><span class="s">&quot;keyboard|keyboardHidden|orientation|screenSize&quot;</span><span class="nt">&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that <code>screenSize</code> was added in API level 13 (Honeycomb 3.2).</p></div>
<div class="paragraph"><p>I guess in a way this makes sense; if an application did not include adequate
event handlers, all of these events could potentially cause the application to
crash if left running on its own. Therefore, Android just kills it and restarts
it so that it would presumably correctly initialize itself in the new
environment when it starts up again. But this attribute really ought to be
heavily publicized in any introductory text as it is likely to cause noobs like
me quite some bewilderment.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 13, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/prevent-android-app-from-restarting-on-rotate-hardware-keyboard-state-change.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/prevent-android-app-from-restarting-on-rotate-hardware-keyboard-state-change.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/index5.html">&larr; Previous</a></li>
    <li class="next"><a href="https://seasonofcode.com/index7.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>