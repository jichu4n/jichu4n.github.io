<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="http://seasonofcode.com/assets/favicon.ico" />
      <link href="http://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="http://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="http://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="http://seasonofcode.com/theme/style.min.css?918c51a9" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="http://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="http://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="http://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="http://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="http://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="http://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="http://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="http://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="http://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="http://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="http://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="http://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="http://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html" rel="bookmark">
      Carrier programming on CDMA Android phones
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2012-11-15T23:57:36-08:00">
          Nov 15, 2012
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/android.html">Android</a>,            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Have you ever wondered how CDMA phones are programmed to a specific carrier for
voice calls, SMS and data?</p></div>
<div class="paragraph"><p>In the U.S., all major CDMA carriers operate on the same frequencies, which
means that there is no inherent difference in hardware between phones sold by
any of them, and that theoretically there is no reason why a Verizon Wireless
phone cannot work on Sprint or MetroPCS or Virgin Mobile or Boost Mobile, for
example. Unlike GSM phones with swappable SIM&#8217;s, however, a CDMA phone sold in
the U.S. is typically locked to a particular carrier; so how is that done?</p></div>
<div class="paragraph"><p>I was recently able to figure out the answer to this question when I
successfully flashed a CDMA phone from Sprint to Verizon (an exploit documented
in <a href="/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html">Flashing a Sprint
Nexus S 4G to Verizon</a>). As I have not been able to find a compilation of this
information elsewhere, I am writing up this document in the hope that it will
help others with flashing phones or porting ROMs to different carriers.</p></div>
<div class="paragraph"><p>Note that this information is based on my research with the Jelly Bean (4.1 &amp;
4.2), ICS (4.0) and Gingerbread (2.3.4) versions of Android and two major U.S.
CDMA carriers, Verizon Wireless and Sprint. Hence, it may not be applicable to
other phones or carriers; in particular, the section about CDMA chips do not
apply to CDMA phones that require a SIM card, such as some Verizon Wireless LTE
phones. In such cases, your comments and insights are welcome.</p></div>
<div class="paragraph"><p>Finally, a disclaimer: I have no formal understanding of any of the intricacies
of CDMA technology and therefore cannot guarantee the correctness or accuracy of
this information. Use it at your own risk. I cannot be held responsible for any
damage or legal consequences resulting from or related to the application of
this information.</p></div>
<div class="paragraph"><p>At a high level, there are two places where carrier information is stored on a
CDMA Android phone: inside the CDMA chip (radio), and in Android OS system
files.</p></div>
<div class="sect2">
<h3 id="_programming_the_cdma_chip">Programming the CDMA chip</h3>
<div class="paragraph"><p>Every CDMA phone (obviously) has a CDMA chip (radio). This chip is responsible
for carrying out voice calls and transferring data over 2G/3G, and in order to
do that, it needs to know stuff like what phone number it represents, what
towers to connect to, what account name to bill the 3G connection to, etc.. All
of this information is stored directly inside the chip (unless you have a
Verizon Wireless LTE phone with a SIM card), and not on any file system
controlled by the OS; this is why even after a factory reset (which formats the
internal flash file system) these settings persist. It is (I believe) not
possible to change the information stored on the CDMA chip from the OS itself;
instead, carriers provide a special number (e.g., *228 for Verizon Wireless)
that, when called, will transfer the information to the chip. This is typically
called "programming" the phone by U.S. carriers.</p></div>
<div class="paragraph"><p>So what information exactly is stored inside the CDMA chip? Here&#8217;s an incomplete
list:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>MEID</strong>: Unique serial number of the phone. This is like the MAC address of an
  ethernet / WiFi card in that it is the sole identifier of the CDMA chip. It is
  what carriers use to connect phone calls, deliver SMS&#8217;s, blacklist stolen
  phones, etc.. A fatal flaw, however, is that it is actually possible to modify
  (flash) the MEID of many, but not all, CDMA chips. If you flash the MEID of
  phone A onto phone B, the carrier network has no way of distinguishing between
  phone A and phone B, and phone B is able to make and receive calls, send and
  receive messages etc. as phone A. Unsurprisingly, this is illegal in many
  countries, including the U.S., and as such I will not discuss it here.
</p>
</li>
<li>
<p>
<strong>Phone / account numbers</strong>: known as MDN and MIN, these store the phone and
  account numbers associated with the phone.
</p>
</li>
<li>
<p>
<strong>2G/3G data account information</strong>: user names and passwords used to connect to
  data services. Some carriers have stronger (harder to impersonate)
  authentication systems than others; for instance, Verizon Wireless requires
  two encrypted passwords and a secret key in the EFS file system on the CDMA
  chip; Boost Mobile only requires two passwords; while MetroPCS simply accepts
  the SPC/MSL code (see below) as the password. Note that 2G and 3G are
  unrelated systems with independent authentication; a phone can have valid 3G
  credentials and thus connect to 3G while being denied a 2G connection.
</p>
</li>
<li>
<p>
<strong>PRL (Preferred Roaming List)</strong>: a list of towers the phone can connect to. This
  is of course carrier- and location-specific. In some cases, updating the PRL
  (by calling a special number) can improve reception and save battery when the
  phone moves to a new geographical area; see
  <a href="http://www.verizonwireless.com/care/popups/prl.html">Verizon Wireless&#8217;s
  explanation</a>, for example.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Software such as CDMA Workshop, DFS, QXDM/QPST can be used to read / write
information stored on a CDMA chip from a computer. Often, however, a 6-digit
passcode known as the SPC code or the MSL code is required. This SPC/MSL code,
again stored inside the CDMA chip, is either randomly assigned by the carrier
(this is the case for Verizon Wireless and Sprint) or deterministically computed
based on the MEID (MetroPCS). In the former case, there are a variety of tricks
for retrieving the SPC/MSL code from the phone itself,; Google is your friend
there. In the latter case, there are sites for computing the code from the MEID.
Once it is known, the SPC/MSL code can be changed to any 6-digit number; some
phones may even allow you to overwrite the SPC/MSL code without knowing it
first.</p></div>
</div>
<div class="sect2">
<h3 id="_carrier_configuration_in_the_android_os">Carrier configuration in the Android OS</h3>
<div class="paragraph"><p>To figure out what system files in the Android OS contain carrier information, I
inspected source code and images of ROMS for the Samsung Galaxy Nexus (Sprint
and Verizon Wireless), the Samsung Nexus S 4G (Sprint), the HTC Incredible
(Verizon Wireless), and the Motorola Droid 3 (Verizon Wireless). I found three
places that store carrier-specific information.</p></div>
<div class="paragraph"><p>The first is <code>/system/build.prop</code>. Sprint phones contain the following lines:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310120
ro.cdma.home.operator.alpha=Sprint</code></pre>
</div></div>
<div class="paragraph"><p>while Verizon Wireless phones contain the following lines instead:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310004
ro.cdma.home.operator.alpha=Verizon
ro.cdma.homesystem=64,65,76,77,78,79,80,81,82,83</code></pre>
</div></div>
<div class="paragraph"><p>These settings apply to phone calls. If one adopts the Sprint configuration on a
Verizon Wireless phone, for example, the phone would ring very briefly on a
call, but would be unable to actually make or receive calls. The
<code>ro.cdma.homesystem</code> specifies a list of indices into the PRL that represent
"home" or non-roaming networks.</p></div>
<div class="paragraph"><p>The second configuration file is <code>eri.xml</code>, which is compiled into the file
<code>/res/xml/eri.xml</code> inside the system package
<code>/system/framework/framework-res.apk</code> on an Android system. This file tells the
OS what it needs to display about a particular network (as an index into the
PRL); for an example, take a look at
<a href="https://android.googlesource.com/device/samsung/toroplus/<code>/refs/tags/android-4.2_r1/overlay/frameworks/base/core/res/res/xml/eri.xml">the
stock +eri.xml</code> for the Sprint Galaxy Nexus</a> or
<a href="https://github.com/CyanogenMod/android_device_samsung_toro/blob/ics/overlay/frameworks/base/core/res/res/xml/eri.xml">the
CyanogenMod <code>eri.xml</code> for the Verizon Wireless Galaxy Nexus</a>. In particular,
this file instructs the OS whether to consider a network (tower) to be roaming
(so whether a roaming icon is displayed), and gives the name of the network
(tower) to be shown in the UI. It must be stressed that this file <em>has no
functional effect</em>; all it changes is how the OS displays information about
networks. Since APK packages are just ZIP archives, it is easy to replace the
<code>eri.xml</code> within to change roaming and name settings for networks; note,
however, that the file inside the APK is not a plain text XML, but some compiled
binary form; you may need to Google for the appropriate binary form pulled from
another phone.</p></div>
<div class="paragraph"><p>The last configuration file is <code>/system/etc/apns-conf.xml</code>. This file contains
APN settings for 4G and MMS. See the stock APN settings file for the
<a href="https://android.googlesource.com/device/samsung/crespo4g/+/refs/heads/jb-release/4g-apns-conf.xml">Sprint
Nexus S 4G</a> or the
<a href="https://github.com/CyanogenMod/android_vendor_cm/blob/ics/prebuilt/common/etc/apns-conf-cdma.xml">default
CyanogenMod APN settings</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_step_by_step_guide">Step-by-step guide</h3>
<div class="paragraph"><p>If you&#8217;re interested in learning more about how exactly this works, you&#8217;re
welcome to take a look at my follow-up article
<a href="/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html">Flashing a Sprint Nexus
S 4G to Verizon</a>, which documents the process of flashing an actual phone.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 15, 2012
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/android.html">Android</a>,          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/announcing-jfbview.html" rel="bookmark">
      Announcing JFBView
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2012-11-10T18:41:27-08:00">
          Nov 10, 2012
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/announcing-jfbview.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Around April this year I had heavily patched a PDF viewer for the Linux
framebuffer called FBPDF, which was written by Ali Gholami Rudi in C. Over the
past week I took up the project of completely rewriting a PDF / image viewer
from scratch in C++ with advanced stuff like multi-threaded rendering and
background caching and so on, and I am proud to announce the result - JFBView.</p></div>
<div class="paragraph"><p>JFBView is a PDF and image viewer for the Linux framebuffer. Head over to the
<a href="/pages/jfbview.html">JFBView home page</a> for links to source and
documentation.</p></div>
<div class="paragraph"><p>If your are an ArchLinux user, you can install JFBView from the
<a href="https://aur.archlinux.org/packages/jfbview/">AUR</a>.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 10, 2012
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/announcing-jfbview.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/announcing-jfbview.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/nitdroid-userland-update-vii.html" rel="bookmark">
      NITDroid userland update VII
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-26T09:50:15-07:00">
          Oct 26, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vii.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I&#8217;ve been able to get wireless working - well, sort of. The problem in my last
post about the DHCP client failing to start was solved by adding
<code>wifi.interface=wlan0</code> in <code>default.prop</code> (doesn&#8217;t really matter where though;
could have used <code>system.prop</code> for instance) as suggested by
<a href="http://groups.google.com/group/android-porting/browse_thread/thread/780b447e8d2641ab">this
thread</a>. After fixing some more permission problems, I was able to connect to
the open WiFi networks at my school:</p></div>
<div class="paragraph"><div class="title">Wireless in Gingerbread (Android 2.3.7) on the Nokia N810</div><p><span class="image">
<a class="image" href="/assets/files/nitdroid/nitdroid_20111026_1.jpg">
<img src="/assets/files/nitdroid/nitdroid_20111026_1_small.jpg" alt="Wireless settings in Gingerbread on the Nokia N810" width="250" />
</a>
</span>
<span class="image">
<a class="image" href="/assets/files/nitdroid/nitdroid_20111026_2.jpg">
<img src="/assets/files/nitdroid/nitdroid_20111026_2_small.jpg" alt="Browser showing welcome page from wireless network on the Nokia N810" width="250" />
</a>
</span></p></div>
<div class="paragraph"><p>However, at our school, internet is provided only through an EAP-encrypted
network (Purple Air in the above image). The school provides in addition two
open WiFi networks. One, Purple Help in the above image, redirects all traffic
to a help page which provides instructions on how to connect to the main
EAP-encrypted network. The other, Guest in the above image, is for visiting
guests to the college and will only give internet access if you knew a guest
user name and password privately assigned to each visitor. The N810 is now able
to connect to both of the two open networks, but is unable to connect to the EAP
network. I am not surprised by this because our EAP network is  set up so badly
that I have not been able to make my Thinkpad laptop connect to it under Linux
either, nor is the N810 able to connect to the network even using the
proprietary driver under stock Maemo. Therefore, I have not been able to get
internet on the device, but that is hardly the fault of Android, the driver, or
the device.</p></div>
<div class="paragraph"><p>I next tried tethering my phone as an AP, but while my laptop and tablet can
connect to the phone fine, the N810 is not showing it in the list of scan
results in Android. Using the proprietary driver for the wireless chip in stock
Maemo, the N810 <em>is</em> able to connect to my phone. This means that there are
still problems with the open source driver for the wireless chip in the N810,
but I do know now that at least open WiFi networks on standard routers do work
fine. Since I do not have a wireless router of my own, I have not been able to
test further.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 26, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vii.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vii.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/nitdroid-userland-update-vi.html" rel="bookmark">
      NITDroid userland update VI
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-25T03:19:00-07:00">
          Oct 25, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vi.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I have been working on getting wireless to work on the N810 under Gingerbread. So far I have not been successful, but I have made a lot of progress along the way.</p></div>
<div class="paragraph"><p>I started out basically follwing <a href="http://blog.linuxconsulting.ro/2010/04/porting-wifi-drivers-to-android.html">this great article on porting WiFi drivers to Android</a>. For some reason, if I compiled the driver for the wireless chip on the N810 (<code>p54spi</code>) directly into the kernel, the kernel refuses to boot. Therefore, I compiled it as a module, grabbed the firmware required from <a href="http://linuxwireless.org/en/users/Drivers/p54">the official site of the p54 driver</a> and add the corresponding changes to <code>Android.mk</code> and <code>BoardConfig.mk</code> as described in the <a href="http://blog.linuxconsulting.ro/2010/04/porting-wifi-drivers-to-android.html">aforementioned article</a>.</p></div>
<div class="paragraph"><p>But, as <a href="http://blog.linuxconsulting.ro/2010/04/porting-wifi-drivers-to-android.html">the same article</a> explains, Android, rather than using the normal control functions in wpa_supplicant like a normal Linux system, expects wireless drivers to implement Android&#8217;s custom set of commands directly on top of SIOCSIWPRIV, and relies on those instead. I do not understand the rationale behind such a design decision; why reinvent the wheel when the wireless connectivity mechanism on modern Linux systems work just fine? But of course it is pointless arguing with Android, and I adapted the patch found in <a href="http://boundarydevices.com/blogs/android-wlan-the-rest-of-the-story">this article on porting WiFi drivers for the Nitrogen-E</a> (which is a <a href="http://boundarydevices.com/NitrogenE.php">a Freescale i.MX51 / Cortex-A8 based board</a>.</p></div>
<div class="paragraph"><p>Unfortunately that was not enough either. As Android still thrashed around and refused to talk to the wireless chip, I discovered a line in my logcat output saying something like <code>ioctl[SIOCSIWPRIV] (cscan): -1</code>. Researching further lead me to <a href="http://randomshit.dreamhosters.com/TouchPad/Drivers/Wifi/AR6003Android.pdf">this PDF</a> (also archived <a href="/assets/files/nitdroid/AR6003Android.pdf">here</a>) which explained that Gingerbread added on top of Froyo <em>yet another</em> custom command over SIOCSIWPRIV, combo scan, that a driver needs to implement. In fact, Gingerbread will <em>only</em> use combo scanning to scan for APs when using WEXT. A patch for this is found <a href="https://github.com/CyanogenMod/android_external_wpa_supplicant_6/commit/cd46450b1674b462dcc278ae2f015d8449e5c158">here</a> or, less elegantly, by removing combo scanning from the WEXT driver of wpa_supplicant as in <a href="https://gitorious.org/picopc-android-gingerbread/external-wpa_supplicant_6/commit/5f5c50d722eedaedd75c1698b79f464310ce6478?format=patch">this patch</a>.</p></div>
<div class="paragraph"><p>In addition, I had to patch libhardware_legacy to use <code>wlan0</code> instead of <code>sta</code> (seriously, why is that hard-coded in?) which libhardware_legacy uses as the interface name to determine the state of the wpa_supplicant process. The patch is as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="gh">diff --git a/wifi/wifi.c b/wifi/wifi.c</span>
<span class="gh">index 3f8708d..9d9d89c 100644</span>
<span class="gd">--- a/wifi/wifi.c</span>
<span class="gi">+++ b/wifi/wifi.c</span>
<span class="gu">@@ -60,7 +60,7 @@ static char iface[PROPERTY_VALUE_MAX];</span>
 #ifndef WIFI_FIRMWARE_LOADER
 #define WIFI_FIRMWARE_LOADER           &quot;&quot;
 #endif
<span class="gd">-#define WIFI_TEST_INTERFACE            &quot;sta&quot;</span>
<span class="gi">+#define WIFI_TEST_INTERFACE            &quot;wlan0&quot;</span>

 #define WIFI_DRIVER_LOADER_DELAY       1000000
</pre></div></div></div>
<div class="paragraph"><p>Otherwise, I get errors like</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Unable to open connection to supplicant on "sta": No such file or directory</code></pre>
</div></div>
<div class="paragraph"><p>After all this effort, the device is able to scan correctly and does give a list of APs in Android GUI. From the logcat output I can see that it is also able to successfully associate with the AP:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>I/wpa_supplicant( 1205): Trying to associate with 1c:17:d3:fc:db:79 (SSID='Purple Help' freq=2412 MHz)
D/wpa_supplicant( 1205): Cancelling scan request
D/wpa_supplicant( 1205): WPA: clearing own WPA/RSN IE
D/wpa_supplicant( 1205): Automatic auth_alg selection: 0x1
D/wpa_supplicant( 1205): WPA: clearing AP WPA IE
D/wpa_supplicant( 1205): WPA: clearing AP RSN IE
D/wpa_supplicant( 1205): WPA: clearing own WPA/RSN IE
D/wpa_supplicant( 1205): No keys have been configured - skip key clearing
D/wpa_supplicant( 1205): wpa_driver_wext_set_drop_unencrypted
D/wpa_supplicant( 1205): State: SCANNING -&gt; ASSOCIATING
I/wpa_supplicant( 1205): CTRL-EVENT-STATE-CHANGE id=-1 state=3 BSSID=1c:17:d3:fc:db:79
D/wpa_supplicant( 1205): wpa_driver_wext_set_operstate: operstate 0-&gt;0 (DORMANT)
D/wpa_supplicant( 1205): WEXT: Operstate: linkmode=-1, operstate=5
D/wpa_supplicant( 1205): wpa_driver_wext_associate
D/wpa_supplicant( 1205): wpa_driver_wext_set_psk
D/wpa_supplicant( 1205): Setting authentication timeout: 10 sec 0 usec
D/wpa_supplicant( 1205): EAPOL: External notification - EAP success=0
D/wpa_supplicant( 1205): EAPOL: External notification - EAP fail=0
D/wpa_supplicant( 1205): EAPOL: External notification - portControl=ForceAuthorized
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): Wireless event: cmd=0x8b06 len=8
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): Wireless event: cmd=0x8b04 len=12
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x1003 ([UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): Wireless event: cmd=0x8b1a len=19
D/wpa_supplicant( 1205): CMD: AP_SCAN 1
D/wpa_supplicant( 1205): ap_scan = 1
V/WifiMonitor(  925): Event [Trying to associate with 1c:17:d3:fc:db:79 (SSID='Purple Help' freq=2412 MHz)]
V/WifiMonitor(  925): Event [CTRL-EVENT-STATE-CHANGE id=-1 state=3 BSSID=1c:17:d3:fc:db:79]
D/wpa_supplicant( 1205): CMD: DRIVER SCAN-PASSIVE
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd SCAN-PASSIVE len = 4096
D/wpa_supplicant( 1205): SCAN-PASSIVE not yet supported
V/WifiStateTracker(  925): Changing supplicant state: SCANNING ==&gt; ASSOCIATING
D/wpa_supplicant( 1205): CMD: STATUS
D/wpa_supplicant( 1205): CMD: DRIVER RSSI-APPROX
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd RSSI-APPROX len = 4096
D/wpa_supplicant( 1205): &gt;&gt;&gt;. DRIVER EMULATE RSSI
E/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd failed (-1): RSSI
D/wpa_supplicant( 1205): CMD: DRIVER LINKSPEED
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd LINKSPEED len = 4096
D/wpa_supplicant( 1205): Link Speed command
E/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd failed (-1): LINKSPEED
D/wpa_supplicant( 1205): EAPOL: disable timer tick
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): Wireless event: cmd=0x8c08 len=50
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=0 ifi_flags=0x11003 ([UP][LOWER_UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
D/wpa_supplicant( 1205): Wireless event: cmd=0x8b15 len=20
D/wpa_supplicant( 1205): Wireless event: new AP: 1c:17:d3:fc:db:79
D/wpa_supplicant( 1205): Association info event
D/wpa_supplicant( 1205): WPA: clearing AP WPA IE
D/wpa_supplicant( 1205): WPA: clearing AP RSN IE
D/wpa_supplicant( 1205): State: ASSOCIATING -&gt; ASSOCIATED
I/wpa_supplicant( 1205): CTRL-EVENT-STATE-CHANGE id=0 state=4 BSSID=1c:17:d3:fc:db:79
D/wpa_supplicant( 1205): wpa_driver_wext_set_operstate: operstate 0-&gt;0 (DORMANT)
D/wpa_supplicant( 1205): WEXT: Operstate: linkmode=-1, operstate=5
V/WifiMonitor(  925): Event [CTRL-EVENT-STATE-CHANGE id=0 state=4 BSSID=1c:17:d3:fc:db:79]
V/WifiStateTracker(  925): Changing supplicant state: ASSOCIATING ==&gt; ASSOCIATED
D/wpa_supplicant( 1205): Associated to a new BSS: BSSID=1c:17:d3:fc:db:79
I/wpa_supplicant( 1205): Associated with 1c:17:d3:fc:db:79
D/wpa_supplicant( 1205): WPA: Association event - clear replay counter
D/wpa_supplicant( 1205): WPA: Clear old PTK
D/wpa_supplicant( 1205): EAPOL: External notification - portEnabled=0
D/wpa_supplicant( 1205): EAPOL: External notification - portValid=0
D/wpa_supplicant( 1205): EAPOL: External notification - portEnabled=1
D/wpa_supplicant( 1205): EAPOL: SUPP_PAE entering state S_FORCE_AUTH
D/wpa_supplicant( 1205): EAPOL: SUPP_BE entering state IDLE
D/wpa_supplicant( 1205): Cancelling authentication timeout
D/wpa_supplicant( 1205): State: ASSOCIATED -&gt; COMPLETED
I/wpa_supplicant( 1205): CTRL-EVENT-STATE-CHANGE id=0 state=7 BSSID=00:00:00:00:00:00
I/wpa_supplicant( 1205): CTRL-EVENT-CONNECTED - Connection to 1c:17:d3:fc:db:79 completed (auth) [id=0 id_str=]
D/wpa_supplicant( 1205): wpa_driver_wext_set_operstate: operstate 0-&gt;1 (UP)
D/wpa_supplicant( 1205): WEXT: Operstate: linkmode=-1, operstate=6
D/wpa_supplicant( 1205): Cancelling scan request
D/wpa_supplicant( 1205): RTM_NEWLINK: operstate=1 ifi_flags=0x11043 ([UP][RUNNING][LOWER_UP])
D/wpa_supplicant( 1205): RTM_NEWLINK, IFLA_IFNAME: Interface 'wlan0' added
V/WifiMonitor(  925): Event [Associated with 1c:17:d3:fc:db:79]
V/WifiMonitor(  925): Event [CTRL-EVENT-STATE-CHANGE id=0 state=7 BSSID=00:00:00:00:00:00]
V/WifiMonitor(  925): Event [CTRL-EVENT-CONNECTED - Connection to 1c:17:d3:fc:db:79 completed (auth) [id=0 id_str=]]
V/WifiStateTracker(  925): Changing supplicant state: ASSOCIATED ==&gt; COMPLETED
V/WifiStateTracker(  925): New network state is CONNECTED
D/wpa_supplicant( 1205): CMD: STATUS
D/wpa_supplicant( 1205): CMD: STATUS
D/wpa_supplicant( 1205): CMD: DRIVER RSSI-APPROX
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd RSSI-APPROX len = 4096
D/wpa_supplicant( 1205): &gt;&gt;&gt;. DRIVER EMULATE RSSI
D/wpa_supplicant( 1205): CMD: DRIVER LINKSPEED
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd LINKSPEED len = 4096
D/wpa_supplicant( 1205): Link Speed command
D/wpa_supplicant( 1205): CMD: DRIVER BTCOEXMODE 1
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd BTCOEXMODE 1 len = 4096
D/wpa_supplicant( 1205): BTCOEXMODE not yet supported
D/wpa_supplicant( 1205): CMD: DRIVER GETPOWER
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd GETPOWER len = 4096
D/wpa_supplicant( 1205): GETPOWER not yet supported
D/wpa_supplicant( 1205): CMD: DRIVER POWERMODE 1
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd POWERMODE 1 len = 4096
D/wpa_supplicant( 1205): POWERMODE not yet supported
D/WifiStateTracker(  925): DHCP request started</code></pre>
</div></div>
<div class="paragraph"><p>However, DHCP appears not to function and Android unloads the driver and reloads it only to restart the scan &#8594; associate &#8594; DHCP query cycle. The error message is</p></div>
<div class="listingblock">
<div class="content">
<pre><code>E/WifiStateTracker(  925): DHCP request failed: Timed out waiting for dhcpcd to start
D/wpa_supplicant( 1205): CMD: DRIVER POWERMODE 0
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd POWERMODE 0 len = 4096
D/wpa_supplicant( 1205): POWERMODE not yet supported
D/wpa_supplicant( 1205): CMD: DRIVER BTCOEXMODE 2
D/wpa_supplicant( 1205): wpa_driver_priv_driver_cmd BTCOEXMODE 2 len = 4096
D/wpa_supplicant( 1205): BTCOEXMODE not yet supported
D/wpa_supplicant( 1205): CMD: DISCONNECT
D/wpa_supplicant( 1205): wpa_driver_wext_disassociate
D/wpa_supplicant( 1205): No keys have been configured - skip key clearing
D/wpa_supplicant( 1205): State: COMPLETED -&gt; DISCONNECTED
I/wpa_supplicant( 1205): CTRL-EVENT-STATE-CHANGE id=0 state=8 BSSID=00:00:00:00:00:00
D/wpa_supplicant( 1205): wpa_driver_wext_set_operstate: operstate 1-&gt;0 (DORMANT)
D/wpa_supplicant( 1205): WEXT: Operstate: linkmode=-1, operstate=5
D/wpa_supplicant( 1205): EAPOL: External notification - portEnabled=0
D/wpa_supplicant( 1205): EAPOL: SUPP_PAE entering state DISCONNECTED</code></pre>
</div></div>
<div class="paragraph"><p>Given that it is 7AM, that I have class and homework due, and that I have been working on this for the past 10 hours I will have to figure this out next time&#8230;</p></div>
<div class="paragraph"><p>My full patch for wpa_supplicant 0.6.x, as found in the <code>external/wpa_supplicant_6</code> directory in the Android source tree, is as follows:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="gh">diff --git a/wpa_supplicant/Android.mk b/wpa_supplicant/Android.mk</span>
<span class="gh">index d3ab3dd..eb23985 100644</span>
<span class="gd">--- a/wpa_supplicant/Android.mk</span>
<span class="gi">+++ b/wpa_supplicant/Android.mk</span>
<span class="gu">@@ -32,6 +32,11 @@ ifeq ($(TARGET_ARCH),arm)</span>
 L_CFLAGS += -mabi=aapcs-linux
 endif

<span class="gi">+# Disable combo scan</span>
<span class="gi">+ifeq ($(BOARD_WEXT_NO_COMBO_SCAN),true)</span>
<span class="gi">+L_CFLAGS += -DWEXT_NO_COMBO_SCAN</span>
<span class="gi">+endif</span>
<span class="gi">+</span>
 # To ignore possible wrong network configurations
 L_CFLAGS += -DWPA_IGNORE_CONFIG_ERRORS

<span class="gh">diff --git a/wpa_supplicant/src/drivers/driver_wext.c b/wpa_supplicant/src/drivers/driver_wext.c</span>
<span class="gh">index bc5efff..36f28b5 100644</span>
<span class="gd">--- a/wpa_supplicant/src/drivers/driver_wext.c</span>
<span class="gi">+++ b/wpa_supplicant/src/drivers/driver_wext.c</span>
<span class="gu">@@ -253,7 +253,8 @@ int wpa_driver_wext_set_ssid(void *priv, const u8 *ssid, size_t ssid_len)</span>
                if (ssid_len)
                        ssid_len++;
        }
<span class="gd">-       iwr.u.essid.length = ssid_len;</span>
<span class="gi">+       drv-&gt;ssid_len = iwr.u.essid.length = ssid_len;</span>
<span class="gi">+        os_strlcpy(drv-&gt;ssid, buf, sizeof(drv-&gt;ssid));</span>

        if (ioctl(drv-&gt;ioctl_sock, SIOCSIWESSID, &amp;iwr) &lt; 0) {
                wpa_printf(MSG_ERROR, &quot;ioctl[SIOCSIWESSID]&quot;);
<span class="gu">@@ -969,6 +970,8 @@ void * wpa_driver_wext_init(void *ctx, const char *ifname)</span>
        drv-&gt;errors = 0;
        drv-&gt;driver_is_started = TRUE;
        drv-&gt;skip_disconnect = 0;
<span class="gi">+        drv-&gt;ssid_len = 0;</span>
<span class="gi">+        os_memset(drv-&gt;ssid, 0, sizeof(drv-&gt;ssid));</span>
 #endif
        wpa_driver_wext_finish_drv_init(drv);

<span class="gu">@@ -2559,12 +2562,207 @@ static int wpa_driver_priv_driver_cmd( void *priv, char *cmd, char *buf, size_t</span>
        ret = ioctl(drv-&gt;ioctl_sock, SIOCSIWPRIV, &amp;iwr);

        if (ret &lt; 0) {
<span class="gi">+#ifdef ANDROID</span>
<span class="gi">+            if (os_strcasecmp(cmd, &quot;RSSI&quot;) == 0) {</span>
<span class="gi">+                struct iwreq wrq;</span>
<span class="gi">+                struct iw_statistics stats;</span>
<span class="gi">+                signed int rssi;</span>
<span class="gi">+                wpa_printf(MSG_DEBUG, &quot;&gt;&gt;&gt;. DRIVER EMULATE RSSI &quot;);</span>
<span class="gi">+                wrq.u.data.pointer = (caddr_t) &amp;stats;</span>
<span class="gi">+                wrq.u.data.length = sizeof(stats);</span>
<span class="gi">+                /* Clear updated flag */</span>
<span class="gi">+                wrq.u.data.flags = 1;</span>
<span class="gi">+                strncpy(wrq.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+</span>
<span class="gi">+                if (ioctl(drv-&gt;ioctl_sock, SIOCGIWSTATS, &amp;wrq) &lt; 0) {</span>
<span class="gi">+                    perror(&quot;ioctl[SIOCGIWSTATS]&quot;);</span>
<span class="gi">+                    ret = -1;</span>
<span class="gi">+                } else {</span>
<span class="gi">+                    if (stats.qual.updated &amp; IW_QUAL_DBM) {</span>
<span class="gi">+                        /* Values in dBm, stored in u8 with range 63 : -192 */</span>
<span class="gi">+                        rssi = ( stats.qual.level &gt; 63 ) ?</span>
<span class="gi">+                            stats.qual.level - 0x100 :</span>
<span class="gi">+                            stats.qual.level;</span>
<span class="gi">+                    } else</span>
<span class="gi">+                        rssi = stats.qual.level;</span>
<span class="gi">+</span>
<span class="gi">+                    if (drv-&gt;ssid_len != 0 &amp;&amp;</span>
<span class="gi">+                        drv-&gt;ssid_len &lt; buf_len) {</span>
<span class="gi">+                        os_memcpy((void *) buf, (void *)</span>
<span class="gi">+                              (drv-&gt;ssid), drv-&gt;ssid_len);</span>
<span class="gi">+                        ret = drv-&gt;ssid_len;</span>
<span class="gi">+                        ret += snprintf(&amp;buf[ret], buf_len-ret,</span>
<span class="gi">+                                &quot; rssi %dn&quot;, rssi);</span>
<span class="gi">+                        if (ret &lt; (int)buf_len)</span>
<span class="gi">+                            return ret;</span>
<span class="gi">+                        ret = -1;</span>
<span class="gi">+                    }</span>
<span class="gi">+                }</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;START&quot;, 5) == 0) {</span>
<span class="gi">+                os_sleep(0, WPA_DRIVER_WEXT_WAIT_US);</span>
<span class="gi">+                wpa_msg(drv-&gt;ctx, MSG_INFO, WPA_EVENT_DRIVER_STATE &quot;STARTED&quot;);</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;STOP&quot;, 4) == 0) {</span>
<span class="gi">+                wpa_msg(drv-&gt;ctx, MSG_INFO, WPA_EVENT_DRIVER_STATE &quot;STOPPED&quot;);</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;LINKSPEED&quot;, 9) == 0) {</span>
<span class="gi">+                struct iwreq wrq;</span>
<span class="gi">+                unsigned int linkspeed;</span>
<span class="gi">+                os_strncpy(wrq.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;Link Speed command&quot;);</span>
<span class="gi">+                if (ioctl(drv-&gt;ioctl_sock, SIOCGIWRATE, &amp;wrq) &lt; 0) {</span>
<span class="gi">+                    perror(&quot;ioctl[SIOCGIWRATE]&quot;);</span>
<span class="gi">+                    ret = -1;</span>
<span class="gi">+                } else {</span>
<span class="gi">+                    linkspeed = wrq.u.bitrate.value / 1000000;</span>
<span class="gi">+                    ret = snprintf(buf, buf_len, &quot;LinkSpeed %dn&quot;,</span>
<span class="gi">+                            linkspeed);</span>
<span class="gi">+                }</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;SNR&quot;, 3) == 0) {</span>
<span class="gi">+                struct iwreq wrq;</span>
<span class="gi">+                struct iw_statistics stats;</span>
<span class="gi">+                int snr, rssi, noise;</span>
<span class="gi">+</span>
<span class="gi">+                wrq.u.data.pointer = (caddr_t) &amp;stats;</span>
<span class="gi">+                wrq.u.data.length = sizeof(stats);</span>
<span class="gi">+                wrq.u.data.flags = 1; /* Clear updated flag */</span>
<span class="gi">+                strncpy(wrq.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+</span>
<span class="gi">+                if (ioctl(drv-&gt;ioctl_sock, SIOCGIWSTATS, &amp;wrq) &lt; 0) {</span>
<span class="gi">+                    perror(&quot;ioctl[SIOCGIWSTATS]&quot;);</span>
<span class="gi">+                    ret = -1;</span>
<span class="gi">+                } else {</span>
<span class="gi">+                    if (stats.qual.updated &amp; IW_QUAL_DBM) {</span>
<span class="gi">+                        /* Values in dBm, stored in u8 with</span>
<span class="gi">+                         * range 63 : -192 */</span>
<span class="gi">+                        rssi = ( stats.qual.level &gt; 63 ) ?</span>
<span class="gi">+                            stats.qual.level - 0x100 :</span>
<span class="gi">+                            stats.qual.level;</span>
<span class="gi">+                        noise = ( stats.qual.noise &gt; 63 ) ?</span>
<span class="gi">+                            stats.qual.noise - 0x100 :</span>
<span class="gi">+                            stats.qual.noise;</span>
<span class="gi">+                    } else {</span>
<span class="gi">+                        rssi = stats.qual.level;</span>
<span class="gi">+                        noise = stats.qual.noise;</span>
<span class="gi">+                    }</span>
<span class="gi">+</span>
<span class="gi">+                    snr = rssi - noise;</span>
<span class="gi">+</span>
<span class="gi">+                    ret = snprintf(buf, buf_len, &quot;snr = %un&quot;,</span>
<span class="gi">+                            (unsigned int)snr);</span>
<span class="gi">+                    if (ret &lt; (int)buf_len)</span>
<span class="gi">+                        return ret;</span>
<span class="gi">+                }</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;SET-RTS-THRESHOLD&quot;, 17) == 0) {</span>
<span class="gi">+                struct iwreq wrq;</span>
<span class="gi">+                unsigned int rtsThreshold;</span>
<span class="gi">+                char *cp = cmd + 17;</span>
<span class="gi">+                char *endp;</span>
<span class="gi">+</span>
<span class="gi">+                strncpy(wrq.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+</span>
<span class="gi">+                if (*cp != &#39;\0&#39;) {</span>
<span class="gi">+                    rtsThreshold = (unsigned int)strtol(cp, &amp;endp, 0);</span>
<span class="gi">+                    if (endp != cp) {</span>
<span class="gi">+                        wrq.u.rts.value = rtsThreshold;</span>
<span class="gi">+                        wrq.u.rts.fixed = 1;</span>
<span class="gi">+                        wrq.u.rts.disabled = 0;</span>
<span class="gi">+</span>
<span class="gi">+                        if (ioctl(drv-&gt;ioctl_sock, SIOCSIWRTS,</span>
<span class="gi">+                              &amp;wrq) &lt; 0) {</span>
<span class="gi">+                            perror(&quot;ioctl[SIOCGIWRTS]&quot;);</span>
<span class="gi">+                            ret = -1;</span>
<span class="gi">+                        } else {</span>
<span class="gi">+                            rtsThreshold = wrq.u.rts.value;</span>
<span class="gi">+                            wpa_printf(MSG_DEBUG,&quot;Set RTS Threshold command = %d&quot;, rtsThreshold);</span>
<span class="gi">+                            ret = 0;</span>
<span class="gi">+                        }</span>
<span class="gi">+                    }</span>
<span class="gi">+                }</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;GET-RTS-THRESHOLD&quot;, 17) == 0) {</span>
<span class="gi">+                struct iwreq wrq;</span>
<span class="gi">+                unsigned int rtsThreshold;</span>
<span class="gi">+</span>
<span class="gi">+                strncpy(wrq.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+</span>
<span class="gi">+                if (ioctl(drv-&gt;ioctl_sock, SIOCGIWRTS, &amp;wrq) &lt; 0) {</span>
<span class="gi">+                    perror(&quot;ioctl[SIOCGIWRTS]&quot;);</span>
<span class="gi">+                    ret = -1;</span>
<span class="gi">+                } else {</span>
<span class="gi">+                    rtsThreshold = wrq.u.rts.value;</span>
<span class="gi">+                    wpa_printf(MSG_DEBUG,&quot;Get RTS Threshold command = %d&quot;,</span>
<span class="gi">+                           rtsThreshold);</span>
<span class="gi">+                    ret = snprintf(buf, buf_len, &quot;rts-threshold = %un&quot;,</span>
<span class="gi">+                            rtsThreshold);</span>
<span class="gi">+                    if (ret &lt; (int)buf_len)</span>
<span class="gi">+                        return ret;</span>
<span class="gi">+                }</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;SCAN-ACTIVE&quot;, 11) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;SCAN-ACTIVE not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;SCAN-PASSIVE&quot;, 12) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;SCAN-PASSIVE not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;SCAN-CHANNELS&quot;, 13) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;SCAN-CHANNELS not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;BTCOEXSCAN-START&quot;, 16) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;BTCOEXSCAN-START not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;BTCOEXSCAN-STOP&quot;, 15) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;BTCOEXSCAN-STOP not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;RXFILTER-START&quot;, 14) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;RXFILTER-START not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;RXFILTER-STOP&quot;, 13) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;RXFILTER-STOP not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;RXFILTER-STATISTICS&quot;, 19) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;RXFILTER-STATISTICS not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;RXFILTER-ADD&quot;, 12) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;RXFILTER-ADD not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;RXFILTER-REMOVE&quot;, 15) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;RXFILTER-REMOVE not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;BTCOEXMODE&quot;, 10) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;BTCOEXMODE not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;BTCOEXSTAT&quot;, 10) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;BTCOEXSTAT not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;POWERMODE&quot;, 9) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;POWERMODE not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;GETPOWER&quot;, 8 ) == 0) {</span>
<span class="gi">+                wpa_printf(MSG_DEBUG,&quot;GETPOWER not yet supportedn&quot;);</span>
<span class="gi">+                ret = 0 ;</span>
<span class="gi">+            } else if (os_strncasecmp(cmd, &quot;MACADDR&quot;, 7) == 0) {</span>
<span class="gi">+                /* MACADDR */</span>
<span class="gi">+                struct ifreq ifr;</span>
<span class="gi">+                os_memset(&amp;ifr, 0, sizeof(ifr));</span>
<span class="gi">+                os_strncpy(ifr.ifr_name, drv-&gt;ifname, IFNAMSIZ);</span>
<span class="gi">+</span>
<span class="gi">+                if (ioctl(drv-&gt;ioctl_sock, SIOCGIFHWADDR, &amp;ifr) &lt; 0) {</span>
<span class="gi">+                    perror(&quot;ioctl[SIOCGIFHWADDR]&quot;);</span>
<span class="gi">+                    ret = -1;</span>
<span class="gi">+                } else {</span>
<span class="gi">+                    u8 *macaddr = (u8 *) ifr.ifr_hwaddr.sa_data;</span>
<span class="gi">+                    ret = snprintf(buf, buf_len, &quot;Macaddr = &quot; MACSTR &quot;n&quot;,</span>
<span class="gi">+                            MAC2STR(macaddr));</span>
<span class="gi">+                }</span>
<span class="gi">+            }</span>
<span class="gi">+            if (ret &lt; 0) {</span>
<span class="gi">+#endif</span>
                wpa_printf(MSG_ERROR, &quot;%s failed (%d): %s&quot;, __func__, ret, cmd);
                drv-&gt;errors++;
                if (drv-&gt;errors &gt; WEXT_NUMBER_SEQUENTIAL_ERRORS) {
                        drv-&gt;errors = 0;
                        wpa_msg(drv-&gt;ctx, MSG_INFO, WPA_EVENT_DRIVER_STATE &quot;HANGED&quot;);
                }
<span class="gi">+#ifdef ANDROID</span>
<span class="gi">+            }</span>
<span class="gi">+#endif</span>
        } else {
                drv-&gt;errors = 0;
                ret = 0;
<span class="gh">diff --git a/wpa_supplicant/src/drivers/driver_wext.h b/wpa_supplicant/src/drivers/driver_wext.h</span>
<span class="gh">index 29ef44b..a7cde94 100644</span>
<span class="gd">--- a/wpa_supplicant/src/drivers/driver_wext.h</span>
<span class="gi">+++ b/wpa_supplicant/src/drivers/driver_wext.h</span>
<span class="gu">@@ -47,6 +47,9 @@ struct wpa_driver_wext_data {</span>
        int errors;
        int driver_is_started;
        int skip_disconnect;
<span class="gi">+        /* SIOCSIWPRIV support in WEXT for non-Android WiFi drivers. */</span>
<span class="gi">+        char ssid[33];</span>
<span class="gi">+        unsigned int ssid_len;</span>
 #endif
 };

<span class="gh">diff --git a/wpa_supplicant/wpa_supplicant.c b/wpa_supplicant/wpa_supplicant.c</span>
<span class="gh">index beec16e..ed40642 100644</span>
<span class="gd">--- a/wpa_supplicant/wpa_supplicant.c</span>
<span class="gi">+++ b/wpa_supplicant/wpa_supplicant.c</span>
<span class="gu">@@ -1490,6 +1490,9 @@ int wpa_drv_scan(struct wpa_supplicant *wpa_s, struct wpa_ssid **ssid_ptr)</span>
        size_t ssid_len = 0;
        int ret = -1;

<span class="gi">+#ifdef WEXT_NO_COMBO_SCAN</span>
<span class="gi">+       if (wpa_s-&gt;driver-&gt;scan) {</span>
<span class="gi">+#else</span>
        if (wpa_s-&gt;driver-&gt;combo_scan) {
                ret = wpa_s-&gt;driver-&gt;combo_scan(wpa_s-&gt;drv_priv, ssid_ptr,
                                                wpa_s-&gt;conf-&gt;ssid);
<span class="gu">@@ -1499,6 +1502,7 @@ int wpa_drv_scan(struct wpa_supplicant *wpa_s, struct wpa_ssid **ssid_ptr)</span>
                }
        }
        else if (wpa_s-&gt;driver-&gt;scan) {
<span class="gi">+#endif</span>
                if (*ssid_ptr) {
                        ssid_nm = (*ssid_ptr)-&gt;ssid;
                        ssid_len = (*ssid_ptr)-&gt;ssid_len;
</pre></div></div></div>
<div class="paragraph"><p>Credit goes to Michael Trimarchi as the changes are totally adapted from <a href="https://gitorious.org/flow-g1-5/platform_external_wpa_supplicant/commit/0079ce31faa15d882272891661493ce734e5ab3e">his patch</a>.</p></div>
<div class="paragraph"><p>I have added a repository for userland patches which can be accessed <a href="https://gitorious.org/nitdroid/ul_patches">here</a>.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 25, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vi.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-vi.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/nitdroid-userland-update-v.html" rel="bookmark">
      NITDroid userland update V
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-24T02:12:24-07:00">
          Oct 24, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/nitdroid-userland-update-v.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>In short - I compiled Gingerbread (2.3.7_r1) without modification and it boots on the N810 out of the box. That was SO much easier than with Froyo&#8230;</p></div>
<div class="paragraph"><div class="title">Gingerbread (2.3.7 r1) on the Nokia N810:</div><p><span class="image">
<a class="image" href="/assets/files/nitdroid/nitdroid_20111024.jpg">
<img src="/assets/files/nitdroid/nitdroid_20111024_small.jpg" alt="Gingerbread (2.3.7 r1) on the Nokia N810" width="300" />
</a>
</span></p></div>
<div class="paragraph"><p>I uploaded my device configuration files for Android to <a href="https://gitorious.org/nitdroid/device">this Git repository</a>. To build, the files should be kept in a folder with any name, say <code>nitdroid_device</code>, under <code>$ANDROID_SOURCE/device</code>. To build, run <code>make PRODUCT-nitdroid-eng</code> or a variant from the root of the source tree.</p></div>
<div class="paragraph"><p>I also calibrated the TSC2005 touchscreen. The code I pulled off <a href="http://groups.google.com/group/android-internals/msg/7c6ff76e0381e95a">this thread</a> back in May resulted in weird coordinates on my touchscreen since when I was running Froyo, and I took the time to correct the numeric values by trial and error on my touchscreen. The final diff from the <code>tsc2005.c</code> created by the OpenWRT patches is:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="gd">--- a/drivers/input/touchscreen/tsc2005.c</span>
<span class="gi">+++ b/drivers/input/touchscreen/tsc2005.c</span>
<span class="gu">@@ -304,8 +304,8 @@ static void tsc2005_ts_update_pen_state(struct tsc2005 *ts,</span>
                                        int x, int y, int pressure)
 {
        if (pressure) {
<span class="gi">+                x = abs((x - 260) * 800 / 3550);</span>
<span class="gi">+                y = abs((3600 - y) * 480 / 3750);</span>
                input_report_abs(ts-&gt;idev, ABS_X, x);
                input_report_abs(ts-&gt;idev, ABS_Y, y);
                input_report_abs(ts-&gt;idev, ABS_PRESSURE, pressure);
</pre></div></div></div>
<div class="paragraph"><p>I have committed it to <a href="https://gitorious.org/nitdroid/kernel_patches">my kernel patches repository</a>.</p></div>
<div class="paragraph"><p>There are still a million issues though&#8230;sound and wireless don&#8217;t work yet, and most importantly the system panics after about a minute of inaction, complaining (untruthfully) that the SD card had been removed. But it&#8217;s a start.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 24, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-v.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/nitdroid-userland-update-v.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="http://seasonofcode.com/index3.html">&larr; Previous</a></li>
    <li class="next"><a href="http://seasonofcode.com/index5.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="http://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="http://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>