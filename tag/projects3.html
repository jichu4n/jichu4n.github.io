<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Projects</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?918c51a9" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/piwik.php?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-userland-update-iii.html" rel="bookmark">
      NITDroid userland update III
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-09T04:14:09-07:00">
          May 09, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iii.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I figured out the touchscreen today. I started off with
<a href="http://groups.google.com/group/android-internals/msg/7c6ff76e0381e95a">this
thread</a> from almost exactly 3 years ago. It turns out that most of the suggested
kernel patch is unnecessary; for some unknown reason, the patch tries to merge
the keyboard input device and the touchscreen input device into one single
device in <code>/dev/input/</code>. Based on this understanding of the patch, I
hypothesized that the reason Android was ignoring my touchscreen events while
perfectly responding to my keyboard events was that it expected only one
composite input device from the kernel, and was only polling on the keyboard
device instead of the touchscreen device. So I commented out the calls to
<code>input_register_device(&#8230;)</code> in both <code>drivers/input/keyboard/lm8323.c</code> and
<code>drivers/cbus/retu-pwrbutton.c</code> and tried again; still no good.</p></div>
<div class="paragraph"><p>I knew the touchscreen driver was definitely sending events to
<code>/dev/input/event0</code> because I had inserted <code>printk</code> calls in the driver and
could see the appropriate events being generated. The problem thus lay with the
Android userland. Based on
<a href="http://groups.google.com/group/android-porting/browse_thread/thread/67f903dae875d3b4/b6d1ec3e845a5021">this thread</a>,
I next sprinkled <code>frameworks/base/services/java/KeyInputQueue.java</code> and
<code>frameworks/base/services/WindowManagerService.java</code> with <code>Slog</code> calls. After a
number of painfully slow [ change source code &#8594; recompile &#8594; copy to microSD
card &#8594; unmount microSD card &#8594; remove microSD card from SD card adapter &#8594;
insert microSD card into miniSD card adapter &#8594; insert microSD card into the
N810 &#8594; boot up the N810 &#8594; write on the touchscreen &#8594; open up back cover &#8594;
take out battery &#8594; reattach battery &#8594; reattach back cover &#8594; remove microSD
card from miniSD card adapter &#8594; insert microSD card into SD card adapter &#8594;
insert SD card into computer &#8594; mount microSD card &#8594; repair file system on
microSD card &#8594; checkout log ] cycles, it turns out that the input event handler
thread (<code>KeyInputQueue.mThread</code>) was getting all the events and was passing them
to <code>WindowManagerService.preprocessEvent()</code>, which, unfortunately, told it to
throw them away because our good friend the <code>PowerManagerService</code> believes <em>the
screen was off</em>. So for now I made <code>PowerManagerService.isScreenOn()</code> in
<code>frameworks/base/services/PowerManagerService.java</code> to just return true, and the
touchscreen started working.</p></div>
<div class="paragraph"><p>So the conclusion is that of the changes in the patch suggested in the
<a href="http://groups.google.com/group/android-internals/msg/7c6ff76e0381e95a">above thread</a>,
only those recalculating the <code>x</code> and <code>y</code> values in the function
<code>tsc2005_ts_update_pen_state(&#8230;)</code> and the lines setting <code>x_max</code> and <code>y_max</code> to
800 and 480 respectively in <code>tsc2005_ts_init(&#8230;)</code> are necessary. Both changes
are in <code>drivers/input/touchscreen/tsc2005.c</code>. All the other suggested changes
are irrelevant and should be disregarded. In the Android userland code,
<code>PowerManagerService</code> needs to be figured out.</p></div>
<div class="paragraph"><p>And here&#8217;s a short video I put on YouTube showing my Froyo build booting up and
responding to the touchscreen:</p></div>
<div align="center">
  <iframe width="480" height="390"
          src="http://www.youtube.com/embed/1NDW4IrBwmI"
          frameborder="0"
          allowfullscreen></iframe>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 09, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iii.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iii.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-userland-update-ii-first-bootable-froyo-image.html" rel="bookmark">
      NITDroid userland update II - FIRST BOOTABLE FROYO IMAGE!!!!
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-08T04:35:59-07:00">
          May 08, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-userland-update-ii-first-bootable-froyo-image.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I was able to make huge progress with NITDroid today. After installing a Debian
chroot as my new development environment (schroot and debootstrap from Arch
repos; see <a href="https://help.ubuntu.com/community/BasicChroot">here</a>) and
grabbing the newest version of Froyo, version 2.2.2_r1, I started again where I
left off three months ago - with a bootable kernel and a userland that boots to
a blank black screen after the startup animation. I was convinced the problem
lay with the framebuffer driver and I spent many hours learning about
framebuffer drivers and investigating the omap_fb driver. I sprinkled the driver
with <code>printk</code> statements, but could find nothing wrong at all. I had previous
suspected that the driver was unable to allocate a virtual buffer twice the size
of the actual resolution, but this was not the case.</p></div>
<div class="paragraph"><p>Then I had the (long overdue) idea of adding a service to <code>init.rc</code> that saved
Android logs to a file on the SD card:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>service logcat /system/bin/logcat -f /data/all.log
    oneshot</code></pre>
</div></div>
<div class="paragraph"><p>And indeed, the video driver was fine (of course, after the patch found on
<a href="http://elinux.org/Android_on_OMAP#Page_flipping_frame_buffer">this great page</a>
on eLinux.org). The <em>real</em> problem, however, was this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>E/BatteryService(  754): Could not open /sys/class/power_supply</code></pre>
</div></div>
<div class="paragraph"><p>And, accordingly, somewhere later:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>I/SystemServer(  754): Battery Service
W/dalvikvm(  754): No implementation found for native Lcom/android/server/BatteryService;.native_update ()V
W/dalvikvm(  754): threadid=7: thread exiting with uncaught exception (group=0x400207f0)
E/AndroidRuntime(  754): *** FATAL EXCEPTION IN SYSTEM PROCESS: android.server.ServerThread
E/AndroidRuntime(  754): java.lang.UnsatisfiedLinkError: native_update
E/AndroidRuntime(  754):        at com.android.server.BatteryService.native_update(Native Method)
E/AndroidRuntime(  754):        at com.android.server.BatteryService.update(BatteryService.java:208)
E/AndroidRuntime(  754):        at com.android.server.BatteryService.&lt;init&gt;(BatteryService.java:134)
E/AndroidRuntime(  754):        at com.android.server.ServerThread.run(SystemServer.java:146)
E/AndroidRuntime(  754): Error reporting crash
E/AndroidRuntime(  754): java.lang.NullPointerException
E/AndroidRuntime(  754):        at android.os.DropBoxManager.isTagEnabled(DropBoxManager.java:262)
E/AndroidRuntime(  754):        at com.android.server.am.ActivityManagerService.addErrorToDropBox(ActivityManagerService.java:9190)
E/AndroidRuntime(  754):        at com.android.server.am.ActivityManagerService.handleApplicationCrash(ActivityManagerService.java:9101)
E/AndroidRuntime(  754):        at com.android.internal.os.RuntimeInit$UncaughtHandler.uncaughtException(RuntimeInit.java:76)
E/AndroidRuntime(  754):        at java.lang.ThreadGroup.uncaughtException(ThreadGroup.java:887)
E/AndroidRuntime(  754):        at java.lang.ThreadGroup.uncaughtException(ThreadGroup.java:884)
I/Process (  754): Sending signal. PID: 754 SIG: 9
I/ServiceManager(  670): service 'SurfaceFlinger' died
I/ServiceManager(  670): service 'usagestats' died
I/ServiceManager(  670): service 'entropy' died
I/ServiceManager(  670): service 'batteryinfo' died
I/ServiceManager(  670): service 'power' died
I/ServiceManager(  670): service 'package' died
I/ServiceManager(  670): service 'activity' died
I/ServiceManager(  670): service 'meminfo' died
I/ServiceManager(  670): service 'cpuinfo' died
I/ServiceManager(  670): service 'permission' died
I/ServiceManager(  670): service 'account' died
I/ServiceManager(  670): service 'content' died
I/ServiceManager(  670): service 'telephony.registry' died
E/installd(  678): eof
E/installd(  678): failed to read size
I/installd(  678): closing connection
I/Zygote  (  749): Exit zygote because system server (754) has terminated
I/ServiceManager(  670): service 'media.audio_flinger' died
I/ServiceManager(  670): service 'media.player' died
I/ServiceManager(  670): service 'media.camera' died
I/ServiceManager(  670): service 'media.audio_policy' died</code></pre>
</div></div>
<div class="paragraph"><p>This sequence was repeated ad infinitum, as my <code>init.rc</code> read:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>service servicemanager /system/bin/servicemanager
    user system
    critical
    onrestart restart zygote
    onrestart restart media</code></pre>
</div></div>
<div class="paragraph"><p>It turns out that this is a common problem that has happened to many people
porting Android to a new platform, as explained on
<a href="http://groups.google.com/group/android-porting/browse_thread/thread/521b64a279388cee/ddc2a537ada2c5b9">this thread</a>,
<a href="http://groups.google.com/group/android-porting/browse_thread/thread/abc0633915c8b047#">this thread</a>, and
<a href="http://dev.omapzoom.org/?p=aboateng/omap3-linux-cam.git;a=commitdiff;h=eaff38c66985603eb4b53ceb25f6e837f0937efb">this thread</a>.
The culprit is the C++ native implementation of the class <code>BatteryService</code>,
found in <code>frameworks/base/services/jni/com_android_server_BatteryService.cpp</code>.
In <code>register_android_server_BatteryService(JNIEnv* env)</code> (line 229), we find the
following code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>    <span class="p">...</span>
<span class="kt">DIR</span><span class="o">*</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">POWER_SUPPLY_PATH</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">dir</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOGE</span><span class="p">(</span><span class="s">&quot;Could not open %sn&quot;</span><span class="p">,</span> <span class="n">POWER_SUPPLY_PATH</span><span class="p">);</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
    <span class="p">...</span>
</pre></div></div></div>
<div class="paragraph"><p>where <code>POWER_SUPPLY_PATH</code> is <code>#define</code>'d as <code>/sys/class/power_supply</code> on line
42. This corresponds, of course, to our first error message above. The totally
stupid thing is the fact that this occurs in
<code>register_android_server_BatteryService(JNIEnv *env)</code>, which is supposed to
register a native C++ method <code>native_update()</code> defined in this file with the
Java VM as part of the Java class <code>com.android.server.BatteryService</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">static</span> <span class="kt">void</span> <span class="nf">android_server_BatteryService_update</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">obj</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">JNINativeMethod</span> <span class="n">sMethods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="cm">/* name, signature, funcPtr */</span>
    <span class="p">{</span><span class="s">&quot;native_update&quot;</span><span class="p">,</span> <span class="s">&quot;()V&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">android_server_BatteryService_update</span><span class="p">},</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In <code>framework/base/services/java/com/android/server/BatteryService.java</code>, we have:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">class</span> <span class="nc">BatteryService</span> <span class="kd">extends</span> <span class="n">Binder</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="kd">private</span> <span class="kd">native</span> <span class="kt">void</span> <span class="nf">native_update</span><span class="o">();</span>

    <span class="kd">private</span> <span class="kd">synchronized</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
         <span class="n">native_update</span><span class="o">();</span>
         <span class="o">...</span>
    <span class="o">}</span>

    <span class="o">...</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In other words, what is going on is this. The service manager thread starts the
battery service; the JVM then loads the corresponding native C++ code. But since
my hacked kernel doesn&#8217;t currently support battery / power supply information
(and therefore does not create the directory <code>/sys/class/power_supply</code> at all),
the native code refuses to load, which causes the JVM to panic. Unfortunately
this leads to the service manager being restarted itself; the same then happens
again and again.</p></div>
<div class="paragraph"><p>There are several natural solutions: 1) add proper power supply drivers for the
N810 to the kernel, 2) add a dummy power supply 3) change the Java
BatteryService class so that it does not call the native update method but uses
dummy values, and 4) make the C++ code not check the actual battery status, but
return empty values. Solution #1 is the way to go in the long run, of course;
but right now I just want to get something rolling. This
<a href="http://hi.baidu.com/aokikyon/blog/item/35ea0c12f8e7475bf919b8c1.html">Chinese blog</a>
implemented solution #2. I chose solution 3, however, following
<a href="http://blog.163.com/fhtx_2008/blog/static/7285544201012641765/">this other Chinese blog</a>.
My updated <code>BatteryService.java</code> reads:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c1">// NITDROID: Native update disabled.</span>
<span class="c1">// private native void native_update();</span>

<span class="c1">// NITDROID: Dummy battery</span>
<span class="kd">private</span> <span class="kd">synchronized</span> <span class="kd">final</span> <span class="kt">void</span> <span class="nf">update</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">mBatteryLevel</span> <span class="o">=</span> <span class="n">BATTERY_SCALE</span> <span class="o">-</span> <span class="n">CRITICAL_BATTERY_LEVEL</span><span class="o">;</span>
    <span class="n">mBatteryLevelCritical</span> <span class="o">=</span> <span class="n">mBatteryLevel</span> <span class="o">&lt;=</span> <span class="n">CRITICAL_BATTERY_LEVEL</span><span class="o">;</span>
    <span class="n">mPlugType</span> <span class="o">=</span> <span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_PLUGGED_AC</span><span class="o">;</span>
    <span class="n">mDischargeStartTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>

    <span class="n">mBatteryStatus</span> <span class="o">=</span> <span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_STATUS_FULL</span><span class="o">;</span>
    <span class="n">mBatteryHealth</span> <span class="o">=</span> <span class="n">BatteryManager</span><span class="o">.</span><span class="na">BATTERY_HEALTH_GOOD</span><span class="o">;</span>
    <span class="n">mBatteryPresent</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
    <span class="n">mBatteryVoltage</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>
    <span class="n">mBatteryTemperature</span> <span class="o">=</span> <span class="mi">42</span><span class="o">;</span>
    <span class="n">mBatteryTechnology</span> <span class="o">=</span> <span class="s">&quot;NITDroid&quot;</span><span class="o">;</span>
    <span class="n">sendIntent</span><span class="o">();</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Make, copy to SD card, load kernel, run. And guess what&#8230;I want to cry right
now. This is what I live for. If there is a heaven, I am there now. FIRST
BOOTABLE FROYO IMAGE ON THE N810!!!</p></div>
<div class="paragraph"><div class="title">First bootable Froyo image (Android version 2.2.2_r1) on the N810:</div><p><span class="image">
<a class="image" href="/assets/files/nitdroid/P1030162.JPG">
<img src="/assets/files/nitdroid/P1030162_small.JPG" alt="Froyo Home screen on the Nokia N810" width="256" height="192" />
</a>
</span>
<span class="image">
<a class="image" href="/assets/files/nitdroid/P1030163.JPG">
<img src="/assets/files/nitdroid/P1030163_small.JPG" alt="Android browser on the Nokia N810" width="256" height="192" />
</a>
</span></p></div>
<div class="paragraph"><p>Unfortunately, I am still far from done. Things that are missing, in order of priority:</p></div>
<div class="ulist"><ul>
<li>
<p>
For some strange reason, although the touchscreen driver in the kernel
definitely works (as I have booted the same kernel with the stock Maemo
userspace and it worked there), the touchscreen does not work at all. This is of
course most urgent.
</p>
</li>
<li>
<p>
Sound does not work; the sound driver for the N810 in my current kernel does
not even compile and I had to disable it.
</p>
</li>
<li>
<p>
Power and battery drivers.
</p>
</li>
<li>
<p>
Some sort of key remapping mechanism as the N810 has different hardware keys.
</p>
</li>
<li>
<p>
WiFi.
</p>
</li>
</ul></div>
<div class="paragraph"><p>But for now, blissful sleep. So I guess I didn&#8217;t end up turning in that essay that was due Friday of last week after all&#8230;but that moment of just pure orgasmic euphoria was worth it all. Good night.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 08, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-ii-first-bootable-froyo-image.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-ii-first-bootable-froyo-image.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/ugh.html" rel="bookmark">
      Ugh...
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-04T03:50:15-07:00">
          May 04, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/ugh.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Haven&#8217;t been able to work on NITDroid in a while&#8230;anyway I came across a couple of interesting links and I&#8217;ll look more into them when I get to it.</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.kandroid.org/android_pdk/display_drivers.html">Android Porting Guide - Display Drivers</a> is a cool page that discusses implementing a framebuffer device driver for Android.
</p>
</li>
<li>
<p>
<a href="http://git.kernel.org/?p=linux/kernel/git/stable/linux-2.6.32.y.git;a=blob;f=Documentation/fb/framebuffer.txt">The Frame Buffer Device</a> in the Linux kernel documentation. This really isn&#8217;t a link, but it gives a good overview of what a framebuffer device driver looks like in Linux.
</p>
</li>
<li>
<p>
<a href="http://linuxconsole.sourceforge.net/fbdev/HOWTO/index.html">Linux Framebuffer Driver Writing HOWTO</a> was a wow-moment for me. Will have to follow this closer. I only hope it&#8217;s not too outdated as it was last updated in 2001.
</p>
</li>
</ul></div>
<div class="paragraph"><p>That&#8217;s it for now. This summer is going to be fun.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 04, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/ugh.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/ugh.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-userland-update.html" rel="bookmark">
      NITDroid userland update
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-02-19T04:37:25-08:00">
          Feb 19, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-userland-update.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Although I haven&#8217;t been able to make much progress, I thought I&#8217;d post an update
on NITDroid for documentation purposes. I&#8217;ve been working on the Android
userland and it hasn&#8217;t been easy so far.</p></div>
<div class="paragraph"><p>I started off by following <a href="http://elinux.org/Android_on_OMAP">this page</a> on
eLinux.org again; the idea was to extract userland files from the system images
provided by the SDK for emulation on QEMU. I tried this method with Gingerbread
images; however, it did not take me long to notice that these images are missing
important components - for example, the DBUS daemon, <code>/system/bin/dbus-daemon</code>
and its associated library and config file are not present, despite being named
as startup services in <code>init.rc</code>. A little research showed me that the so-called
"SDK builds" have indeed different configurations than normal builds.</p></div>
<div class="paragraph"><p>The natural conclusion is that I should manually build the images from source,
as explained <a href="http://source.android.com/source/download.html">here</a> on the
Android open source project page. It was not as straightforward as the page
claimed, however:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
I check out the code using <code>repo init -u git://whatever.git -b gingerbread</code>,
and try to build. I am told that anything from Froyo up required a 64-bit host
system. I check out Froyo by <code>repo init -b froyo</code>, and am told that branch did
not exist. Fine; how abaout <code>repo init -b froyo-plus-aosp</code>? No, STILL requires a
64-bit system.
</p>
</li>
<li>
<p>
I spend an hour installing a full 64-bit Arch system on a CF card, forgetting to add <code>usb</code> to <code>mkinitcpio.conf</code>, and re-installing. I now boot into the new 64-bit system, and try building again. Now I am told my host system can&#8217;t build 32-bit binaries. Seriously, <em>WTF</em>?? Why on earth would the Android source make you build 32-bit binaries on a 64-bit system??
</p>
</li>
<li>
<p>
Alright, I&#8217;ll install <code>gcc-multilib</code> and friends from the multilib repository
(see
<a href="https://wiki.archlinux.org/index.php/Arch64_FAQ#Multilib_Repository_-_Multilib_Project">this page</a>
on the Arch wiki). Build.
</p>
</li>
<li>
<p>
The build process halts because I&#8217;m missing some tools. <code>yaourt -S gperf zip
unzip</code>. My bad.
</p>
</li>
<li>
<p>
I get <em>compile errors</em>. A completely useless component called MonkeyRunner
requires <code>javax.annotation.Nullable</code> which allows you to use <code>@Nullable</code> and
<code>@NotNull</code> in your Java code. How useful. <code>find sdk/monkeyrunner/src -type f
-exec sed -i <em>s/@Nullable//g</em> <em>{}</em> <em>;</em></code> etc.
</p>
</li>
<li>
<p>
More dependency errors, and no one else has ever run into this while building
Froyo. This sucks. I&#8217;ve already spent 12 hours on this. Giving up.
</p>
</li>
</ol></div>
<div class="paragraph"><p>I suddenly decided to test out the now abandoned N8x0 version of the NITDroid
project, which is based on Android 1.6 (Donut). I downloaded the rootfs,
extracted it to the SD card, and booted it up with my kernel. I could actually
boot to a UI telling me I&#8217;m running out of battery (I was) before it would
freeze and then die. Still, this shows me my display driver is working, although
of course it might not with Android 2.0+ (see
<a href="http://elinux.org/Android_on_OMAP#Blank_screen">here</a>). But that is
encouraging. I try my previous rootfs extracted from SDK images; I still get
only a blank screen after Zygote starts, probably due to the page flipping issue
and probably meaning the fix on that page does not actually work.</p></div>
<div class="paragraph"><p>Then, as stuck as I was, I found
<a href="http://groups.google.com/group/android-x86/browse_thread/thread/00aeaafa85eaaa31/f7ef2af3b7862048">this page</a>
which showed me that it is possible to build Froyo on a 32-bit system if
checked it out as <code>repo init -b android-&lt;version&gt;</code>. Then I found
<a href="http://groups.google.com/group/android-porting/browse_thread/thread/e939f7e86a555892">this
page</a> which discusses the possibility of modifying the source code of the
userland so that it does not require page flipping / double buffering; and
lastly but most interestingly, <a href="http://www.yuan.se/?p=7">this page</a> discusses
actually implementing double buffering in a kernel framebuffer driver.</p></div>
<div class="paragraph"><p>So I naturally checked out Froyo using <code>repo init -b android-2.2.1_r2</code> and when
instructed by the build script installed <code>jdk5</code> from the AUR (I had to patch the
PKGBUILD according to the comments and create a symlink from <code>/opt/java5</code> to
<code>/opt/java</code>). Froyo is happily compiling (for now), and I should go to
bed&#8230;I&#8217;ve done basically nothing else all day and it is 5am.</p></div>
<div class="paragraph"><p>UPDATE (02/19/2011): Froyo compiled without a problem using JDK5; looks like the compile errors I got before were due to differences between JDK5 and JDK6. I could never have figured that out if the build script hadn&#8217;t told me. But the built userland still freezes when launching Zygote; it seems framebuffer is the problem. I found <a href="https://sites.google.com/site/nitdroid/n900-port">this page</a> that gives a patch that supposedly allowed the N900 to boot into GUI despite its lack of page flipping support. I will investigate further later.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 19, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/mmc-support-in-nitdroid-kernel.html" rel="bookmark">
      MMC support in NITDroid kernel
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-02-16T21:29:54-08:00">
          Feb 16, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/mmc-support-in-nitdroid-kernel.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>The kernel now supports both the internal and the external MMC. For some bizarre reason, all I had to do to get the external MMC to work was turn on <code>CONFIG_MENELAUS</code> and <code>CONFIG_MMC_OMAP</code>; the kernel was not crashing anymore unlike in the <a href="?p=79">this previous post</a> when I built the first bootable kernel. I guess my new approach of restarting from scratch and changing as little as possible paid off.</p></div>
<div class="paragraph"><p>I wasted hours getting the internal MMC to work, however. It turns out that the issue was not with the MMC driver in <code>drivers/mmc/host/omap.c</code> but with the Menelaus driver in <code>drivers/mfd/menelaus.c</code>; in fact, there was a f-ing <em>typo</em> in that file, as explained in <a href="http://lkml.org/lkml/2010/8/8/98">this email</a>. The fix isn&#8217;t in either the vanilla linux-omap 2.6.32 or the Android OMAP 2.6.32 tree, though, and it looks like the people over at Meego still haven&#8217;t figured it out (see <a href="http://forum.meego.com/showthread.php?p=3525">this thread</a>). Seriously, all the smart people at Intel, Nokia, AMD and Novel&#8230;</p></div>
<div class="paragraph"><p>Anyhow, <a href="/assets/files/nitdroid/bootable-mmc-20110216.diff">here</a> is the comprehensive diff file from commit 69a7364c16c5aeb246dbb4c4e7696e39841492f5 in the Android OMAP archive/android-omap-2.6.32 branch, and <a href="/assets/files/nitdroid/zImage-20110216">here</a> is the compiled zImage. Of course, sound and WiFi are still not working, among other things I suppose. On the other hand, looking forward, I think I&#8217;ll stop working on the kernel for now (believe me, I&#8217;m <em>sick</em> of diff&#8217;s and grep&#8217;s across five different kernel trees&#8230;) and instead start working on the userland. Or homework.</p></div>
<div class="paragraph"><p>UPDATE (02/16/2011): Screw homework. Just updated the linked files with Android support (according to <a href="http://elinux.org/Android_on_OMAP">this page</a>); this includes double buffering support in <code>omapfb_main.c</code>.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 16, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/mmc-support-in-nitdroid-kernel.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/mmc-support-in-nitdroid-kernel.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/tag/projects2.html">&larr; Previous</a></li>
    <li class="next"><a href="https://seasonofcode.com/tag/projects4.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>