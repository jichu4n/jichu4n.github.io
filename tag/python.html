<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Python</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?26e193e7" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-to-add-custom-build-steps-and-commands-to-setuppy.html" rel="bookmark">
      How To Add Custom Build Steps and Commands To setup.py
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-10-07T14:53:00-07:00">
          Oct 07, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/python.html">Python</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-to-add-custom-build-steps-and-commands-to-setuppy.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>A <code>setup.py</code> script using
<a href="https://docs.python.org/2/distutils/introduction.html"><code>distutils</code></a> /
<a href="https://pythonhosted.org/setuptools/setuptools.html"><code>setuptools</code></a> is the
standard way to package Python code. Often, however, we need to perform custom
actions for code generation, running tests, profiling, or building
documentation, etc., and we&#8217;d like to integrate these actions into setup.py. In
other words, we&#8217;d like to add custom steps to <code>setup.py build</code> or <code>setup.py
install</code>, or add a new command altogether to <code>setup.py</code>.</p></div>
<div class="paragraph"><p>Let&#8217;s see how this is done.</p></div>
<div class="sect2">
<h3 id="_adding_custom_code_setup_py_code_commands_and_options">Adding Custom <code>setup.py</code> Commands and Options</h3>
<div class="paragraph"><p>Let&#8217;s implement a custom command that runs <a href="http://www.pylint.org/">Pylint</a> on all
Python files in our project. The high level idea is:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Implement command as a subclass of <code>distutils.cmd.Command</code>;
</p>
</li>
<li>
<p>
Add the newly defined command class to the <code>cmdclass</code> argument to <code>setup()</code>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>To see this in action, let&#8217;s add the following to our <code>setup.py</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">distutils.cmd</span>
<span class="kn">import</span> <span class="nn">distutils.log</span>
<span class="kn">import</span> <span class="nn">setuptools</span>
<span class="kn">import</span> <span class="nn">subprocess</span>


<span class="k">class</span> <span class="nc">PylintCommand</span><span class="p">(</span><span class="n">distutils</span><span class="o">.</span><span class="n">cmd</span><span class="o">.</span><span class="n">Command</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A custom command to run Pylint on all Python source files.&quot;&quot;&quot;</span>

  <span class="n">description</span> <span class="o">=</span> <span class="s">&#39;run Pylint on Python source files&#39;</span>
  <span class="n">user_options</span> <span class="o">=</span> <span class="p">[</span>
      <span class="c"># The format is (long option, short option, description).</span>
      <span class="p">(</span><span class="s">&#39;pylint-rcfile=&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="s">&#39;path to Pylint config file&#39;</span><span class="p">),</span>
  <span class="p">]</span>

  <span class="k">def</span> <span class="nf">initialize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Set default values for options.&quot;&quot;&quot;</span>
    <span class="c"># Each user option must be listed here with their default value.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

  <span class="k">def</span> <span class="nf">finalize_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Post-process options.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span><span class="p">:</span>
      <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span><span class="p">),</span> <span class="p">(</span>
          <span class="s">&#39;Pylint config file </span><span class="si">%s</span><span class="s"> does not exist.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run command.&quot;&quot;&quot;</span>
    <span class="n">command</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;/usr/bin/pylint&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span><span class="p">:</span>
      <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;--rcfile=</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">pylint_rcfile</span><span class="p">)</span>
    <span class="n">command</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">announce</span><span class="p">(</span>
        <span class="s">&#39;Running command: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">command</span><span class="p">),</span>
        <span class="n">level</span><span class="o">=</span><span class="n">distutils</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
    <span class="n">subprocess</span><span class="o">.</span><span class="n">check_call</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>


<span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
    <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span>
        <span class="s">&#39;pylint&#39;</span><span class="p">:</span> <span class="n">PylintCommand</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c"># Usual setup() args.</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, running <code>python setup.py --help-commands</code> will show:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Standard commands:
  ...
Extra commands:
  pylint: run Pylint on Python source files
  ...</code></pre>
</div></div>
<div class="paragraph"><p>We can now run the command we just defined with:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python setup.py pylint</code></pre>
</div></div>
<div class="paragraph"><p>&#8230;or with a custom option:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ python setup.py pylint --pylint-rcfile=.pylintrc</code></pre>
</div></div>
<div class="paragraph"><p>To learn more, you can check out documentation on
<a href="https://docs.python.org/2/distutils/apiref.html#creating-a-new-distutils-command">inheriting
from <code>distutils.cmd.Command</code></a> as well as the source code of some built-in
commands, such as
<a href="https://bitbucket.org/pypa/setuptools/src/312a67d000cb05d15b854957466c4751cf5e1c08/setuptools/command/build_py.py?at=default"><code>build_py</code></a>.</p></div>
</div>
<div class="sect2">
<h3 id="_adding_custom_steps_to_code_setup_py_build_code">Adding Custom Steps to <code>setup.py build</code></h3>
<div class="paragraph"><p>Let&#8217;s say we are really paranoid about code style and we&#8217;d like to run Pylint as
part of <code>setup.py build</code>. We can do this in the following manner:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Create a subclass of <code>setuptools.command.build_py.build_py</code> (or
  <code>distutils.command.build_py.build_py</code> if using <code>distutils</code>) that invokes our
  new Pylint command;
</p>
</li>
<li>
<p>
Add the newly defined command class to the <code>cmdclass</code> argument to <code>setup()</code>.
</p>
</li>
</ol></div>
<div class="paragraph"><p>For example, we can implement the following in our <code>setup.py</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">setuptools.command.build_py</span>


<span class="k">class</span> <span class="nc">BuildPyCommand</span><span class="p">(</span><span class="n">setuptools</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">build_py</span><span class="o">.</span><span class="n">build_py</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Custom build command.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">run_command</span><span class="p">(</span><span class="s">&#39;pylint&#39;</span><span class="p">)</span>
    <span class="n">setuptools</span><span class="o">.</span><span class="n">command</span><span class="o">.</span><span class="n">build_py</span><span class="o">.</span><span class="n">build_py</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="n">setuptools</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span>
    <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span>
        <span class="s">&#39;pylint&#39;</span><span class="p">:</span> <span class="n">PylintCommand</span><span class="p">,</span>
        <span class="s">&#39;build_py&#39;</span><span class="p">:</span> <span class="n">BuildPyCommand</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c"># Usual setup() args.</span>
    <span class="c"># ...</span>
<span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>For more examples, I encourage you to check out the
<a href="https://bitbucket.org/pypa/setuptools/src/312a67d000cb05d15b854957466c4751cf5e1c08/setuptools/command/?at=default"><code>setuptools</code>
source code</a>.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 07, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/python.html">Python</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-to-add-custom-build-steps-and-commands-to-setuppy.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-to-add-custom-build-steps-and-commands-to-setuppy.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html" rel="bookmark">
      Python: Multiprocessing and Exceptions
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-03-10T22:54:00-07:00">
          Mar 10, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/python.html">Python</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Python&#8217;s
<a href="http://docs.python.org/3/library/multiprocessing.html"><code>multiprocessing</code></a> module
provides an interface for spawning and managing child processes that is familiar
to users of the <a href="http://docs.python.org/3/library/threading.html"><code>threading</code></a>
module. One problem with the <code>multiprocessing</code> module, however, is that
<strong>exceptions in spawned child processes don&#8217;t print stack traces</strong>:</p></div>
<div class="paragraph"><p>Consider the following snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">somelib</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">somelib</span><span class="o">.</span><span class="n">somefunc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div></div></div>
<div class="paragraph"><p>and the following error message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "test.py", line 9, in &lt;module&gt;
    print(pool.map(f, range(5)))
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 228, in map
    return self._map_async(func, iterable, mapstar, chunksize).get()
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 564, in get
    raise self._value
ZeroDivisionError: division by zero</code></pre>
</div></div>
<div class="paragraph"><p>What triggered the <code>ZeroDivisionError</code>? Did <code>somelib.somefunc(x)</code> return 0, or
did some other computation in <code>somelib.somefunc()</code> cause the exception? You will
notice that we only see the stack trace of the main process, whereas the stack
trace of the code that actually triggered the exception in the worker processes
is not shown at all.</p></div>
<div class="paragraph"><p>Luckily, Python provides a handy
<a href="http://docs.python.org/3/library/traceback.html"><code>traceback</code></a> module for working
with exceptions and stack traces. All we have to do is catch the exception
inside the worker process, and print it. Let&#8217;s change the code above to read:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">somelib</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">somelib</span><span class="o">.</span><span class="n">somefunc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Caught exception in worker thread (x = </span><span class="si">%d</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="c"># This prints the type, value, and stack trace of the</span>
    <span class="c"># current exception being handled.</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">print</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, if you run the same code again, you will see something like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Caught exception in worker thread (x = 0):
Traceback (most recent call last):
  File "test.py", line 7, in f
    return 1 / somelib.somefunc(x)
  File "/path/to/somelib.py", line 2, in somefunc
    return 1 / x
ZeroDivisionError: division by zero

Traceback (most recent call last):
  File "test.py", line 16, in &lt;module&gt;
    print(pool.map(f, range(5)))
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 228, in map
    return self._map_async(func, iterable, mapstar, chunksize).get()
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 564, in get
    raise self._value
ZeroDivisionError: division by zero</code></pre>
</div></div>
<div class="paragraph"><p>The printed traceback reveals <code>somelib.somefunc()</code> to be the actual culprit.</p></div>
<div class="paragraph"><p>In practice, you may want to save the exception and the stack trace somewhere.
For that, you can use the
<a href="http://docs.python.org/3/library/traceback.html#traceback.print_exc"><code>file</code></a>
argument of
<a href="http://docs.python.org/3/library/traceback.html#traceback.print_exc"><code>print_exc</code></a>
in combination with
<a href="http://docs.python.org/3/library/io.html?highlight=stringio#io.StringIO"><code>StringIO</code></a>.
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">io</span>  <span class="c"># Import StringIO in Python 2</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">Work</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">exc_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">exc_buffer</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s">&#39;Uncaught exception in worker process:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">exc_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">raise</span> <span class="n">e</span>
</pre></div></div></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Mar 10, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/python.html">Python</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html" rel="bookmark">
      Unicode I/O and Locales in Python
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-02-20T17:51:00-08:00">
          Feb 20, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/python.html">Python</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I recently ran into a weird error when running some Python code in a chroot jail.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="s">&#39;你好&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>gave me</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python3.3/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 0: ordinal not in range(128)</code></pre>
</div></div>
<div class="paragraph"><p>The same happened with interprocess I/O:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="s">&#39;/usr/bin/cat&#39;</span><span class="p">,</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
  <span class="p">(</span><span class="n">cmd_stdout</span><span class="p">,</span> <span class="n">cmd_stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>gave me</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python3.3/subprocess.py", line 578, in check_output
    output, unused_err = process.communicate(timeout=timeout)
  File "/usr/lib/python3.3/subprocess.py", line 908, in communicate
    stdout = _eintr_retry_call(self.stdout.read)
  File "/usr/lib/python3.3/subprocess.py", line 479, in _eintr_retry_call
    return func(*args)
  File "/usr/lib/python3.3/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 0: ordinal not in range(128)</code></pre>
</div></div>
<div class="paragraph"><p>It turns out that Python <code>str</code>'s are encoded to/decoded from raw bytes during
I/O (<code>print</code>, file I/O, IPC, etc) using the <em>default</em> system locale encoding.
The advantage is that, if your system locale is set up correctly, everything
just works - there&#8217;s no explicit encoding/decoding between strings and bytes.
The downside is that your Python code that runs fine on one machine can fail
mysteriously on a different machine.</p></div>
<div class="paragraph"><p>In my case, the chroot jail yielded:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ locale
LANG=C
LC_CTYPE="C"
LC_NUMERIC="C"
LC_TIME="C"
LC_COLLATE="C"
LC_MONETARY="C"
LC_MESSAGES="C"
LC_PAPER="C"
LC_NAME="C"
LC_ADDRESS="C"
LC_TELEPHONE="C"
LC_MEASUREMENT="C"
LC_IDENTIFICATION="C"
LC_ALL=</code></pre>
</div></div>
<div class="sect3">
<h4 id="_solution_a">Solution A</h4>
<div class="paragraph"><p>The simplest solution is to set the system locale, either just for the Python
program or for your shell. For example,</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Run ./my_program.py with a custom LANG value.</span>
<span class="nv">LANG</span><span class="o">=</span>en_US.utf-8 ./my_program.py
</pre></div></div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Set locale for current shell session.</span>
<span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>en_US.utf-8
./my_program.py
</pre></div></div></div>
<div class="paragraph"><p>In fact, it&#8217;s probably a good idea to add the <code>export</code> line to your <code>~/.bashrc</code>,
or follow however your Linux distro decides locales should be set.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_b">Solution B</h4>
<div class="paragraph"><p>On the other hand, you can explicitly set the encoding used during I/O in your
Python code.</p></div>
<div class="paragraph"><p>For file I/O, in Python 3.x, you can set the <code>encoding</code> argument of
<a href="http://docs.python.org/3.3/library/functions.html#open"><code>open</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Python 3.x</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In Python 2.x, you can use
<a href="http://docs.python.org/2/library/codecs.html#codecs.open"><code>codecs.open</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Python 2.x</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Alternatively, you can use raw mode for file I/O:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div></div></div>
<div class="paragraph"><p>For IPC with <code>subprocess</code>, you must <strong>not</strong> use <code>universal_newlines=True</code>, as that
will always attempt to encode/decode using the system locale. Instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="s">&#39;/usr/bin/cat&#39;</span><span class="p">,</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
  <span class="p">(</span><span class="n">cmd_stdout_bytes</span><span class="p">,</span> <span class="n">cmd_stderr_bytes</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="p">(</span><span class="n">cmd_stdout</span><span class="p">,</span> <span class="n">cmd_stderr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">cmd_stdout_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">cmd_stderr_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div></div></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 20, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/python.html">Python</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
<div>
  <ul class="pager">
    <!--- <li class="previous disabled"><a>&larr; Previous</a></li> -->
    <!--- <li class="next disabled"><a>Next &rarr;</a></li> -->
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>