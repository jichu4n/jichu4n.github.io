<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Featured</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?8c372564" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html" rel="bookmark">
      Using ALSA audio drivers in Android
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-23T21:13:53-07:00">
          Oct 23, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>,            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>While working on a port of the Gingerbread (2.3.7) userland of Android for the N810, I had to figure out how to add support for an audio chip with a working ALSA driver in an Android build. The information was out there but it took me a while to figure everything out, so here&#8217;s a brief summary of the process.</p></div>
<div class="paragraph"><p>First, of course, ALSA drivers for the chip must be enabled in the kernel; to check whether they are working, see if <code>/dev/snd</code> is properly populated. If not, check if the driver has been compiled into the kernel and not as a module.</p></div>
<div class="paragraph"><p>There are three libraries that act as intermediate layers between an ALSA sound device and the Android userland. Due to <a href="http://groups.google.com/group/android-building/msg/c73c14f9b0dcd15a?pli=1">the recent relocation of the Android source tree</a>, I used alternative URLs for the three libraries. The code (shamelessly stolen and modified from <a href="http://www.armadeus.com/wiki/index.php?title=Android#Audio">this Armadeus Wiki page</a>) is as follows, assuming <code>$ANDROID_SOURCE</code> points to the root of the checked-out Android source tree:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/external
git clone git://git.omapzoom.org/platform/external/alsa-lib.git
git clone git://git.omapzoom.org/platform/external/alsa-utils.git

<span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/hardware
git clone git://git.omapzoom.org/platform/hardware/alsa_sound.git
</pre></div></div></div>
<div class="paragraph"><p>However, a bogus commit to the last library in <code>platform/hardware/alsa_sound</code> breaks the build (as explained <a href="http://comments.gmane.org/gmane.comp.handhelds.android.porting/15792">in this thread</a>), hence:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/hardware/alsa_sound
git checkout ece3f1b6f1e6a67d02e42490eca6c7de62220b57
</pre></div></div></div>
<div class="paragraph"><p>Then, modify the <code>BoardConfig.mk</code> of your build to include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">HAVE_HTC_AUDIO_DRIVER</span> <span class="o">:=</span> <span class="nb">false</span>
<span class="nv">BOARD_USES_GENERIC_AUDIO</span> <span class="o">:=</span> <span class="nb">false</span>
<span class="nv">BOARD_USES_ALSA_AUDIO</span> <span class="o">:=</span> <span class="nb">true</span>
<span class="nv">BUILD_WITH_ALSA_UTILS</span> <span class="o">:=</span> <span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>And that should do the trick.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 23, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>,          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html" rel="bookmark">
      How Rooting Works -- A Technical Explanation of the Android Rooting Process
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-19T21:55:36-07:00">
          Oct 19, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><img src="/assets/files/rooting_android.png"
align="right"
style="max-width: 200px; width: 25%; margin: 1.5em 0 1.5em 1.5em;">
I have always been curious how rooting actually worked behind the scenes. After
recently acquiring a new Eee Pad Slider, a Honeycomb tablet that so far no one
has been able to root, the frustration of being locked out of this amazing piece
of hardware with so much potential led me to finally sit down and figure out
what exactly rooting means, what it entails from a technical perspective, and
how hackers out in the wild are approaching the rooting of a new device.
Although all this information is out there, I have not been able to find a good
article that had both the level of technical detail that I wanted and an
appropriate introduction to the big picture, and so I decided to write my own.</p></div>
<div class="paragraph"><p>This is NOT a noob-friendly guide to rooting a particular Android device.
Rather, it is a general explanation of how stock Android ROMs try to prevent
unprivileged access, how hackers attack this problem and how rooting software
leverage various exploits to defeat these security mechanisms.</p></div>
<div class="sect2">
<h3 id="_i_the_goal">I. The Goal</h3>
<div class="paragraph"><p>Let us first take a step back and consider <em>exactly</em> what we mean by rooting.
Forget flashing custom ROMs, enabling WiFi tethering or installing
Superuser.apk; fundamentally, rooting is about obtaining root access to the
underlying Linux system beneath Android and thus gaining absolute control over
the software that is running on the device. Things that require root access on a
typical Linux system&#8201;&#8212;&#8201;mounting and unmounting file systems, starting your
favorite SSH or HTTP or DHCP or DNS or proxy servers, killing system processes,
chroot-ing, etc.,&#8201;&#8212;&#8201;require root access on Android as well. Being able to run
arbitrary commands as the root user allows you to do absolutely <em>anything</em> on a
Linux / Android system, and this is real goal of rooting.</p></div>
<div class="paragraph"><p>Stock OEM Android builds typically do not allow users to execute arbitrary code
as root. This essentially means that you as a user are granted only limited
control over your own device; you can make your device do task <em>X</em> only if the
manufacturer explicitly decided to allow it and shipped a program to do it.  You
will not be able to use third-party apps to accomplish a task that your
manufacturer does not wish you to do. WiFi tethering is a good example of this.
Cell phone carriers obviously do not want you to tether your phone without
paying them additional charges. Therefore, many phones come pre-packaged with
their own proprietary WiFi tethering apps that demand extraneous fees. But
without root access, you will not be able to install a free alternative like
<a href="http://code.google.com/p/android-wifi-tether/"> Wireless Tether For Root
Users</a>. Why this is accepted practice in the industry is a mystery to me.  The
only difference between cell phones, tablets and computers is their form factor;
but while a PC vendor would fail spectacularly if they tried to prevent users
from running arbitrary programs on their machines, cell phone vendors are
clearly not judged along the same lines. But such arguments would belong to
another article.</p></div>
</div>
<div class="sect2">
<h3 id="_ii_the_enemy_protection_mechanisms_on_a_stock_oem_android_rom">II. The Enemy: Protection Mechanisms On A Stock OEM Android ROM</h3>
<div class="sect3">
<h4 id="_1_bootloader_and_recovery">1. Bootloader and Recovery</h4>
<div class="paragraph"><p>The bootloader, the first piece of code executed when your device is powered on,
is responsible for loading the Android OS and the recovery system and flashing a
new ROM. People refer to some bootloaders as "unlocked" if a user can flash and
boot arbitrary ROMs without hacking; unfortunately, many Android devices have
locked bootloaders that you would have to hack around in order to make them do
anything other than boot the stock ROM. A Samsung smartphone I had used some
months ago had an unlocked bootloader; I could press a certain combination of
hardware keys on the phone, connect it to my computer, and flash any custom ROM
onto it using Samsung&#8217;s utilities without having to circumvent any protection
mechanisms. The same is not true for my Motorola Droid 2 Global; the bootloader,
as far as I know, cannot be hacked. The Eee Pad Slider, on the other hand, is an
interesting beast; as with other nVidia Tegra 2 based devices, its bootloader is
controllable through the <code>nvflash</code> utility, but only if you know the <em>secure
boot key</em> (SBK) of the device.  (The SBK is a private AES key used to encrypt
the commands sent to the bootloader; the bootloader will only accept the command
if it has been encrypted by the particular key of the device.) Currently, as the
SBK of the Eee Pad Slider is not publicly known, the bootloader remains
inaccessible.</p></div>
<div class="paragraph"><p>System recovery is the second piece of low-level code on board any Android
device. It is separate from the Android userland and is typically located on its
own partition; it is usually booted by the bootloader when you press a certain
combination of hardware keys. It is important to understand that it is a totally
independent program; Linux and the Android userland is not loaded when you boot
into recovery, and any high-level concept such as root does not exist here. It
is simple program that really is a very primitive OS, and it has absolute
control over the system and will do anything you want as long as the code to do
it is built in. Stock recovery varies with the manufacturer, but often includes
functionalities like reformatting the <code>/data</code> partition (factory reset) and
flashing an update ROM (<code>update.zip</code>, located at the root of the external
microSD card) signed by the manufacturer.  Note I said <em>signed by the
manufacturer</em>; typically it is not possible to flash custom update files unless
you obtain the private key of the manufacturer and sign your custom update with
it, which is both impossible for most and illegal under certain jurisdictions.
However, since recovery is stored in a partition just like <code>/system</code>, <code>/data</code>
and <code>/cache</code> (more about that later), you can replace it with a custom recovery
if you have root access in Linux / Android.  Most people do just that upon
rooting their device; <a href="http://www.clockworkmod.com/">ClockworkMod Recovery</a>
is a popular third-party recovery image, and allows you to flash arbitrary ROMs,
backup and restore partitions, and lots of other magic.</p></div>
</div>
<div class="sect3">
<h4 id="_2_adb">2. ADB</h4>
<div class="paragraph"><p>ADB (see
<a href="http://developer.android.com/guide/developing/tools/adb.html">the official documentation for ADB</a>)
allows a PC or a Mac to connect to an Android device and perform certain
operations. One such operation is to launch a simple shell on the device, using
the command <code>adb shell</code>. The real question is what user do the commands executed
by that shell process run as. It turns out that it depends on the value of an
Android system property, named <code>ro.secure</code>. (You can view the value of this
property by typing <code>getprop ro.secure</code> either through an ADB shell or on a
terminal emulator on the device.) If <code>ro.secure=0</code>, an ADB shell will run
commands as the root user on the device. But if <code>ro.secure=1</code>, an ADB shell will
run commands as an unprivileged user on the device. Guess what <code>ro.secure</code> is
set to on almost every stock OEM Android build. But can we change the value of
<code>ro.secure</code> on a system? The answer is no, as implied by the <code>ro</code> in the name of
the property. The value of this property is set at boot time from the
<code>default.prop</code> file in the root directory. The contents of the root directory
are essentially <em>copied</em> from a partition in the internal storage on boot, but
you cannot write to the partition if you are not already root. In other words,
this property denies root access via ADB, and the only way you could change it
is by gaining root access in the first place. Thus, it is secure.</p></div>
</div>
<div class="sect3">
<h4 id="_3_android_ui">3. Android UI</h4>
<div class="paragraph"><p>On an Android system, all Android applications that you can see or interact with
directly are running as _un_privileged users in sandboxes. Logically, a program
running as an unprivileged user cannot start another program that is run as the
privileged user; otherwise any program can simply start another copy of itself
in privileged mode and gain privileged access to everything. On the other hand,
a program running as root can start another program as root or as an
unprivileged user. On Linux, privilege escalation is usually accomplished via
the <code>su</code> and <code>sudo</code> programs; they are often the only programs in the system
that are able to execute the system call <code>setuid(0)</code> that changes the current
program from running as an unprivileged user to running as root.  Apps that
label themselves as requiring root are in reality just executing other programs
(often just native binaries packaged with the app) through <code>su</code>. Unsurprisingly,
stock OEM ROMs never come with these <code>su</code>. You cannot just download it or copy
it over either; it needs to have its SUID bit set, which indicates to the system
that the programs this allowed to escalate its runtime privileges to root. But
of course, if you are not root, you cannot set the SUID bit on a program. To
summarize, what this means is that any program that you can interact with on
Android (and hence running in unprivileged mode) is unable to either 1) gain
privileged access and execute in privileged mode, or 2) start another program
that executes in privileged mode.  If this holds, the Android system by itself
is pretty much immune to privilege escalation attempts. We will see the loophole
exploited by on-device rooting applications in the next section.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_iii_fighting_the_system">III. Fighting the System</h3>
<div class="paragraph"><p>So how the hell do you root an Android? Well, from the security mechanisms
described above, we can figure out how to attack each component in turn.</p></div>
<div class="paragraph"><p>If your device happens to have an unlocked bootloader, you&#8217;re pretty much done.
An example is the Samsung phone that I had had. Since the bootloader allowed the
flashing of arbitrary ROMs, somebody essentially pulled the stock ROM from the
phone (using <code>dd</code>), added <code>su</code>, and repackaged it into a modified ROM. All I as
a user needed to do was to power off the phone, press a certain combination of
hardware keys to start the phone in flashing mode, and use Samsung&#8217;s utilities
to flash the modified ROM onto the phone.</p></div>
<div class="paragraph"><p>Believe it or not, certain manufacturers don&#8217;t actually set <code>ro.secure</code> to 1. If
that is the case, rooting is even easier; just plug the phone into your computer
and run ADB, and you now have a shell that can execute any program as root. You
can then mount <code>/system</code> as read-write, install <code>su</code> and all your dreams have
come true.</p></div>
<div class="paragraph"><p>But many other Android devices have locked bootloaders and <code>ro.secure</code> set. As
explained above, they should not be root-able because you can only interact with
unprivileged programs on the system and they cannot help you execute any
privileged code. So what&#8217;s the solution?</p></div>
<div class="paragraph"><p>We know that a number of important programs, including low-level system
services, must run as root even on Android in order to access hardware
resources. Typing <code>ps</code> on an Android shell (either via ADB or a terminal
emulator on the device) will give you an idea. These programs are started by the
<code>init</code> process, the first process started by the kernel (I often feel that the
kernel and the <code>init</code> process are kind of analogous to Adam and Eve&#8201;&#8212;&#8201;the
kernel spawns <code>init</code> in a particular fashion, and <code>init</code> then goes on and spawns
all other processes) which has to run as root because it needs to start other
privileged system processes.</p></div>
<div class="paragraph"><p>Now here&#8217;s the key insight: if you can hack / trick one of these system
processes running in privileged mode to execute your arbitrary code, you have
just gained privileged access to the system. This how all one-click-root methods
work, including z4root, gingerbreak, and so on. If you are truly curious, I
highly recommend
<a href="http://jon.oberheide.org/files/bsides11-dontrootrobots.pdf">this excellent
presentation on the various exploits used by current rooting tools</a>, but the
details are not as relevant here as the simple idea behind them. That idea is
that there are vulnerabilities in the system processes running as root in the
background that, if exploited, will allow us to execute arbitrary code as root.
Well, that "arbitrary code" is most certainly a piece of code that mounts
<code>/system</code> in read-write mode and installs a copy of <code>su</code> permanently on the
system, so that from then on we don&#8217;t need to jump through the hoops to run the
programs we really wanted to run in the first place.</p></div>
<div class="paragraph"><p>Since Android is open source as is Linux, what people have done is to scrutinize
and reason about the source code of the various system services until they find
a security hole they can leverage. This becomes increasingly hard as Google and
the maintainers of the various pieces of code fix those particular
vulnerabilities when they are discovered and published, which means that the
exploits will eventually become obsolete with newer devices. But the good news
is that manufacturers are not stupid enough to push OTA updates to fix a
vulnerability just to prevent rooting as it is very expensive for them; in
addition, devices in the market are always lagging behind the newest software
releases. Thus, it takes quite some time before these rooting tools are rendered
useless by new patches, and by then hopefully other exploits would have been
discovered.</p></div>
</div>
<div class="sect2">
<h3 id="_iv_see_it_in_action">IV. See It In Action!</h3>
<div class="paragraph"><p>To see all of this in action, you are invited to check out my follow-up article:
<a href="/posts/android-rooting-a-developers-guide.html">Android Rooting: A
Developer&#8217;s Guide</a>, which explains how I applied this stuff to figure out how to
root an actual device.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 19, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html" rel="bookmark">
      Internal input event handling in the Linux kernel and the Android userspace
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-14T20:53:39-07:00">
          May 14, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>While figuring out hardware buttons for my NITDroid project, I had the opportunity of exploring the way Linux and Android handle input events internally before passing them through to the user application. This post traces the propagation of an input event from the Linux kernel through the Android userspace as far as I understand it. Although the principles are likely the same for essentially any input device, I will be drawing on my investigations of the drivers for the LM8323 hardware keyboard (<code>drivers/input/keyboard/lm8323.c</code>) and the TSC2005 touchscreen (<code>drivers/input/touchscreen/tsc2005.c</code>) which are both found inside the Nokia N810.</p></div>
<div class="sect2">
<h3 id="_i_inside_the_linux_kernel">I. Inside the Linux kernel</h3>
<div class="paragraph"><p>Firstly, Linux exposes externally a uniform input event interface for each device as <code>/dev/input/eventX</code> where <code>X</code> is an integer. This means these "devices" can be polled in the same way and the events they produce are in the same uniform format. To accomplish this, Linux has a standard set of routines that every device driver uses to register / unregister the hardware it manages and publish input events it receives.</p></div>
<div class="paragraph"><p>When the driver module of an input device is first loaded into the kernel, its initialization routine usually sets up some sort of probing to detect the presence of the types of hardware it is supposed to manage. This probing is of course device-specific; however, if it is successful, the module will eventually invoke the function <code>input_register_device(&#8230;)</code> in <code>include/linux/input.h</code> which sets up a file representing the physical device as <code>/dev/input/eventX</code> where <code>X</code> is some integer. The module will also register a function to handle IRQs originating from the hardware it manages via <code>request_irq(&#8230;)</code> (<code>include/linux/interrupt.h</code>) so that the module will be notified when the user interacts with the physical device it manages.</p></div>
<div class="paragraph"><p>When the user physically interacts with the hardware (for instance by pushing / releasing a key or exerting / lifting pressure on the touchscreen), an IRQ is fired and Linux invokes the IRQ handler registered by the corresponding device driver. However, IRQ handlers by custom must return quickly as they essentially block the entire system when executing and thus cannot perform any lengthy processing; typically, therefore, an IRQ handler would merely 1) save the data carried by the IRQ, 2) ask the kernel to schedule a method that would process the event later on when we have exited IRQ mode, and 3) tell the kernel we have handled the IRQ and exit. This could be very straightforward, as the IRQ handler in the driver for the LM8323 keyboard inside the N810:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * We cannot use I2C in interrupt context, so we just schedule work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">irqreturn_t</span> <span class="nf">lm8323_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
        <span class="k">struct</span> <span class="n">lm8323_chip</span> <span class="o">*</span><span class="n">lm</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

        <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lm</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>

        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>It could also be more complex as the one in the driver of the TSC2005 touchscreen controller (<code>tsc2005_ts_irq_handler(&#8230;)</code>) as it integrates into the SPI framework (which I have never looked into&#8230;).</p></div>
<div class="paragraph"><p>Some time later, the kernel executes the scheduled method to process the recently saved event. Invariably, this method would report the event in a standard format by calling one or more of the <code>input_*</code> functions in <code>include/linux/input.h</code>; these include <code>input_event(&#8230;)</code> (general purpose), <code>input_report_key(&#8230;)</code> (for key down and key up events), <code>input_report_abs(&#8230;)</code> (for position events e.g. from a touchscreen) among others. Note that the <code>input_report_*(&#8230;)</code> functions are really just convenience functions that call <code>input_event(&#8230;)</code> internally, as defined in <code>include/linux/input.h</code>. It is likely that a lot of processing happens before the event is published via these methods; the LM8323 driver for instance does an internal key code mapping step and the TSC2005 driver goes through this crazy arithmetic involving Ohms (to calculate a pressure index from resistance data?). Furthermore, one physical IRQ could correspond to multiple published input events, and vice versa. Finally, when all event publishing is finished, the event processing method calls <code>input_sync(&#8230;)</code> to flush the event out. The event is now ready to be accessed by the userspace at <code>/dev/input/eventX</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_ii_inside_the_android_userspace">II. Inside the Android userspace</h3>
<div class="paragraph"><p>When the Android GUI starts up, an instance of the class <code>WindowManagerService</code> (<code>frameworks/base/services/java/com/android/server/WindowManagerservice.java</code>) is created. This class, when constructed, initializes the member field</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">final</span> <span class="n">KeyQ</span> <span class="n">mQueue</span><span class="o">;</span>
</pre></div></div></div>
<div class="paragraph"><p>where <code>KeyQ</code>, defined as a private class inside the same file, extends Android&#8217;s basic input handling class, the abstract class <code>KeyInputQueue</code> (<code>frameworks/base/services/java/com/android/server/KeyInputQueue.java</code> and <code>frameworks/base/services/jni/com_android_server_KeyInputQueue.cpp</code>). As <code>mQueue</code> is instantiated, it of course calls the constructor of <code>KeyInputQueue</code>; the latter, inconspicuously, starts an anonymous thread it owns that is at the heart of the event handling system in Android:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">Thread</span> <span class="n">mThread</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Thread</span><span class="o">(</span><span class="s">&quot;InputDeviceReader&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="o">...</span>
        <span class="n">RawInputEvent</span> <span class="n">ev</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RawInputEvent</span><span class="o">();</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">readEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>  <span class="c1">// block, doesn&#39;t release the monitor</span>

                <span class="kt">boolean</span> <span class="n">send</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_DEVICE_ADDED</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_DEVICE_REMOVED</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">di</span> <span class="o">=</span> <span class="n">getInputDevice</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">deviceId</span><span class="o">);</span>
                    <span class="o">...</span>
                    <span class="c1">// first crack at it</span>
                    <span class="n">send</span> <span class="o">=</span> <span class="n">preprocessEvent</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">ev</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="o">...</span>
                <span class="k">if</span> <span class="o">(!</span><span class="n">send</span><span class="o">)</span> <span class="o">{</span>
                    <span class="k">continue</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="n">mFirst</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                    <span class="c1">// Is it a key event?</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_KEY</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">scancode</span> <span class="o">&lt;</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">BTN_FIRST</span> <span class="o">||</span>
                                    <span class="n">scancode</span> <span class="o">&gt;</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">BTN_LAST</span><span class="o">))</span> <span class="o">{</span>
                        <span class="kt">boolean</span> <span class="n">down</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">value</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">down</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="n">di</span><span class="o">.</span><span class="na">mKeyDownTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">down</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="kt">int</span> <span class="n">keycode</span> <span class="o">=</span> <span class="n">rotateKeyCodeLocked</span><span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">keycode</span><span class="o">);</span>
                        <span class="n">addLocked</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">curTimeNano</span><span class="o">,</span> <span class="n">ev</span><span class="o">.</span><span class="na">flags</span><span class="o">,</span>
                                <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">,</span>
                                <span class="n">newKeyEvent</span><span class="o">(</span><span class="n">di</span><span class="o">,</span> <span class="n">di</span><span class="o">.</span><span class="na">mKeyDownTime</span><span class="o">,</span> <span class="n">curTime</span><span class="o">,</span> <span class="n">down</span><span class="o">,</span>
                                        <span class="n">keycode</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">scancode</span><span class="o">,</span>
                                        <span class="o">((</span><span class="n">ev</span><span class="o">.</span><span class="na">flags</span> <span class="o">&amp;</span> <span class="n">WindowManagerPolicy</span><span class="o">.</span><span class="na">FLAG_WOKE_HERE</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span>
                                         <span class="o">?</span> <span class="n">KeyEvent</span><span class="o">.</span><span class="na">FLAG_WOKE_HERE</span> <span class="o">:</span> <span class="mi">0</span><span class="o">));</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_KEY</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_ABS</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN_MT</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process position events from multitouch protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_ABS</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process position events from single touch protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">type</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">EV_REL</span> <span class="o">&amp;&amp;</span>
                            <span class="o">(</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="c1">// Process movement events from trackball (mouse) protocol.</span>
                        <span class="o">...</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                <span class="o">}</span>

            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">RuntimeException</span> <span class="n">exc</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;InputReaderThread uncaught exception&quot;</span><span class="o">,</span> <span class="n">exc</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">};</span>
</pre></div></div></div>
<div class="paragraph"><p>I have removed most of this ~350 lined function that is irrelevant to our discussion and reformatted the code for easier reading. The key idea is that this independent thread will</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Read an event
</p>
</li>
<li>
<p>
Call the <code>preprocess(&#8230;)</code> method of its derived class, offering the latter a chance to prevent the event from being propagated further
</p>
</li>
</ol></div>
<div class="paragraph"><p>3.Add it to the event queue owned by the class</p></div>
<div class="paragraph"><p>This <code>InputDeviceReader</code> thread started by <code>WindowManagerService</code> (indirectly via <code>KeyInputQueue&#8217;s constructor</code>) is thus THE event loop of the Android UI.</p></div>
<div class="paragraph"><p>But we are still missing the link from the kernel to this <code>InputDeviceReader</code>. What exactly is this magical <code>readEvent(&#8230;)</code>? It turns out that this is actually a native method implemented in the C++ half of <code>KeyInputQueue</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">static</span> <span class="n">Mutex</span> <span class="n">gLock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">sp</span><span class="o">&lt;</span><span class="n">EventHub</span><span class="o">&gt;</span> <span class="n">gHub</span><span class="p">;</span>

<span class="k">static</span> <span class="n">jboolean</span>
<span class="nf">android_server_KeyInputQueue_readEvent</span><span class="p">(</span><span class="n">JNIEnv</span><span class="o">*</span> <span class="n">env</span><span class="p">,</span> <span class="n">jobject</span> <span class="n">clazz</span><span class="p">,</span>
                                          <span class="n">jobject</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">gLock</span><span class="p">.</span><span class="n">lock</span><span class="p">();</span>
    <span class="n">sp</span><span class="o">&lt;</span><span class="n">EventHub</span><span class="o">&gt;</span> <span class="n">hub</span> <span class="o">=</span> <span class="n">gHub</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hub</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">hub</span> <span class="o">=</span> <span class="k">new</span> <span class="n">EventHub</span><span class="p">;</span>
        <span class="n">gHub</span> <span class="o">=</span> <span class="n">hub</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">gLock</span><span class="p">.</span><span class="n">unlock</span><span class="p">();</span>

    <span class="p">...</span>
    <span class="kt">bool</span> <span class="n">res</span> <span class="o">=</span> <span class="n">hub</span><span class="o">-&gt;</span><span class="n">getEvent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">deviceId</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scancode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keycode</span><span class="p">,</span>
            <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">when</span><span class="p">);</span>
    <span class="p">...</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Ah, so <code>readEvent</code> is really just a proxy for <code>EventHub::getEvent(&#8230;)</code>. If we proceed to look up <code>EventHub</code> in <code>frameworks/base/libs/ui/EventHub.cpp</code>, we find</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">int</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">scan_dir</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dirname</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">dir</span> <span class="o">=</span> <span class="n">opendir</span><span class="p">(</span><span class="n">dirname</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">while</span><span class="p">((</span><span class="n">de</span> <span class="o">=</span> <span class="n">readdir</span><span class="p">(</span><span class="n">dir</span><span class="p">)))</span> <span class="p">{</span>
        <span class="p">...</span>
        <span class="n">open_device</span><span class="p">(</span><span class="n">devname</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">closedir</span><span class="p">(</span><span class="n">dir</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="p">...</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">device_path</span> <span class="o">=</span> <span class="s">&quot;/dev/input&quot;</span><span class="p">;</span>
<span class="p">...</span>

<span class="kt">bool</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">openPlatformInput</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">scan_dir</span><span class="p">(</span><span class="n">device_path</span><span class="p">);</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">bool</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">getEvent</span><span class="p">(</span><span class="kt">int32_t</span><span class="o">*</span> <span class="n">outDeviceId</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outType</span><span class="p">,</span>
        <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outScancode</span><span class="p">,</span> <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outKeycode</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">outFlags</span><span class="p">,</span>
        <span class="kt">int32_t</span><span class="o">*</span> <span class="n">outValue</span><span class="p">,</span> <span class="kt">nsecs_t</span><span class="o">*</span> <span class="n">outWhen</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mOpened</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">mError</span> <span class="o">=</span> <span class="n">openPlatformInput</span><span class="p">()</span> <span class="o">?</span> <span class="nl">NO_ERROR</span> <span class="p">:</span> <span class="n">UNKNOWN_ERROR</span><span class="p">;</span>
        <span class="n">mOpened</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// First, report any devices that had last been added/removed.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mClosingDevices</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">DEVICE_REMOVED</span><span class="p">;</span>
            <span class="k">delete</span> <span class="n">device</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">mOpeningDevices</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
            <span class="p">...</span>
            <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">DEVICE_ADDED</span><span class="p">;</span>
            <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="p">...</span>
        <span class="n">pollres</span> <span class="o">=</span> <span class="n">poll</span><span class="p">(</span><span class="n">mFDs</span><span class="p">,</span> <span class="n">mFDCount</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
        <span class="p">...</span>

        <span class="c1">// mFDs[0] is used for inotify, so process regular events starting at mFDs[1]</span>
        <span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mFDCount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revents</span> <span class="o">&amp;</span> <span class="n">POLLIN</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">read</span><span class="p">(</span><span class="n">mFDs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iev</span><span class="p">));</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iev</span><span class="p">))</span> <span class="p">{</span>
                        <span class="p">...</span>
                        <span class="o">*</span><span class="n">outType</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
                        <span class="o">*</span><span class="n">outScancode</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">iev</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">EV_KEY</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">err</span> <span class="o">=</span> <span class="n">mDevices</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">layoutMap</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">(</span><span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">outKeycode</span><span class="p">,</span> <span class="n">outFlags</span><span class="p">);</span>
                            <span class="p">...</span>
                        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                            <span class="o">*</span><span class="n">outKeycode</span> <span class="o">=</span> <span class="n">iev</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
                        <span class="p">}</span>
                        <span class="p">...</span>
                        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
                    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                        <span class="c1">// Error handling</span>
                        <span class="p">...</span>
                        <span class="k">continue</span><span class="p">;</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="p">...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Again, most of the details have been stripped out from the above code, but we now see how <code>readEvent()</code> in <code>KeyInputQueue</code> is getting these events from Linux: on first call, <code>EventHub::getEvent</code> scans the directory <code>/dev/input</code> for input devices, opens them and saves their file descriptors in an array called <code>mFDs</code>. Then whenever it is called again, it tries to read from each of these input devices by simply calling the <a href="http://linux.die.net/man/2/read"><code>read(2)</code></a> Linux system call.</p></div>
<div class="paragraph"><p>OK, now we know how an event propagates through <code>EventHub::getEvent(&#8230;)</code> to <code>KeyInputQueue::readEvent(&#8230;)</code> then to <code>InputDeviceReader.run(&#8230;)</code> where it could get queued inside <code>WindowManagerService.mQueue</code> (which, as a reminder, extends the otherwise abstract <code>KeyInputQueue</code>). But what happens then? How does that event get to the client application?</p></div>
<div class="paragraph"><p>Well, it turns out that <code>WindowManagerService</code> has yet another private member class that handles just that:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">InputDispatcherThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
    <span class="o">...</span>
    <span class="nd">@Override</span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">process</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span> <span class="s">&quot;Exception in input dispatcher&quot;</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kt">void</span> <span class="nf">process</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">setThreadPriority</span><span class="o">(</span>
                <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Process</span><span class="o">.</span><span class="na">THREAD_PRIORITY_URGENT_DISPLAY</span><span class="o">);</span>
        <span class="o">...</span>
        <span class="k">while</span> <span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
            <span class="o">...</span>
            <span class="c1">// Retrieve next event, waiting only as long as the next</span>
            <span class="c1">// repeat timeout.  If the configuration has changed, then</span>
            <span class="c1">// don&#39;t wait at all -- we&#39;ll report the change as soon as</span>
            <span class="c1">// we have processed all events.</span>
            <span class="n">QueuedEvent</span> <span class="n">ev</span> <span class="o">=</span> <span class="n">mQueue</span><span class="o">.</span><span class="na">getEvent</span><span class="o">(</span>
                <span class="o">(</span><span class="kt">int</span><span class="o">)((!</span><span class="n">configChanged</span> <span class="o">&amp;&amp;</span> <span class="n">curTime</span> <span class="o">&lt;</span> <span class="n">nextKeyTime</span><span class="o">)</span>
                        <span class="o">?</span> <span class="o">(</span><span class="n">nextKeyTime</span><span class="o">-</span><span class="n">curTime</span><span class="o">)</span> <span class="o">:</span> <span class="mi">0</span><span class="o">));</span>
            <span class="o">...</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">ev</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">curTime</span> <span class="o">=</span> <span class="n">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
                    <span class="kt">int</span> <span class="n">eventType</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">eventType</span><span class="o">((</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span> <span class="o">||</span>
                                <span class="n">ev</span><span class="o">.</span><span class="na">classType</span> <span class="o">==</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">LocalPowerManager</span><span class="o">.</span><span class="na">BUTTON_EVENT</span><span class="o">;</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">eventType</span> <span class="o">=</span> <span class="n">LocalPowerManager</span><span class="o">.</span><span class="na">OTHER_EVENT</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="o">...</span>
                    <span class="k">switch</span> <span class="o">(</span><span class="n">ev</span><span class="o">.</span><span class="na">classType</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_KEYBOARD</span><span class="o">:</span>
                            <span class="n">KeyEvent</span> <span class="n">ke</span> <span class="o">=</span> <span class="o">(</span><span class="n">KeyEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">ke</span><span class="o">.</span><span class="na">isDown</span><span class="o">())</span> <span class="o">{</span>
                                <span class="n">lastKey</span> <span class="o">=</span> <span class="n">ke</span><span class="o">;</span>
                                <span class="n">downTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">keyRepeatCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                                <span class="n">lastKeyTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">nextKeyTime</span> <span class="o">=</span> <span class="n">lastKeyTime</span>
                                        <span class="o">+</span> <span class="n">ViewConfiguration</span><span class="o">.</span><span class="na">getLongPressTimeout</span><span class="o">();</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">lastKey</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                                <span class="n">downTime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                                <span class="c1">// Arbitrary long timeout.</span>
                                <span class="n">lastKeyTime</span> <span class="o">=</span> <span class="n">curTime</span><span class="o">;</span>
                                <span class="n">nextKeyTime</span> <span class="o">=</span> <span class="n">curTime</span> <span class="o">+</span> <span class="n">LONG_WAIT</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">dispatchKey</span><span class="o">((</span><span class="n">KeyEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="n">mQueue</span><span class="o">.</span><span class="na">recycleEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TOUCHSCREEN</span><span class="o">:</span>
                            <span class="n">dispatchPointer</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="o">(</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_TRACKBALL</span><span class="o">:</span>
                            <span class="n">dispatchTrackball</span><span class="o">(</span><span class="n">ev</span><span class="o">,</span> <span class="o">(</span><span class="n">MotionEvent</span><span class="o">)</span><span class="n">ev</span><span class="o">.</span><span class="na">event</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">case</span> <span class="n">RawInputEvent</span><span class="o">.</span><span class="na">CLASS_CONFIGURATION_CHANGED</span><span class="o">:</span>
                            <span class="n">configChanged</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="k">default</span><span class="o">:</span>
                            <span class="n">mQueue</span><span class="o">.</span><span class="na">recycleEvent</span><span class="o">(</span><span class="n">ev</span><span class="o">);</span>
                        <span class="k">break</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">configChanged</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">lastKey</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="o">...</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">Slog</span><span class="o">.</span><span class="na">e</span><span class="o">(</span><span class="n">TAG</span><span class="o">,</span>
                    <span class="s">&quot;Input thread received uncaught exception: &quot;</span> <span class="o">+</span> <span class="n">e</span><span class="o">,</span> <span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div></div></div>
<div class="paragraph"><p>As we can see, this thread started by <code>WindowManagerService</code> is very simple; all it does is</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Grabs events queued into <code>WindowManagerService.mQueue</code>
</p>
</li>
<li>
<p>
Calls <code>WindowManagerService.dispatchKey(&#8230;)</code> when appropriate.
</p>
</li>
</ol></div>
<div class="paragraph"><p>If we next inspect <code>WindowManagerService.dispatchKey(&#8230;)</code>, we would see that it checks the currently focused window, and calls <code>android.view.IWindow.dispatchKey(&#8230;)</code> on that window. The event is now in the user space.</p></div>
<div class="paragraph"><p>I put together some nice diagrams that illustrate these interactions. The conceptual model:</p></div>
<div class="paragraph"><p><div align="center">
<strong>Event propagation flow on Android - simplified version</strong>
<img
src="https://docs.google.com/drawings/d/1qgD3O5ZZk1cC5tq6kLd_jKEtXx4P1Ty4wsSAHRKfhiU/pub?w=962&h=422"
style="width: 100%; max-width: 962px;"
alt="Event propagation flow on Android - simplified version">
</div></p></div>
<div class="paragraph"><p>The full model:
<div align="center">
<strong>Event propagation flow on Android</strong>
<img
src="https://docs.google.com/drawings/d/1VNaRYLdN5fOEz32XMzIR-ygphE-VD16CZltgV3aXavs/pub?w=750&h=902"
style="width: 100%; max-width: 750px;"
alt="Event propagation flow on Android">
</div></p></div>
<div class="paragraph"><p>The yellow boxes are Java implementations, and the blue boxes native or other.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 14, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/internal-input-event-handling-in-the-linux-kernel-and-the-android-userspace.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/shortening-paths-in-the-bash-prompt-with-prompt_dirtrim.html" rel="bookmark">
      Shortening paths in the Bash prompt with PROMPT_DIRTRIM
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-10T03:53:53-07:00">
          May 10, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/linux.html">Linux</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/shortening-paths-in-the-bash-prompt-with-prompt_dirtrim.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Bash 4 introduced a new environment variable called <code>PROMPT_DIRTRIM</code> that allows
the shortening of paths displayed in its prompts (via <code>w</code> in <code>PS1</code>. I added</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">PROMPT_DIRTRIM</span><span class="o">=</span>3
</pre></div></div></div>
<div class="paragraph"><p>to my <code>~/.bashrc</code> and whereas Bash used to display this prompt:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[user@host /media/D/Projects/nitdroid/ul/out/target/product/generic/system/framework]$</code></pre>
</div></div>
<div class="paragraph"><p>It now displays</p></div>
<div class="listingblock">
<div class="content">
<pre><code>[user@host .../generic/system/framework]$</code></pre>
</div></div>
<div class="paragraph"><p>which is a huge improvement especially when working with deep directory
structures.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 10, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/linux.html">Linux</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/shortening-paths-in-the-bash-prompt-with-prompt_dirtrim.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/shortening-paths-in-the-bash-prompt-with-prompt_dirtrim.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/msys-and-ssh-server-under-windows-7.html" rel="bookmark">
      MSYS and SSH server under Windows 7
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-03-14T03:29:05-07:00">
          Mar 14, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/misc.html">Misc</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/msys-and-ssh-server-under-windows-7.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>By order of The Professor, thou shalt install Windows 7 on thy lab machine. Alright, I can live with Windows, but I want my UNIX environment and I want SSH. I installed MinGW, MSYS, and got a basic UNIX environment working within a few minutes. It took me the better half of my weekend, however, to get an SSH server running that would allow me to use the Bash shell that comes with MSYS. I first tried <a href="http://www.freesshd.com/">freeSSHd</a>, but its terminal driver is crappy and I can&#8217;t even start Bash. <a href="http://mobassh.mobatek.net/">MobaSSH</a> comes with a copy of Cygwin, but my professor appears to have a grudge against Cygwin which is why I&#8217;m installing MinGW in the first place. I then tried <a href="http://www.kpym.com/">Kpym</a>; the personal version is so crippled I uninstalled it within five minutes. I tried <a href="http://sshwindows.sourceforge.net/">OpenSSH for Windows</a>, but it does not appear to work on Windows 7 at all. Finally, I discovered <a href="http://www.bitvise.com/winsshd">WinSSHD</a>. Setting the shell was a weird process; you had to go to Advanced Settings &#8594; Access Control &#8594; Windows Groups and change the default shell associated with "everyone" (I mean, what does this have to do with access control?) but when I changed the default shell to <code>C:MinGWmsys1.0bash.exe -il</code>, magic happened. However, vim was refusing to launch, and the vi binary that came with MSYS complained about the terminal type being unrecognizable. I screwed around a little bit and discovered that the solution was to open up the environment settings window from Control Panel and change the environment variable <code>CYGWIN</code> from <code>tty</code> to <code>notty</code>. The installer of WinSSHD adds this environment variable to Windows 7, but it appears to be entirely unnecessary and in my case counterproductive. Who cares though; the SSH server is running beautifully, and I can login directly to the MSYS Bash. Yay!!</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Mar 14, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/misc.html">Misc</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/msys-and-ssh-server-under-windows-7.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/msys-and-ssh-server-under-windows-7.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/tag/featured2.html">&larr; Previous</a></li>
    <!--- <li class="next disabled"><a>Next &rarr;</a></li> -->
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>