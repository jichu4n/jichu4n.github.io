<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Projects</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?918c51a9" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//analytics.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'piwik.php']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'piwik.js'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//analytics.chu4n.com/piwik.php?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html" rel="bookmark">
      Using ALSA audio drivers in Android
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-23T21:13:53-07:00">
          Oct 23, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>,            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>While working on a port of the Gingerbread (2.3.7) userland of Android for the N810, I had to figure out how to add support for an audio chip with a working ALSA driver in an Android build. The information was out there but it took me a while to figure everything out, so here&#8217;s a brief summary of the process.</p></div>
<div class="paragraph"><p>First, of course, ALSA drivers for the chip must be enabled in the kernel; to check whether they are working, see if <code>/dev/snd</code> is properly populated. If not, check if the driver has been compiled into the kernel and not as a module.</p></div>
<div class="paragraph"><p>There are three libraries that act as intermediate layers between an ALSA sound device and the Android userland. Due to <a href="http://groups.google.com/group/android-building/msg/c73c14f9b0dcd15a?pli=1">the recent relocation of the Android source tree</a>, I used alternative URLs for the three libraries. The code (shamelessly stolen and modified from <a href="http://www.armadeus.com/wiki/index.php?title=Android#Audio">this Armadeus Wiki page</a>) is as follows, assuming <code>$ANDROID_SOURCE</code> points to the root of the checked-out Android source tree:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/external
git clone git://git.omapzoom.org/platform/external/alsa-lib.git
git clone git://git.omapzoom.org/platform/external/alsa-utils.git

<span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/hardware
git clone git://git.omapzoom.org/platform/hardware/alsa_sound.git
</pre></div></div></div>
<div class="paragraph"><p>However, a bogus commit to the last library in <code>platform/hardware/alsa_sound</code> breaks the build (as explained <a href="http://comments.gmane.org/gmane.comp.handhelds.android.porting/15792">in this thread</a>), hence:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">cd</span> <span class="nv">$ANDROID_SOURCE</span>/hardware/alsa_sound
git checkout ece3f1b6f1e6a67d02e42490eca6c7de62220b57
</pre></div></div></div>
<div class="paragraph"><p>Then, modify the <code>BoardConfig.mk</code> of your build to include:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">HAVE_HTC_AUDIO_DRIVER</span> <span class="o">:=</span> <span class="nb">false</span>
<span class="nv">BOARD_USES_GENERIC_AUDIO</span> <span class="o">:=</span> <span class="nb">false</span>
<span class="nv">BOARD_USES_ALSA_AUDIO</span> <span class="o">:=</span> <span class="nb">true</span>
<span class="nv">BUILD_WITH_ALSA_UTILS</span> <span class="o">:=</span> <span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>And that should do the trick.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 23, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>,          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/using-alsa-audio-drivers-in-android.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-kernel-2638-3rd-pass.html" rel="bookmark">
      NITDroid kernel 2.6.38 - 3rd pass
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-21T13:41:43-07:00">
          Oct 21, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-3rd-pass.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Thanks to the amazing comment by bhaskar on my previous post, I am glad to announce that the LM8323 keyboard is now functional in the 2.6.38 kernel after applying the threaded IRQ patch by Felipe and the level-triggered IRQ patch by Leigh found on <a href="http://comments.gmane.org/gmane.linux.ports.arm.omap/58910">this thread on the LM8323</a>.</p></div>
<div class="paragraph"><p>I collected all the patches I used against the Android-OMAP 2.6.38 kernel at <a href="https://gitorious.org/nitdroid/kernel_patches">this new Git repository for NITDroid kernel patches</a> for better organization. I figured maintaining and working with patches was better than the entire kernel tree, and it also makes the changes easier for someone else to incorporate into their own kernel.</p></div>
<div class="paragraph"><p>A recent problem I have had with this particular kernel is that it is not able to boot Maemo anymore, but fails with weird errors about watchdog processes. This is not a huge problem since I am much more interested in getting Android to work, but it does complicate my testing process as I am now no longer able to test the kernel with a known working user software stack. So before continuing with the kernel, I am going to resume working on the userland again, and see what I can get done there. In particular, I am going to try switching gears to Gingerbread, and see if I can get its userland to boot instead. From what I have been able to read the differences between the Froyo and Gingerbread userlands should not be so large as to cause serious porting issues. But we will see in the following weeks whether that is true.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 21, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-3rd-pass.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-3rd-pass.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-kernel-2638-2nd-pass.html" rel="bookmark">
      NITDroid kernel 2.6.38 - 2nd pass
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-10-20T23:52:52-07:00">
          Oct 20, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-2nd-pass.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I have made some progress with the 2.6.38 kernel on the Nokia N810. It now boots fine to the Android GUI:</p></div>
<div class="paragraph"><div class="title">Froyo home screen on the Nokia N810, running kernel 2.6.38</div><p><span class="image">
<a class="image" href="/assets/files/nitdroid/nitdroid_20111021_1.jpg">
<img src="/assets/files/nitdroid/nitdroid_20111021_1_small.jpg" alt="Froyo home screen on the Nokia N810, running kernel 2.6.38" width="150" height="267" />
</a>
</span></p></div>
<div class="paragraph"><div class="title">File Expert app on the Nokia N810</div><p><span class="image">
<a class="image" href="/assets/files/nitdroid/nitdroid_20111021_2.jpg">
<img src="/assets/files/nitdroid/nitdroid_20111021_2_small.jpg" alt="File Expert app on the Nokia N810" width="150" height="267" />
</a>
</span></p></div>
<div class="paragraph"><p>But unfortunately it&#8217;s still too early to celebrate. There is a very bizarre bug in my kernel: upon boot-up, the keyboard works fine, but after an indeterminate number of key presses, the keyboard stops working. Other input sources, such as the touchscreen, are not affected, while hardware buttons like the back, home and menu keys, which are attached to the same keyboard device (LM8323), stop functioning as well. I inserted debug statements into the keyboard driver and booted to the console to watch kernel messages as I pressed keys. I was very surprised to discover that after the first few key presses, not even the IRQ handler registered by the keyboard driver is invoked anymore. I do not see at all how that is even possible; I will need to investigate further next time.</p></div>
<div class="paragraph"><p>Incidentally, I also came across <a href="http://blogs.arm.com/software-enablement/498-from-zero-to-boot-porting-android-to-your-arm-platform/">this wonderful article on Android porting</a> from an engineer at ARM. It is the most detailed and well-written text on the subject that I have ever read. My approach does differ from the one described in the article though.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Oct 20, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-2nd-pass.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-2nd-pass.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html" rel="bookmark">
      NITDroid kernel 2.6.38 - 1st pass
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-09-20T02:44:27-07:00">
          Sep 20, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>It&#8217;s been a while since I last updated this blog - the summer has been unsurprisingly busy, and as school has started again my hiatus is now officially over. But first, a HUGE thanks to all who inquired about and commented on the NITDroid project in the meantime, as even though I haven&#8217;t been able to get back to you individually your support has meant a lot to me.</p></div>
<div class="paragraph"><p>The first challenge I decided to tackle was improving the kernel I used. The kernel I had gotten working was based on Android OMAP 2.6.32 and contained many patches and copied files from various sources that I did not understand and could not hope to port to a newer kernel if needed. Looking through the diff files revealed many unnecessary or irrelevant changes that made them essentially useless beyond Android OMAP 2.6.32, and given the availability of Gingerbread, I figured that it would be beneficial in the long run if I could 1) minimize the modifications to the kernel required, and 2) port these changes to a newer version of the kernel.</p></div>
<div class="paragraph"><p>I started working, therefore, with Android OMAP 2.6.38 (since <a href="http://git.kernel.org">kernel.org</a> is down <a href="http://linearfix.wordpress.com/2011/09/12/linux-com-and-linuxfoundation-org-down-after-security-breach/">due to a security breach</a>, I had to use a mirror at <a href="http://git.omapzoom.org/?p=kernel/omap.git;a=summary">git.omapzoom.org</a>). I spent two days porting each necessary change manually, but to no avail. I was able to fix a problem introduced in 2.6.38 where the LCD was being reset by inserting <code>for (;;) {}</code> to determine the source of the problem; only later did I discover <a href="http://www.mail-archive.com/linux-omap@vger.kernel.org/msg45684.html">this email by Michael Buesch</a> which proposed a much simpler solution. But even then I did not get far; I was still stuck with the Nokia logo screen and could go no further. I had forgotten how painful debugging kernel builds were: there are no error messages or debugging output, and the only thing observable would be a frozen Nokia logo.</p></div>
<div class="paragraph"><p>Then, at wit&#8217;s end a couple of hours ago, I searched for the author of said email on Google and found <a href="http://bu3sch.de/cms/hacking/n810-openwrt.html">Michael Buesch&#8217;s page about his and others' work on OpenWRT on the N810</a>. I followed the instructions and was able to build a working kernel for the N810 with some minor fixes. The truly marvellous thing about this work, however, is that the exact patches that are used against a vanilla kernel are provided; they can be viewed <a href="https://dev.openwrt.org/browser/trunk/target/linux/omap24xx/patches-2.6.38">in the OpenWRT SVN repo</a> for instance. I went ahead and applied all their patches to a vanilla Android OMAP 2.6.38 kernel, but the resulting kernel still refused to boot. I ended up comparing each affected file painstakingly to its counterpart in the OpenWRT tree and was finally able to find the culprit: <code>arch/arm/mach-omap2/clock2420_data.c</code>; the problem was so dumb that I cannot believe it has been checked in at all. Here&#8217;s the diff:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="gh">diff --git a/arch/arm/mach-omap2/clock2420_data.c b/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gh">index 3c1712b..0a992bc 100644</span>
<span class="gd">--- a/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gi">+++ b/arch/arm/mach-omap2/clock2420_data.c</span>
<span class="gu">@@ -1786,10 +1786,10 @@ static struct omap_clk omap2420_clks[] = {</span>
        CLK(NULL,       &quot;gfx_2d_fck&quot;,   &amp;gfx_2d_fck,    CK_242X),
        CLK(NULL,       &quot;gfx_ick&quot;,      &amp;gfx_ick,       CK_242X),
        /* DSS domain clocks */
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;ick&quot;,          &amp;dss_ick,       CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;fck&quot;,          &amp;dss1_fck,      CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;sys_clk&quot;,      &amp;dss2_fck,      CK_242X),</span>
<span class="gd">-       CLK(&quot;omap_dss&quot;, &quot;tv_clk&quot;,       &amp;dss_54m_fck,   CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;ick&quot;,          &amp;dss_ick,       CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;dss1_fck&quot;,     &amp;dss1_fck,      CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;dss2_fck&quot;,     &amp;dss2_fck,      CK_242X),</span>
<span class="gi">+       CLK(&quot;omapdss&quot;,  &quot;tv_fck&quot;,       &amp;dss_54m_fck,   CK_242X),</span>
        /* L3 domain clocks */
        CLK(NULL,       &quot;core_l3_ck&quot;,   &amp;core_l3_ck,    CK_242X),
        CLK(NULL,       &quot;ssi_fck&quot;,      &amp;ssi_ssr_sst_fck, CK_242X),
</pre></div></div></div>
<div class="paragraph"><p>With all of these changes, and essentially the same <code>n810_defconfig</code> from before, the produced kernel boots up to Android, but dies when it tries to initialize the GUI. I have not found a solution to that yet, but at least it boots to console and prints out error messages. I will need to investigate the issue further next time.</p></div>
<div class="paragraph"><p>From now on, I think I will no longer reinvent the wheel and rely on OpenWRT patches for the N810 as much as possible. Thanks, Michael Buesch and everyone at OpenWRT!</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Sep 20, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-kernel-2638-1st-pass.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html" rel="bookmark">
      NITDroid userland update IV
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2011-05-14T22:14:26-07:00">
          May 14, 2011
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/projects.html">Projects</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I was able to get hardware keys to work last night. After a deep dive into the Android event handling system (see <a href="?p=162">my previous post</a>), I inserted log outputs in strategic positions and determined that the hardware keys were indeed sending events through the keyboard controller like the keys on the hardware keyboard. This made my life immensely easier; all I had to do was create a custom keyboard layout and set the corresponding key codes to HOME, BACK and so on.</p></div>
<div class="paragraph"><p>The scan codes I found for the hardware keys through my experiments and the corresponding functions I assigned them under Android are summarized in the following table:</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top"> Key                </th>
<th align="left" valign="top"> Code   </th>
<th align="left" valign="top"> Mapped to</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Switch application</p></td>
<td align="left" valign="top"><p class="table">63</p></td>
<td align="left" valign="top"><p class="table">Home</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Back</p></td>
<td align="left" valign="top"><p class="table">1</p></td>
<td align="left" valign="top"><p class="table">Back</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Full screen</p></td>
<td align="left" valign="top"><p class="table">64</p></td>
<td align="left" valign="top"><p class="table">Menu</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Minus sign</p></td>
<td align="left" valign="top"><p class="table">66</p></td>
<td align="left" valign="top"><p class="table">Vol down</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Plus sign</p></td>
<td align="left" valign="top"><p class="table">65</p></td>
<td align="left" valign="top"><p class="table">vol up</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Power</p></td>
<td align="left" valign="top"><p class="table">116</p></td>
<td align="left" valign="top"><p class="table">Power</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Menu</p></td>
<td align="left" valign="top"><p class="table">62</p></td>
<td align="left" valign="top"><p class="table">Menu</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>So I created a new board and a new product in the <code>build/</code> directory and defined the affected keys as follows in a new keyboard layout file, following the above results:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>key 1     BACK              WAKE_DROPPED
key 62    MENU              WAKE_DROPPED
key 63    HOME              WAKE
key 64    MENU              WAKE_DROPPED
key 65    VOLUME_UP
key 66    VOLUME_DOWN
key 116   POWER             WAKE</code></pre>
</div></div>
<div class="paragraph"><p>I also had to investigate how Android determined which keyboard layout file to look for. My search turned up this code in <code>EventHub::openDevice(&#8230;)</code> in <code>frameworks/base/libs/ui/EventHub.cpp</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">int</span> <span class="n">EventHub</span><span class="o">::</span><span class="n">open_device</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">deviceName</span><span class="p">)</span>
<span class="p">{</span>
    <span class="p">...</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ioctl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">EVIOCGNAME</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">//fprintf(stderr, &quot;could not get device name for %s, %sn&quot;, deviceName, strerror(errno));</span>
        <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">...</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">classes</span><span class="o">&amp;</span><span class="n">CLASS_KEYBOARD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">char</span> <span class="n">tmpfn</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">name</span><span class="p">)];</span>
        <span class="kt">char</span> <span class="n">keylayoutFilename</span><span class="p">[</span><span class="mi">300</span><span class="p">];</span>

        <span class="c1">// a more descriptive name</span>
        <span class="n">device</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

        <span class="c1">// replace all the spaces with underscores</span>
        <span class="n">strcpy</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">tmpfn</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">))</span>
            <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;_&#39;</span><span class="p">;</span>

        <span class="c1">// find the .kl file we need for this device</span>
        <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">root</span> <span class="o">=</span> <span class="n">getenv</span><span class="p">(</span><span class="s">&quot;ANDROID_ROOT&quot;</span><span class="p">);</span>
        <span class="n">snprintf</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">),</span>
                 <span class="s">&quot;%s/usr/keylayout/%s.kl&quot;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">tmpfn</span><span class="p">);</span>
        <span class="kt">bool</span> <span class="n">defaultKeymap</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">access</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="n">R_OK</span><span class="p">))</span> <span class="p">{</span>
            <span class="n">snprintf</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">),</span>
                     <span class="s">&quot;%s/usr/keylayout/%s&quot;</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="s">&quot;qwerty.kl&quot;</span><span class="p">);</span>
            <span class="n">defaultKeymap</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">device</span><span class="o">-&gt;</span><span class="n">layoutMap</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">(</span><span class="n">keylayoutFilename</span><span class="p">);</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>In other words, Android gets the device name from the device itself using <a href="http://linux.die.net/man/2/ioctl"><code>ioctl(2)</code></a>, replaces all spaces in it by underscores, and tries to load the keyboard layout file <code>/system/usr/keylayout/device_name.kl</code>. Originally in my kernel the N8x0 board initialization routines were overriding the device name to be "Internal Keyboard"; I felt that was a bit awkward and instead let the LM8323 driver itself assign the name to the default "LM8323 keypad". Therefore, my keyboard layout has to be named <code>LM8323_keypad.kl</code>. The Android build process automatically (well, I had to specify it in <code>BoardConfig.mk</code>) copies the keyboard layout file over to the correct location.</p></div>
<div class="paragraph"><p>Now when I tried building using my newly created board and product definitions, the build process was failing with the following error:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>target thumb C++: libcameraservice &lt;= frameworks/base/camera/libcameraservice/CameraService.cpp
make: *** No rule to make target `out/target/product/n8x0/obj/lib/libcamera.so', needed by `out/target/product/n8x0/obj/SHARED_LIBRARIES/libcameraservice_intermediates/LINKED/libcameraservice.so'.  Stop.</code></pre>
</div></div>
<div class="paragraph"><p>It took me quite a while to figure out what was going on. Apparently, Android expects every new board to provide a camera / audio implementation; otherwise, one has to enable the stub camera implementation with the following line in <code>BoardConfig.mk</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">USE_CAMERA_STUB</span> <span class="o">:=</span> <span class="nb">true</span>
</pre></div></div></div>
<div class="paragraph"><p>I found this after a long search in <a href="http://www.mail-archive.com/android-porting@googlegroups.com/msg05382.html">this thread</a>. The annoying thing is that while the generic board explicitly uses the stub audio implementation, it does not say anything about the stub camera implementation; why then does it compile thus without a problem whereas my custom board doesn&#8217;t?</p></div>
<div class="paragraph"><p>Finally, after a silly incident where the build system failed to copy over my modified keyboard layout file, I was able to use the hardware keys without further problems.</p></div>
<div class="paragraph"><p>As a safeguard, I set up some projects on <a href="http://github.com">GitHub</a> to track my work on NITDroid. Since they are also public they&#8217;re also effectively hosting my work. The projects are:</p></div>
<div class="ulist"><ul>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-Kernel">The NITDroid kernel</a>
</p>
</li>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-UL-build">The <code>build/</code> directory in the Android source tree</a>, with my custom additions including the keyboard layout
</p>
</li>
<li>
<p>
<a href="https://github.com/jichuan89/NITDroid-UL-frameworks-base">The <code>frameworks/base/</code> directory in the Android source tree</a>, with several mods discussed in previous posts such as <a href="?p=142">disabling the battery service</a> and <a href="?p=153">disabling screen power state reporting</a>
</p>
</li>
</ul></div>
<div class="paragraph"><p>Moving forward, I will next try to work out power. A stable power management implementation is the basis for a stable system; without it the system is essentially a house of cards. But that will have to wait until next week.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        May 14, 2011
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/projects.html">Projects</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/nitdroid-userland-update-iv.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/tag/projects.html">&larr; Previous</a></li>
    <li class="next"><a href="https://seasonofcode.com/tag/projects3.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>