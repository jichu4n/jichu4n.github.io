<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Featured</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?26e193e7" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html" rel="bookmark">
      How X Window Managers Work, And How To Write One (Part I)
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-04-10T01:08:00-07:00">
          Apr 10, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><!--googleoff: index--></p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html"><strong>Part I: Basic Concepts</strong></a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">Part III: Interaction with Application Windows</a>
</p>
</li>
</ul></div>
</div></div>
<div class="paragraph"><p><!--googleon: index--></p></div>
<div class="paragraph"><p>Window managers are one of the core components of the modern Linux/BSD desktop.
It is not an exaggeration to say that they define to a large degree our
day-to-day user experience, as they are responsible for deciding how individual
windows look, move around, react to input, and organize themselves. Hence,
almost 30 years since <a href="http://en.wikipedia.org/wiki/Ultrix_Window_Manager">the
first X window manager</a>, we still argue over the merits of different window
managers, and new window managers continue to reinvent how we interact with our
digital world.</p></div>
<div class="paragraph"><p>In this series of posts, I hope to demystify how window managers work, and how
you might go about writing one yourself.</p></div>
<div class="paragraph"><p>I will be quoting quite heavily from the seminal
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual (3rd Ed, 1994)</a> by Adrian Nye and published by O&#8217;Reilly.
Despite its age, it remains amazingly relevant and is the best available
introductory text to the internals of X, which has not changed over the past two
decades as much as you&#8217;d think. Since you could buy the book plus shipping for
less than the price of a cup of coffee, I strongly recommend it to anyone
interested in learning more about X. In addition, its chapter 16 also covers the
basics of window management.</p></div>
<div class="sect2">
<h3 id="_the_role_of_an_x_window_manager">The Role of an X Window Manager</h3>
<div class="paragraph"><p>Let&#8217;s start with an examination of the role of the window manager in a modern
Linux/BSD desktop environment.</p></div>
<div class="sect3">
<h4 id="_the_rights_of_x_window_managers">The Rights of X Window Managers</h4>
<div class="paragraph"><p>Unlike other windowing systems such as Microsoft Windows or Mac OS X, X does not
dictate a window manager or how a window manager should behave. This decision is
to thank for the wild diversity of X window managers we see today.</p></div>
<div class="quoteblock">
<div class="content">X is somewhat unusual in that it does not mandate a particular type of window
manager. Its developers have tried to make X itself as free of window management
or user interface policy as possible.</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง1.2.3
</div></div>
<div class="paragraph"><p>In fact, it does not even require a window manager to be present at all:</p></div>
<div class="quoteblock">
<div class="content">Unlike citizens, the window manager has rights but not responsibilities.
Programs must be prepared to cooperate with any type of window manager or with
none at all [&#8230;].</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง1.2.3
</div></div>
<div class="paragraph"><p>This is in stark contrast to the integrative approach of other GUI systems. On
Mac OS X and <a href="https://unity.ubuntu.com/">Unity</a>, for example, an application could
not possibly function without the window manager, as the latter is responsible
for rendering a part of the application&#8217;s interface (e.g., menus).</p></div>
</div>
<div class="sect3">
<h4 id="_the_responsibilities_of_x_window_managers">The Responsibilities of X Window Managers</h4>
<div class="paragraph"><p>As you probably already know, X operates in a server-client model. An X <em>server</em>
controls one or more physical display devices as well as input devices (mouse,
keyboard, etc.). An application that wants to interact with these devices
assumes the role of an X <em>client</em>. An X server and its clients may run on the
same computer, in which case they communicate via
<a href="http://en.wikipedia.org/wiki/Unix_domain_socket">domain sockets</a>, or on different
computers, in which case they communicate through TCP/IP.</p></div>
<div class="paragraph"><p><strong>A window manager is a regular X client.</strong> It doesn&#8217;t have any superuser
privileges or keys to kernel backdoors; it is a normal user process that is
allowed by the X server to call a set of special APIs. X ensures that no more
than one window manager is running at any given point by denying a client access
to these APIs if another client currently has access. The first client to
attempt to access these APIs always succeeds.</p></div>
<div class="paragraph"><p>A window manager communicates with the windows it manages through two X
mechanisms: properties and events. We will discuss these in detail in later
sections, but the takeaway is that the communication happens through the X
server, not directly between the window manager and other applications.</p></div>
<div class="paragraph"><p>This is illustrated by the following diagram:</p></div>
<div class="paragraph" id="role-of-a-window-manager"><p><div align="center"><img
src="https://docs.google.com/drawings/d/1Kv8kYF3IeWnsMSuF04goBPi1WudQV3llyK4R5lu_ips/pub?w=554&h=402"
alt="Role of a Window Manager"
style="max-width: 554px; width: 100%;"></div></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_an_x_window_manager_manages_windows">How an X Window Manager Manages Windows</h3>
<div class="paragraph"><p>Let&#8217;s now dive into the details of how a window manager does its job.</p></div>
<div class="sect3">
<h4 id="_the_window_hierarchy">The Window Hierarchy</h4>
<div class="paragraph"><p>When we think about modern GUIs, we usually use the term <em>widgets</em> or <em>controls</em>
to refer to UI elements such as buttons, scrollbars, or text boxes, and the term
<em>windows</em> to refer to a container for such widgets that has its own name and
can be independently moved around, closed, resized, etc..</p></div>
<div class="paragraph"><p>X, however, was designed to be as low-level as possible. The fundamental UI
model that X provides, upon which UI frameworks such as
<a href="http://www.gtk.org/">GTK+</a> and <a href="http://qt-project.org">Qt</a> are built, is that of an
<em>hierarchy of rectangles</em>. In X terminology, all top level windows and all UI
elements within are <em>windows</em>. In other words, a <em>window</em>, is any rectangular
area that is an unit of user interaction and/or graphic display.</p></div>
<div class="paragraph"><p>Windows are organized into a tree hierarchy. At the root of the hierarchy is the
<em>root window</em>, a virtual, invisible window that has the same size as the screen,
and is always present. Top level windows are direct children of the root
window. UI elements within a top level window are descendants of that window.</p></div>
<div class="paragraph"><p><div align="center"><img src="/assets/files/wm_sample_dialog.png" alt="An
example X window" style="max-width: 402px; width: 100%;"></div></p></div>
<div class="paragraph"><p>For example, consider the dialog box above from the <a href="http://www.xfce.org/">Xfce</a>
desktop environment. The entire dialog is an X <em>window</em>. All UI elements in the
dialog box - the magnifying glass icon, the text box, the green down arrow, the
Close and Launch buttons, and the icons inside those buttons - are also X
_window_s.</p></div>
<div class="paragraph"><p>The whole dialog window is a child of the root window. The magnifying glass
icon, the text box, and the Close and Launch buttons are children of the dialog
window. The green down arrow is a child of the text box window, and the icons in
the Close and Launch buttons are children of those buttons respectively.</p></div>
<div class="paragraph"><p>An important thing to note about X windows is that a child window is clipped to
the boundaries of its parent:</p></div>
<div class="quoteblock">
<div class="content">A child may be positioned partially or completely outside its parent window, but
output to the child is displayed and input received only in the area where the
child overlaps with the parent.</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง2.2.2
</div></div>
<div class="paragraph"><p>For example, if we increase the width of the text box in the dialog above by
2x without changing the size of the dialog box, the portion of the text box that
extends outside of the dialog box will become invisible, and clicking on it will
not send an event to the text box.</p></div>
<div class="paragraph"><p>A window manager manages top level windows - that is, direct children of the
root window.</p></div>
</div>
<div class="sect3">
<h4 id="substructure-redirection">Substructure Redirection</h4>
<div class="paragraph"><p>In the absence of a window manager, when an application wants to do something
with a window - move it, resize it, show/hide it, etc. - its request is directly
processed by the X server, and that&#8217;s the end of that. A window manager,
however, needs to intercept these requests. For example, a window manager may
need to know that a new top level window has been created and displayed, in
order to draw window decorations (e.g. minimize / maximize / close buttons)
around it. It may also need to know that an existing top level window has been
resized, in order to redraw the window decorations to reflect the change.</p></div>
<div class="paragraph"><p>The mechanism that allows a window manager to intercept such requests is called
<em>substructure redirection</em>.</p></div>
<div class="paragraph"><p>This is how substructure redirection works. Suppose we have a window <em>W</em>. If a
program <em>M</em> registers for substructure redirection on <em>W</em>, a matching request to
modify any direct child window of <em>W</em> will <em>not</em> be executed by the X server.
Instead, the X server redirects this request to the program <em>M</em>, which can do
whatever it wants with the request, including denying the request outright or
granting the request with modifications. More formally,</p></div>
<div class="quoteblock">
<div class="content">The <em>structure</em>, as the term is used here, is the location, size, stacking
order, border width, and mapping status of a window. The <em>substructure</em> is all
these statistics about the children of a particular window. This is the complete
set of information about screen layout that the window manager might need in
order to implement its policy. <em>Redirection</em> means that an event is sent to the
client selecting redirection (usually the window manager), and the original
structureโchanging request is not executed.</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง16.2
</div></div>
<div class="paragraph"><p>Note that only direct children of a window <em>W</em> is affected by substructure
redirection on <em>W</em>, not any windows further down the hierarchy.</p></div>
<div class="paragraph"><p>This gets interesting when we consider substructure redirection on the root
window:</p></div>
<div class="quoteblock">
<div class="content">When the window manager selects <code>SubstructureRedirectMask</code> on the root window,
an attempt by any other client to change the configuration of any child of the
root window will fail. Instead an event describing the layout change request
will be sent to the window manager. The window manager then reads the event and
determines whether to honor the request, modify it, or deny it completely. If it
decides to honor the request, it calls the routine that the client called that
triggered the event with the same arguments. If it decides to modify the
request, it calls the same routine but with modified arguments.</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง16.2
</div></div>
<div class="paragraph"><p>In other words, a window manager must register for substructure redirection on
the root window, which causes all creation, destruction, reconfiguration etc. of
top level windows - which are direct children of the root window - to be routed
to the window manager. This is the magic hook into the X server that window
managers rely on to do their job.</p></div>
<div class="paragraph"><p>This relationship is shown in the following diagram:
<div align="center"><img
src="https://docs.google.com/drawings/d/1ykdjiN-__H5-aWjic73c23K6g2MguBKLgwh9C2n-I5k/pub?w=602&amp;h=273"
alt="Role of a Window Manager"
style="max-width: 602px; width: 100%;"></div></p></div>
<div class="paragraph"><p>Finally, the X server only allows one running program to register for
substructure redirection on any given window at any given time. An attempt to
register for substructure redirection on a window will fail if another X client
has already done the same on the same window, and has not unregistered,
disconnected from the X server, or crashed. Since all window managers must
register for substructure redirection on the root window, this latter acts as a
locking mechanism that prevents two or more window managers from running
simultaneously on the same screen.</p></div>
</div>
<div class="sect3">
<h4 id="_reparenting">Reparenting</h4>
<div class="paragraph"><p>In the example dialog box above, we see a title bar with, for example, little
buttons for minimizing, maximizing, and closing the window. These UI elements
are not created by the application, but by the window manager, via a process
known as <em>reparenting</em> or <em>framing</em>:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>A window manager can decorate [top level] windows on the screen with titlebars
and place little boxes on the titlebar with which the window can be moved or
resized. This is only one possibility [&#8230;].</p></div>
<div class="paragraph"><p>To do this, the window manager creates a child of the root somewhat larger than
the top level window of the application. Then it calls
<a href="http://manpages.ubuntu.com/manpages/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a>,
specifying the top level window of the application as <code><em>win</em></code> and the new parent
[window it just created] as <code><em>parent</em></code>. <code><em>win</em></code> and all its descendants will
then be descendants of <code><em>parent</em></code>.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual ยง16.3
</div></div>
<div class="paragraph"><p>In other words, if we were to run an X application without a window manager
present, the top level window of the application would be a direct child of the
root window. With a window manager running, however, the top level window of the
application may be <em>reparented</em> by the window manager; it becomes a child of a
frame window which is created by the window manager, and which is itself a
direct child of the root window. The window manager can add other UI elements
inside this frame window alongside the application&#8217;s top level window as it sees
fit.</p></div>
<div class="paragraph"><p>Therefore, I&#8217;ve kind of lied to you several paragraphs ago: the dialog box shown
earlier is really a child window within a frame window created by
<a href="http://www.xfce.org">Xfce</a>'s window manager, Xfwm, along with other UI elements
for window management:
<div align="center"><img
src="https://docs.google.com/drawings/d/1JIaZeVZBB2Yu5t8e7l0Euln_ix61bg-pGEG086P-cLg/pub?w=412&amp;h=248"
style="max-width: 412px; width: 100%;"></div></p></div>
<div class="paragraph"><p>Reparenting is what allows different window managers to draw different window
decorations, and thereby achieve a consistent look-and-feel across windows.
However, there are also window managers that do <em>not</em> reparent at all: these are
called <em>non-reparenting</em> window managers. There are two reasons why a window
manager would not want to reparent:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
If a window manager does not draw window decorations around top level
   windows , it obviously has no need to reparent them. Examples:
   <a href="http://xmonad.org">xmonad</a>, <a href="http://dwm.suckless.org">dwm</a>.
</p>
</li>
<li>
<p>
Compositing window managers do not always need to reparent windows; we will
   discuss why below. Example: <a href="http://www.compiz.org/">Compiz</a>. This is not true
   for all compositing window managers, however; for example, GNOME&#8217;s default
   window manager, <a href="http://github.com/GNOME/mutter/">Mutter</a>, is a reparenting
   comopositing window manager.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Let&#8217;s now consider substructure redirection in the context of reparenting. When
a top level window <em>W</em> is first shown (<em>map</em>'ped in X jargon), the window manager
is notified because it has registered for substructure redirection on the root
window, and a top level window is a direct child of the root window. It then
creates a frame <em>F</em> and reparents <em>W</em>, so that <em>W</em> becomes a child of <em>F</em>, which
itself is a child of the root window. But since now <em>W</em> is no longer a direct
child of the root window, the window manager will no longer be able to intercept
changes to <em>W</em>!</p></div>
<div class="paragraph"><p>Therefore, a reparenting window manager must also subsequently register for
substructure redirection on each frame window it creates.</p></div>
</div>
<div class="sect3">
<h4 id="_compositing">Compositing</h4>
<div class="paragraph"><p>Compositing window managers are a relatively new development. Compositing
support in X  was added in late 2004, a full decade after the last edition of
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual</a>. The first compositing window managers,
<a href="http://www.xfce.org">Xfwm</a> and <a href="http://www.compiz.org/">Compiz</a>, launched in early
2005.</p></div>
<div class="paragraph"><p>So, what exactly does a compositing window manager do?</p></div>
<div class="paragraph"><p>In our discussion above on substructure redirection and reparenting, we saw how
a window manager can respond to various requests for a top level window - to
display/hide it (<em>map</em>/<em>unmap</em> in X jargon), to resize it, to move it, etc.. But
we didn&#8217;t talk about how to deal with what&#8217;s <em>inside</em> the top level windows.</p></div>
<div class="paragraph"><p>Indeed, from the perspective of the window manager, top level windows are black
boxes; they each manage their own descendant windows (UI elements), perhaps
through a framework such as <a href="http://www.gtk.org">GTK+</a> or
<a href="http://qt-project.org/">Qt</a>, and the window manager has no right to interfere
there. The application that creates a top level window is responsible for
rendering and handling events for any descendant windows (UI elements), and does
so directly through X. This is shown in <a href="#role-of-a-window-manager">the first diagram above</a>.</p></div>
<div class="paragraph"><p>As the computing power of graphics hardware grew, so did people&#8217;s expectations
from their window managers. With hardware acceleration, it became possible to
build much more computationally intensive user interfaces, such as the
(in)famous Desktop Cube in <a href="http://www.compiz.org">Compiz</a>:
<div align="center"><img src="/assets/files/wm_compiz.png"
style="max-width: 640px; width: 100%;"></div>
or the Shift Switcher:
<div align="center"><img src="/assets/files/wm_compiz_2.png"
style="max-width: 640px; width: 100%;"></div>
Let&#8217;s take a moment to think about how we can implement an interface such as the
Shift Switcher above. When the user triggers this interface, we need to:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Render each top level window and all its descendant windows (UI elements) to
   an off-screen, in-memory buffer, instead of directly to the hardware.
</p>
</li>
<li>
<p>
Transform (rotate, contort, etc.) each buffer according to our design.
</p>
</li>
<li>
<p>
Composite the transformed buffers into a final buffer along with a background
   and any other floating UI elements else we need to display.
</p>
</li>
<li>
<p>
Create an <em>overlay</em> window that covers the entire screen and hides all other
   windows.
</p>
</li>
<li>
<p>
Render the final buffer into the overlay window.
</p>
</li>
</ol></div>
<div class="paragraph"><p>There are a number of challenges:</p></div>
<div class="ulist"><ul>
<li>
<p>
We must be able to retrieve the displayed contents of top level windows.
  However, as we described earlier, top level windows render their contents
  directly through X, without going through the window manager.
</p>
</li>
<li>
<p>
We need to update our interface in real time as the contents of the
  top level windows change. However, top level windows do not notify window
  managers when their contents change, again because they render their contents
  directly through X.
</p>
</li>
<li>
<p>
A top level window <em>A</em> may overlap with another top level window
  <em>B</em> below, which means a portion of <em>B</em> isn&#8217;t currently displayed. Our
  interface, however, must capture the <em>full</em> rendering of <em>A</em> and <em>B</em>,
  regardless of overlapping regions.
</p>
</li>
<li>
<p>
All this complex compositing process is computationally intensive and requires
  hardware acceleration to function adequately.
</p>
</li>
</ul></div>
<div class="paragraph"><p>It is clear that none of this would be possible without some heavy cooperation
from the X server. Enter the
<a href="http://cgit.freedesktop.org/xorg/proto/compositeproto/tree/compositeproto.txt">Composite
extension</a>:</p></div>
<div class="quoteblock">
<div class="content">Many user interface operations would benefit from having pixel contents of
window hierarchies available without respect to sibling and antecedent clipping.
In addition, placing control over the composition of these pixel contents into a
final screen image in an external application will enable a flexible system for
dynamic application content presentation.</div>
<div class="attribution">
&#8212; X Composite Extension
</div></div>
<div class="paragraph"><p>The Composite extension provides a mechanism to request the X server not to
render a specific window and its descendants directly to hardware, but to a
special buffer maintained by the X server, and do so without the normal clipping
and overlap computations. This buffer can then be read and used by the client
that made the request.</p></div>
<div class="paragraph"><p>That&#8217;s exactly what a compositing window manager does: it will ask X to render
each top level window to an off-screen, in-memory buffer and composite the
results into an overlay window itself. And it needs to do this not just for
fancy task switcher interfaces as in our example, but also to achieve effects
like translucency, animations, soft shadows, and the like.</p></div>
<div class="paragraph"><p>This is illustrated in the following diagram:
<div align="center"><img
src="https://docs.google.com/drawings/d/1eK05Uzlr2ix4NpsiEBUu42IwZ3DEjX8MvYTiE3-chqA/pub?w=573&amp;h=509"
style="max-width: 573px; width: 100%;"></div></p></div>
<div class="paragraph"><p>Let&#8217;s end this section by considering whether a compositing window manager
should reparent top level windows.</p></div>
<div class="paragraph"><p>Since a compositing window manager already knows the size and position of all
top level windows, it&#8217;s easy for it to just draw window decorations during
compositing into the overlay window using graphics operations (e.g. OpenGL),
without ever creating an actual X frame window and reparenting. Some compositing
window managers do operate this way.</p></div>
<div class="paragraph"><p>On the other hand, a window manager may need to support both a compositing and a
non-compositing mode, for compatibility with older or unsupported graphics
hardware. In this case, it needs to implement reparenting and frame windows for
non-compositing mode anyway, so additionally implementing drawing window
decorations using graphics operations becomes redundant. This is why may other
compositing window managers still choose to reparent.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ready_for_some_code">Ready For Some Code?</h3>
<div class="paragraph"><p>If you&#8217;ve read everything up to this point, you&#8217;re probably holding back the
urge to cry out "<em>Enough talk - show me some code!</em>" I don&#8217;t blame you.</p></div>
<div class="paragraph"><p>In <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">the
next installment</a> in this series, I will walk you through a basic
implementation of a reparenting, non-compositing window manager. Impatient?
Check out the code <a href="https://github.com/jichu4n/basic_wm">on GitHub</a>!</p></div>
<div class="paragraph"><p><strong>Next chapter:</strong>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html"><strong>How X
Window Managers Work, And How To Write One (Part II)</strong></a></p></div>
<div class="sidebarblock">
<div class="content">
<div class="title">Series Contents</div>
<div class="ulist"><ul>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html"><strong>Part I: Basic Concepts</strong></a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Part II: Introduction, Setup &amp; Teardown, Initialization, Event Loop</a>
</p>
</li>
<li>
<p>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-iii.html">Part III: Interaction with Application Windows</a>
</p>
</li>
</ul></div>
</div></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Apr 10, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html" rel="bookmark">
      The Most Popular Fonts On The Web: A Study
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-04-04T23:04:00-07:00">
          Apr 04, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="https://seasonofcode.com/tag/misc.html">Misc</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><link rel="image_src"
href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/embed/oimg?id=1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc&oid=65057078&zx=ey1naahah70j">
If you&#8217;ve ever worked on a web site, you already know that choosing the right
fonts is one of the most important aesthetic decisions in the design of a site.
But, like all aesthetic decisions, it is a highly subjective.</p></div>
<div class="paragraph"><p>I decided to try to bring a little bit of objectivity into the equation by
finding out, empirically, what fonts the most popular sites on the web are using
today.</p></div>
<div class="sect2">
<h3 id="_methodology">Methodology</h3>
<div class="paragraph"><p>I wrote a Python program that crawls the front page of the 100,000 most popular
web sites according to <a href="http://www.alexa.com/topsites">Alexa&#8217;s top sites list</a>.
It parses the HTML using
<a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>, and parses all
in-line and linked CSS stylesheets using <a href="http://cthedot.de/cssutils/">cssutils</a>.
It then looks for <code>font</code> and <code>font-family</code> rules in the CSS rules, and stores
the normalized form of each font in those rules in order. The result is kept in
a <a href="https://sqlite.org">SQLite</a> database for analysis.</p></div>
<div class="paragraph"><p>This all sounds pretty straightforward, but in fact it took me two weeks to
build a crawler that doesn&#8217;t choke on all the crazy crap people throw at
browsers. I will write up some of the more interesting cases in a separate post.</p></div>
<div class="paragraph"><p>The final crawl success rate was about 96%. The size of all HTML and stylesheets
downloaded was about 30GB.</p></div>
</div>
<div class="sect2">
<h3 id="_the_most_popular_first_choice_fonts">The Most Popular First-Choice Fonts</h3>
<div class="paragraph"><p>First, let&#8217;s take a look at the first-choice/most preferred fonts, i.e., the
ones that appear first in <code>font-family</code> rules. These fonts most closely
represent the intention of the web site designers without compatibility
compromises.</p></div>
<div class="paragraph"><p>For each font, we calculate the number of distinct web sites that have at least
one CSS <code>font</code> or <code>font-family</code> rule that lists the font as the first choice.
This means that if a site has two rules, one listing Arial and another
listing Times, it will count towards both. Thus, the numbers add up to much
higher than the total number of sites.</p></div>
<div class="paragraph"><p>Without further ado, here&#8217;s the breakdown of the top fonts on the web:
<div align="center"><iframe
height=620
style="max-width: 610px; width: 100%"
src="//docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=65057078"
seamless frameborder=0 scrolling=yes></iframe></div>
(The chart is interactive - hover/click to see actual numbers.)</p></div>
<div class="paragraph"><p>A couple of observations:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Sans-serif fonts dominate the web.</strong> The top 25 fonts list only includes 4
  serif fonts, compared to 16 sans-serif fonts. The most popular serif-font,
  Georgia, ranks #4 on the list with about 20% of sites.
</p>
</li>
<li>
<p>
<strong>Monospace fonts get no love.</strong> Most sites don&#8217;t bother
  specifying a custom monospace font; the most common monospace font
  specification just uses the browser default (12%). The most popular monospace
  font, Monaco, is featured on 7.2% of sites. Both of these are quite high, in
  fact, considering that we only crawl the front page of these sites.
</p>
</li>
<li>
<p>
<strong>The most popular fonts of each family:</strong>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Sans-serif:</strong> Arial (#1, 62%)
</p>
</li>
<li>
<p>
<strong>Serif:</strong> Georgia (#4, 20%)
</p>
</li>
<li>
<p>
<strong>Monospace:</strong> Monaco (#11, 7.2%)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Old Microsoft fonts still reign over the web.</strong> The top non-Microsoft font,
  Helvetica Neue, ranks #6 with an impressive 18% of top web sites.
</p>
</li>
<li>
<p>
<strong><a href="http://fortawesome.github.io/Font-Awesome/">Font Awesome</a> is awesome</strong>. About
  4.6% of the top 100K sites already use it for universal icons.
</p>
</li>
<li>
<p>
<strong>The Chinese web is on the rise.</strong> 3 out of the top 25 fonts are Chinese fonts,
  compared to 21 Latin fonts (and 1 symbol font). No other scripts made their
  way into the list.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_what_if_we_considered_8230">What If We Considered&#8230;</h4>
<div class="ulist"><ul>
<li>
<p>
<strong>Fonts in all positions</strong>: (<a href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=940843634">graph</a>) not much difference.
</p>
</li>
<li>
<p>
<strong>The top 1,000 web sites only</strong>: (<a href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=1208179553">graph</a>) even more Arial (#1, 74%).
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_most_popular_heading_fonts">The Most Popular Heading Fonts</h3>
<div class="paragraph"><p>Next, let&#8217;s look at first-choice fonts used in headings or titles.</p></div>
<div class="paragraph"><p>I used a really crude metric to determine whether a CSS rule matches a heading:
whether the CSS selector is for an <code>H1</code>&#8230;<code>H6</code> tag or contains the strings
"heading" or "title". While this finds only a subset of actual headings, it is
not a bad approximation as it matches rules on about 58% of the top 100,000
web sites.</p></div>
<div class="paragraph"><p>Let&#8217;s start with the graph:
<div align="center"><iframe
height=620
style="max-width: 610px; width: 100%"
src="//docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=1659247262"
seamless frameborder=0 scrolling=yes></iframe></div>
Observations:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Header fonts are more diverse.</strong> While Microsoft fonts still reign supreme, a
  number or more exotic fonts are also on the list. In terms of distribution,
  there&#8217;s a much longer tail. It may be a sign that designers pay a lot
  more attention to fonts used in headings.
</p>
</li>
<li>
<p>
<strong>Serif fonts are more popular in headings than elsewhere.</strong> While Arial still
  claims to top spot with 27.31% of sites, the top serif font, Georgia, rises to
  2nd place with 9% of sites.
</p>
</li>
<li>
<p>
<strong>No monospace fonts in headings.</strong> Not surprising.
</p>
</li>
<li>
<p>
Among Chinese fonts, <strong>ๅฎไฝ is more commonly used for body text, while ้้ป (or
  Yahei) is more commonly used for heading text.</strong>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_concluding_thoughts">Concluding Thoughts</h3>
<div class="paragraph"><p>Arial and friends are the <a href="http://screenfont.ca/fonts/today/interim/">most</a>
<a href="http://pxlnv.com/blog/guaahhhhhhh-come-on/">hated</a>
<a href="http://www.prepressure.com/fonts/interesting/most-hated">fonts</a>
<a href="http://enjoytherandom.com/hipster-hitler-hates-arial/">ever</a>. Quoting
<a href="http://www.marksimonson.com/notebook/view/the-scourge-of-arial">The Scourge of
Arial</a>:</p></div>
<div class="quoteblock">
<div class="content">Despite its pervasiveness, a professional designer would rarely - at least for
the moment - specify Arial.</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>And yet, Arial is still the default font on the vast majority of sites on
the web, followed closely by its friends. Why?</p></div>
<div class="paragraph"><p>Quoting <a href="http://www.64notes.com/design/stop-helvetica-arial/">Stop Using Arial &amp;
Helvetica</a>:</p></div>
<div class="quoteblock">
<div class="content">Some people actually have a reason to use them but most use it mindlessly - just
because everyone else does. Often, no thought is given to design of the site,
let alone typography.</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>This is pretty sad. Paraphrasing
<a href="http://www.dtelepathy.com/blog/graveyard/stop-using-lame-fonts">Stop Using Lame
Fonts</a>, a good font stack has the potential to really make a site design shine,
and it&#8217;s a shame web designers aren&#8217;t exploiting this opportunity.</p></div>
</div>
<div class="sect2">
<h3 id="_caveats">Caveats</h3>
<div class="paragraph"><p>There are a couple of caveats with this dataset.</p></div>
<div class="paragraph"><p>First, I am only surveying the landing page of each site. For many sites,
notably those whose main interface is hidden behind a login (Facebook, Evernote,
etc.), we may not be finding the styles that matter most to users. However, I
figured since it would be pretty poor design to build a landing page that is
aesthetically inconsistent with the rest of the site, it is not very likely that
the font selection on the landing page would be too different from the fonts
used elsewhere on the site. Of course, without creating fake accounts on these sites,
we have no way to verify.</p></div>
<div class="paragraph"><p>The numbers are not weighted by prominence on the web pages. One could argue
that the font of the main body text on a page should carry more weight than that
of the tiny disclaimer text at the bottom which no one reads. It would be tricky
to determine what the right weight function is though.</p></div>
<div class="paragraph"><p>The numbers are not weighted by the prominence of the web sites. For example, we
could make it so that Google&#8217;s use of Arial would get more weight than some
random obscure site&#8217;s use of Arial, as Google&#8217;s choice impacts many more users
and was probably the result of deliberation by a team of expert designers.
Again, it&#8217;s not entirely obvious how the weights should be assigned.</p></div>
<div class="paragraph"><p>I am only looking at CSS rules in <code>&lt;style&gt;</code> tags or linked stylesheets. That
means I am ignoring <code>style="&#8230;"</code> attributes in tags, <code>&lt;font&gt;</code> elements, or
dynamically assigned fonts (i.e., through JavaScript). I would be surprised if
this turns out to be a big loss though.</p></div>
</div>
<div class="sect2">
<h3 id="_next_steps">Next Steps</h3>
<div class="paragraph"><p>I can think of quite a few other useful questions one might find the answer to
from this dataset:</p></div>
<div class="ulist"><ul>
<li>
<p>
What are the most common font pairings?
</p>
</li>
<li>
<p>
What are the popular choices for heading fonts, given that I&#8217;ve chosen font X
  as my body text font?
</p>
</li>
<li>
<p>
What are the most common fonts on news sites/forums/productivity web
  apps/social media sites?
</p>
</li>
<li>
<p>
Is there any correlation between font choice and site popularity?
</p>
</li>
</ul></div>
<div class="paragraph"><p>What do you think?</p></div>
<div class="paragraph"><p>Please feel free to <a href="https://www.mediafire.com/?xqrk731716v078l">download</a> the top
100 first-choice fonts as a CSV file.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Apr 04, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="https://seasonofcode.com/tag/misc.html">Misc</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html" rel="bookmark">
      Disabling Screen-Off Animation In Android
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2013-02-02T02:41:49-08:00">
          Feb 02, 2013
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I am impressed by the amazing progress Android&#8217;s UI has made since its
inception. With each iteration, likewise in software as in hardware, its
usability and aesthetics have steadily improved to the point where I can now
confidently buy one for my mom to replace the iPhone I recommended to her only
last year.</p></div>
<div class="paragraph"><p>On the other hand, one particular "feature" I intensely dislike is the
screen-off animation that emulates the brief white flash you see when an old CRT
TV monitor is powering off. Introduced in Gingerbread (2.3), it seems not to
bother most people as much as it bothers me, and even seems to be quite popular
(e.g., <a href="http://forum.xda-developers.com/showthread.php?t=1890526">this thread</a>).</p></div>
<div class="paragraph"><p>I was glad to learn though that a number of people find it as annoying as I do,
for example in
<a href="http://forum.cyanogenmod.org/topic/64185-any-way-to-disable-the-screen-off-animation-in-101/">this thread</a>
and <a href="http://code.google.com/p/cyanogenmod/issues/detail?id=6519">this bug</a>.</p></div>
<div class="paragraph"><p>As a CyanogenMod fan, I was quite happy with the straightforward checkbox in the
Settings app in CyanogenMod 9 that toggled whether to play this animation. In
CM10, this option was removed, but there was an easy hack involving changing
window animation scale in the developer settings, as explained in the
<a href="http://code.google.com/p/cyanogenmod/issues/detail?id=6519">second link above</a>.</p></div>
<div class="paragraph"><p>So when I updated to CM10.1 M1, I was very unpleasantly surprised to find that
this hack does not work any more either. I tried to immediately downgrade to
CM10, but then discovered that doing so requires a full data wipe (of
course&#8230;). A quick search pulled up
<a href="http://forum.xda-developers.com/showthread.php?t=1989397">this thread</a> which
proposes a simple prop edit, but the following posts in the thread suggest mixed
results.</p></div>
<div class="paragraph"><p>So, stuck with CM10.1, and really disgusted at this turn of events, I finally
decided to put on my hax0r gloves and get this annoying "feature" out of my face
once and for all.</p></div>
<div class="paragraph"><p><strong>Poking Around</strong></p></div>
<div class="paragraph"><p>I went to <a href="http://androidxref.com/">androidxref.com</a> and started searching
the Android source code for "screen off animation". (OK, I actually started out
with <em>grep</em>, but it didn&#8217;t take me long to realize
<a href="http://androidxref.com/">androidxref.com</a> was about sixty million times
faster - it&#8217;s really pretty cool.)</p></div>
<div class="paragraph"><p>I quickly found why changing the window animation scale in <strong>Jelly Bean 4.1 (and
CM10)</strong> disables the screen-off animation. The two snippets of of code
implementing this behavior are at
<a href="http://androidxref.com/4.0.4/xref/frameworks/base/services/java/com/android/server/PowerManagerService.java#470">line 470</a> and
<a href="http://androidxref.com/4.0.4/xref/frameworks/base/services/java/com/android/server/PowerManagerService.java#2228">line 2228</a>
of <code>PowerManagerService.java</code>.</p></div>
<div class="paragraph"><p>In <strong>Jelly Bean 4.2 (and CM10.1)</strong>, however, these parts of the code have been
completely refactored. The snippet of code that launches the screen-off
animation is now found at
<a href="http://androidxref.com/4.2_r1/xref/frameworks/base/services/java/com/android/server/power/DisplayPowerController.java#704">line 704</a>
of <code>DisplayPowerController.java</code>. Note that this new <code>DisplayPowerController</code>
class has been factored out of the old <code>PowerManagerService</code> class, and both
have moved into a separate <code>power</code> sub-directory.</p></div>
<div class="paragraph"><p><strong>The Hacking</strong></p></div>
<div class="paragraph"><p><em>Disclaimer: I am <strong>NOT</strong> responsible for anything that happens to your phone or
you or your house or your relationship with your wife if you follow the
instructions down here. If you don&#8217;t know what you&#8217;re doing and are scared of
bricking your phone, just give up and go watch Superbowl. Please.</em></p></div>
<div class="paragraph"><p>What did <em>not</em> change, I found, is that this code gets packaged into
<code>/system/framework/services.jar</code> on the Android system. So, let&#8217;s take a look at
this file as found in the CM10.1 image on my phone:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Copy services.jar from phone to current directory.</span>
adb pull /system/framework/services.jar
<span class="c"># Disassemble.</span>
apktool d services.jar
</pre></div></div></div>
<div class="paragraph"><p>(<code><a href="http://code.google.com/p/android-apktool/">apktool</a></code> is a tool that
extracts and disassembles Android APK/JAR files, and is available for Linux,
Windows and OS X.) This produces a directory, <code>services.jar.out</code>, which contains
the disassembled code of <code>services.jar</code> we just pulled from a connected phone. I
dived into the <code>DisplayPowerController</code> code and edited the <em>else</em> clause at
<a href="http://androidxref.com/4.2_r1/xref/frameworks/base/services/java/com/android/server/power/DisplayPowerController.java#704">line 704</a>
to essentially just say <code>setScreenOn(false);</code> directly instead of running
the animation first. If you look at the dissassembled code, you&#8217;d realize Dalvik
bytecode is really quite readable and easy to hack, especially since the line
number hints allow you to directly map a line in the Java source code to the
corresponding Dalvik instructions. I just had the Java source file on
<a href="http://androidxref.com">androidxref.com</a> open in a browser tab for reference
and killed instructions line by line. You can
<a href="http://www.mediafire.com/?5e8s5kzblav4a5g">download my patch here</a> and apply
it like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>patch -d services.jar.out -Np1 &lt; path/to/disable_screen_off_animation.patch
</pre></div></div></div>
<div class="paragraph"><p>(For CM10.1 nightlies (after the MR1.1 merge) and CM10.1 M2, use
<a href="http://www.mediafire.com/download.php?drw5t67v24tb4x9">this patch</a> instead.
The same piece of code was shuffled around to
<a href="https://github.com/CyanogenMod/android_frameworks_base/blob/f6f6b1d37c1d5a8ba687e4d09761eb762f7269af/services/java/com/android/server/power/DisplayPowerController.java#L777">line 777</a>. For CM10.1 M3, use
<a href="http://www.mediafire.com/download.php?3xghfg9yfqyj9o7">this patch</a> instead.)</p></div>
<div class="paragraph"><p>Now re-assemble the code and push it back on to the device:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Re-assemble modified sources as services-mod.jar.</span>
apktool b services.jar.out services-mod.jar
<span class="c"># Copy services-mod.jar to /sdcard/ on phone.</span>
adb push services-mod.jar /sdcard/
<span class="c"># Remount /system partition as read-write in order to modify it.</span>
adb shell su -c <span class="s1">&#39;mount -o rw,remount /system&#39;</span>
<span class="c"># Overwrite original services.jar on phone with services-mod.jar as root.</span>
adb shell su -c <span class="s1">&#39;cp /sdcard/services-mod.jar /system/framework/services.jar&#39;</span>
<span class="c"># Reboot phone for this to take effect.</span>
adb reboot
</pre></div></div></div>
<div class="paragraph"><p>When the phone reboots, it will say Android is upgrading and will rebuild Dalvik
cache for each application, so it might take a while. But hey, it&#8217;s worth it.</p></div>
<div class="paragraph"><p><strong>Parting Words</strong></p></div>
<div class="paragraph"><p>The final product, if you just want to replace the <code>services.jar</code> on your phone, is here:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>CyanogenMod 10.1 M1</strong> - tested on Galaxy Nexus (maguro) and Nexus S (crespo), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?16dhrvk7esr77br">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 M2</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?kdd4af6h81bq8">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 M3</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?78cvqi6qe0s3yoy">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 RC1</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?w1527lnv5eoh8kl">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Stock 4.2.2 (takju/JDQ39)</strong> - for <a href="https://developers.google.com/android/nexus/images#takjujdq39">"takju" factory image from Google</a>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Note</strong>: use this to replace <code>services.<strong>odex</strong></code>, not <code>services.<strong>jar</strong></code>!
</p>
</li>
<li>
<p>
<a href="http://www.mediafire.com/?g5guv4hkcvt9owm">services-mod.odex</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Stock 4.2.2 (yakju/JDQ39)</strong> - for <a href="https://developers.google.com/android/nexus/images#yakjujdq39">"yakju" factory image from Google</a>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Note</strong>: use this to replace <code>services.<strong>odex</strong></code>, not <code>services.<strong>jar</strong></code>!
</p>
</li>
<li>
<p>
<a href="http://www.mediafire.com/?8ttffv118tnxgp5">services-mod.odex</a>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Apply the <code>services-mod.jar</code> to your phone like this (obviously assuming you
have adb working and root):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Copy services-mod.jar to /sdcard/ on phone.</span>
adb push services-mod.jar /sdcard/
<span class="c"># Remount /system partition as read-write in order to modify it.</span>
adb shell su -c <span class="s1">&#39;mount -o rw,remount /system&#39;</span>
<span class="c"># Overwrite original services.jar on phone with services-mod.jar as root.</span>
adb shell su -c <span class="s1">&#39;cp /sdcard/services-mod.jar /system/framework/services.jar&#39;</span>
<span class="c"># Reboot phone for this to take effect.</span>
adb reboot
</pre></div></div></div>
<div class="paragraph"><p>Or, I suppose, you could just use ES File Explorer with root mode enabled, mount
<code>/system</code> as read-write and copy the file to <code>/system/framework/services.jar</code> on
the phone.</p></div>
<div class="paragraph"><p>Note that a reboot is needed after you replace the <code>services.jar</code> whatever you
do, and upon the first reboot the "Android is upgrading" dialog will pop up.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 02, 2013
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/android-rooting-a-developers-guide.html" rel="bookmark">
      Android Rooting: A Developer's Guide
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2012-11-21T00:58:12-08:00">
          Nov 21, 2012
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/android-rooting-a-developers-guide.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><img src="/assets/files/rooting_android_blue.jpg"
align="right"
style="max-width: 350px; width: 35%; margin: 1.5em 0 1.5em 1.5em;">
First things first&#8201;&#8212;&#8201;this is not about how to apply a rooting method, e.g., a
one-click-root, to an Android device. Rather, it is about how one could go about
<em>developing</em> a rooting method for a device that no one has rooted before, and is
told through my experiences with rooting a particular device&#8201;&#8212;&#8201;the Barnes &amp;
Noble Nook Tablet 8GB. For context, you can read my original thread
"<a href="http://forum.xda-developers.com/showthread.php?t=1529553">Root for Nook
Tablet 8GB (w/ Android Market)</a> on XDA-Developers where I published my rooting
method, which has reached a download count of&#8201;&#8212;&#8201;wait for it&#8201;&#8212;&#8201;OVER NINE
THOUSAND!!!</p></div>
<div class="paragraph"><p>For an overview of how rooting works behind the scenes, you may want to read my
previous article
<a href="/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html">How
Rooting Works - A Technical Explanation of the Android Rooting Process</a> as
background.</p></div>
<div class="paragraph"><p>Sometime in late February (2012), on a visit to to a Barnes &amp; Noble store in
Boston, I bought the then freshly released Nook Tablet 8GB entirely on impulse
for $199. Being the hax0r that I am, the first thing I did when I got home was
to try to root the device. It came as a nasty surprise, therefore, when I
discovered that no one had yet succeeded in rooting the device. All I could find
was a <a href="http://www.youtube.com/watch?v=x8e0OLWQYc4">YouTube video</a> showing
that the existing rooting method for its cousin, the Nook Tablet 16GB, did not
work. After waiting for a few days, the absolutely pathetic app store and
handicaps instituted by B&amp;N finally motivated me to develop a rooting method for
the device myself.</p></div>
<div class="sect2">
<h3 id="_the_plan">The Plan</h3>
<div class="paragraph"><p>So, how do you go about rooting an Android device? As I explain in
<a href="/posts/how-rooting-works-a-technical-explanation-of-the-android-rooting-process.html">my
previous article</a>, rooting is basically a two-step process:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Find exploit that allows execution of arbitrary code as root
</p>
</li>
<li>
<p>
Use exploit to install <code>su</code> (with SUID bit set) and <code>Superuser.apk</code> as root
</p>
</li>
</ol></div>
<div class="paragraph"><p>After <code>su</code> and <code>Superuser.apk</code> are installed correctly, apps that require root
(such as <a href="http://matrixrewriter.com/android/">Titanium Backup</a> or
<a href="https://play.google.com/store/apps/details?id=org.adaway&amp;hl=en">AdAway</a>)
will invoke <code>su</code> to run code as the privileged user.</p></div>
</div>
<div class="sect2">
<h3 id="_the_process">The Process</h3>
<div class="paragraph"><p>There are many generic or device-specific exploits that a hax0r may leverage to
achieve privileged execution of arbitrary code. I would again refer you to
<a href="http://jon.oberheide.org/files/bsides11-dontrootrobots.pdf">this excellent
presentation on various Android root exploits</a> that have been or may still be
used for this purpose.</p></div>
<div class="paragraph"><p>However, none of these methods that I knew of could work on the Nook Tablet,
which is probably one of the most locked-down Android ROMs out there:</p></div>
<div class="ulist"><ul>
<li>
<p>
Bootloader is locked.
</p>
</li>
<li>
<p>
ADB is disabled, and cannot be enabled from the UI.
</p>
</li>
<li>
<p>
Installing non-market apps (raw APKs) is disabled, and cannot be enabled from the UI.
</p>
</li>
<li>
<p>
No access to Google Play / Android Market (or any Google Apps).
</p>
</li>
</ul></div>
<div class="paragraph"><p>This rules out 1) root APKs and 2) the majority of exploits out there that
require executing commands over ADB. It means that one cannot run any code on
the device that does not come from B&amp;N period.</p></div>
<div class="paragraph"><p>But of course there was another way in. Somebody on XDA-Developers had
discovered that the bootloader of the Nook Tablet supported booting off an
Android system located in partition images stored on an external microSD card.
This mechanism is probably used to repair corrupted system partitions by B&amp;N
customer support.</p></div>
<div class="paragraph"><p>The solution, then, is clear: we create dummy system partition images that,
instead of booting an Android system, installs <code>su</code> and <code>Superuser.apk</code> into the
"normal" Android system in internal flash memory. More concretely, I modified
the system initialization file inside the initrd inside the boot partition image
to invoke a custom script that copied the relevant files into the <code>system</code>
partition in the internal flash memory.</p></div>
<div class="paragraph"><p>I based my work on
<a href="http://forum.xda-developers.com/showthread.php?t=1517513">bauwks&#8217;s 2nduboot
images</a> and used <a href="https://gitorious.org/ac100/abootimg">abootimg</a> to unpack
files in the boot partition image <code>boot.img</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Extracts files in the boot partition image into the current directory.</span>
abootimg -x ./boot.img
<span class="c"># Extract files in the initrd cpio archive into the folder ./ramdisk/</span>
aboot-unpack-initrd ./initrd.img
</pre></div></div></div>
<div class="paragraph"><p>I changed the system initialization file <code>init.omap4430.rc</code> in the initrd to
mount the system partition of the internal flash memory at <code>/foo</code> rather than
<code>/system</code>, because later system initialization steps attempt to remount
<code>/system</code> as read-only and so on, and for some reason I could not disable that
behavior:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>on fs
    mkdir /foo
    mount ext4 /dev/block/platform/mmci-omap-hs.1/by-name/system /foo wait</code></pre>
</div></div>
<div class="paragraph"><p>I added the following to the system initialization file <code>init.rc</code> in the initrd to start my rooting script:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>service root_script /sbin/busybox ash /assets/run.sh
    oneshot</code></pre>
</div></div>
<div class="paragraph"><p>My rooting script, which I place in the directory <code>assets</code> in the initrd,
installs not only <code>su</code>, but also Google Play and other Google apps which are
missing from the Nook Tablet ROM:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Install su and Superuser.apk</span>
/sbin/busybox cp /assets/su /foo/bin/
/sbin/busybox cp /assets/su /foo/xbin/
/sbin/busybox chmod <span class="m">06755</span> /foo/xbin/su
/sbin/busybox chmod <span class="m">06755</span> /foo/bin/su
/sbin/busybox cp /assets/Superuser.apk /foo/app/

<span class="c"># Install Busybox.</span>
/sbin/busybox cp /sbin/busybox /foo/xbin/
/sbin/busybox chmod <span class="m">06755</span> /foo/xbin/busybox

<span class="c"># Install Google Play and other Google apps.</span>
/sbin/busybox cp /assets/*.apk /foo/app/
/sbin/busybox cp /assets/com.google.android.maps..xml /foo/etc/permissions/
/sbin/busybox cp /assets/com.google.android.maps.jar /foo/framework/
/sbin/busybox cp /assets/libvoicesearch.so /foo/lib/

<span class="c"># Done.</span>
/sbin/busybox mount -o ro,remount /foo
</pre></div></div></div>
<div class="paragraph"><p>In accordance with the above script, I had placed all assets in the <code>assets</code>
directory inside the initrd, and the Busybox binary in <code>sbin</code> inside the initrd.
With all changes done, I pack everything back into a new boot.img:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Build initrd cpio archive</span>
abootimg-pack-initrd initrd.img.new
<span class="c"># Build new boot.img using previously extracted components</span>
abootimg --create boot.img.new -f ./bootimg.cfg -k ./zImage -r ./initrd.img.new
</pre></div></div></div>
<div class="paragraph"><p>Then I replace the <code>boot.img</code> on the SD card image with my <code>boot.img.new</code>, and
the rooting method is done.</p></div>
</div>
<div class="sect2">
<h3 id="_final_words">Final words</h3>
<div class="paragraph"><p>The actual process, of course, was much, much more painful. The Nook Tablet&#8217;s
bootloader is very picky; some microSD cards just won&#8217;t work, there is a file
size limit on <code>boot.img</code>, etc.. It was also after much frustration that I
discovered the mount-to-<code>/foo</code> trick. And I could not even keep track of how
many factory restores I had to perform on the device to undo bad modifications.
But it was still a lot of fun, and the euphoria at the end and the feeling of
accomplishment when reply posts started rolling in and random people were
donating $5 as a token of their appreciation could not be overstated.</p></div>
<div class="paragraph"><p>Good luck rooting!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 21, 2012
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/android-rooting-a-developers-guide.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/android-rooting-a-developers-guide.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html" rel="bookmark">
      Carrier programming on CDMA Android phones
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2012-11-15T23:57:36-08:00">
          Nov 15, 2012
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Have you ever wondered how CDMA phones are programmed to a specific carrier for
voice calls, SMS and data?</p></div>
<div class="paragraph"><p>In the U.S., all major CDMA carriers operate on the same frequencies, which
means that there is no inherent difference in hardware between phones sold by
any of them, and that theoretically there is no reason why a Verizon Wireless
phone cannot work on Sprint or MetroPCS or Virgin Mobile or Boost Mobile, for
example. Unlike GSM phones with swappable SIM&#8217;s, however, a CDMA phone sold in
the U.S. is typically locked to a particular carrier; so how is that done?</p></div>
<div class="paragraph"><p>I was recently able to figure out the answer to this question when I
successfully flashed a CDMA phone from Sprint to Verizon (an exploit documented
in <a href="/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html">Flashing a Sprint
Nexus S 4G to Verizon</a>). As I have not been able to find a compilation of this
information elsewhere, I am writing up this document in the hope that it will
help others with flashing phones or porting ROMs to different carriers.</p></div>
<div class="paragraph"><p>Note that this information is based on my research with the Jelly Bean (4.1 &amp;
4.2), ICS (4.0) and Gingerbread (2.3.4) versions of Android and two major U.S.
CDMA carriers, Verizon Wireless and Sprint. Hence, it may not be applicable to
other phones or carriers; in particular, the section about CDMA chips do not
apply to CDMA phones that require a SIM card, such as some Verizon Wireless LTE
phones. In such cases, your comments and insights are welcome.</p></div>
<div class="paragraph"><p>Finally, a disclaimer: I have no formal understanding of any of the intricacies
of CDMA technology and therefore cannot guarantee the correctness or accuracy of
this information. Use it at your own risk. I cannot be held responsible for any
damage or legal consequences resulting from or related to the application of
this information.</p></div>
<div class="paragraph"><p>At a high level, there are two places where carrier information is stored on a
CDMA Android phone: inside the CDMA chip (radio), and in Android OS system
files.</p></div>
<div class="sect2">
<h3 id="_programming_the_cdma_chip">Programming the CDMA chip</h3>
<div class="paragraph"><p>Every CDMA phone (obviously) has a CDMA chip (radio). This chip is responsible
for carrying out voice calls and transferring data over 2G/3G, and in order to
do that, it needs to know stuff like what phone number it represents, what
towers to connect to, what account name to bill the 3G connection to, etc.. All
of this information is stored directly inside the chip (unless you have a
Verizon Wireless LTE phone with a SIM card), and not on any file system
controlled by the OS; this is why even after a factory reset (which formats the
internal flash file system) these settings persist. It is (I believe) not
possible to change the information stored on the CDMA chip from the OS itself;
instead, carriers provide a special number (e.g., *228 for Verizon Wireless)
that, when called, will transfer the information to the chip. This is typically
called "programming" the phone by U.S. carriers.</p></div>
<div class="paragraph"><p>So what information exactly is stored inside the CDMA chip? Here&#8217;s an incomplete
list:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>MEID</strong>: Unique serial number of the phone. This is like the MAC address of an
  ethernet / WiFi card in that it is the sole identifier of the CDMA chip. It is
  what carriers use to connect phone calls, deliver SMS&#8217;s, blacklist stolen
  phones, etc.. A fatal flaw, however, is that it is actually possible to modify
  (flash) the MEID of many, but not all, CDMA chips. If you flash the MEID of
  phone A onto phone B, the carrier network has no way of distinguishing between
  phone A and phone B, and phone B is able to make and receive calls, send and
  receive messages etc. as phone A. Unsurprisingly, this is illegal in many
  countries, including the U.S., and as such I will not discuss it here.
</p>
</li>
<li>
<p>
<strong>Phone / account numbers</strong>: known as MDN and MIN, these store the phone and
  account numbers associated with the phone.
</p>
</li>
<li>
<p>
<strong>2G/3G data account information</strong>: user names and passwords used to connect to
  data services. Some carriers have stronger (harder to impersonate)
  authentication systems than others; for instance, Verizon Wireless requires
  two encrypted passwords and a secret key in the EFS file system on the CDMA
  chip; Boost Mobile only requires two passwords; while MetroPCS simply accepts
  the SPC/MSL code (see below) as the password. Note that 2G and 3G are
  unrelated systems with independent authentication; a phone can have valid 3G
  credentials and thus connect to 3G while being denied a 2G connection.
</p>
</li>
<li>
<p>
<strong>PRL (Preferred Roaming List)</strong>: a list of towers the phone can connect to. This
  is of course carrier- and location-specific. In some cases, updating the PRL
  (by calling a special number) can improve reception and save battery when the
  phone moves to a new geographical area; see
  <a href="http://www.verizonwireless.com/care/popups/prl.html">Verizon Wireless&#8217;s
  explanation</a>, for example.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Software such as CDMA Workshop, DFS, QXDM/QPST can be used to read / write
information stored on a CDMA chip from a computer. Often, however, a 6-digit
passcode known as the SPC code or the MSL code is required. This SPC/MSL code,
again stored inside the CDMA chip, is either randomly assigned by the carrier
(this is the case for Verizon Wireless and Sprint) or deterministically computed
based on the MEID (MetroPCS). In the former case, there are a variety of tricks
for retrieving the SPC/MSL code from the phone itself,; Google is your friend
there. In the latter case, there are sites for computing the code from the MEID.
Once it is known, the SPC/MSL code can be changed to any 6-digit number; some
phones may even allow you to overwrite the SPC/MSL code without knowing it
first.</p></div>
</div>
<div class="sect2">
<h3 id="_carrier_configuration_in_the_android_os">Carrier configuration in the Android OS</h3>
<div class="paragraph"><p>To figure out what system files in the Android OS contain carrier information, I
inspected source code and images of ROMS for the Samsung Galaxy Nexus (Sprint
and Verizon Wireless), the Samsung Nexus S 4G (Sprint), the HTC Incredible
(Verizon Wireless), and the Motorola Droid 3 (Verizon Wireless). I found three
places that store carrier-specific information.</p></div>
<div class="paragraph"><p>The first is <code>/system/build.prop</code>. Sprint phones contain the following lines:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310120
ro.cdma.home.operator.alpha=Sprint</code></pre>
</div></div>
<div class="paragraph"><p>while Verizon Wireless phones contain the following lines instead:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>ro.cdma.home.operator.numeric=310004
ro.cdma.home.operator.alpha=Verizon
ro.cdma.homesystem=64,65,76,77,78,79,80,81,82,83</code></pre>
</div></div>
<div class="paragraph"><p>These settings apply to phone calls. If one adopts the Sprint configuration on a
Verizon Wireless phone, for example, the phone would ring very briefly on a
call, but would be unable to actually make or receive calls. The
<code>ro.cdma.homesystem</code> specifies a list of indices into the PRL that represent
"home" or non-roaming networks.</p></div>
<div class="paragraph"><p>The second configuration file is <code>eri.xml</code>, which is compiled into the file
<code>/res/xml/eri.xml</code> inside the system package
<code>/system/framework/framework-res.apk</code> on an Android system. This file tells the
OS what it needs to display about a particular network (as an index into the
PRL); for an example, take a look at
<a href="https://android.googlesource.com/device/samsung/toroplus/<code>/refs/tags/android-4.2_r1/overlay/frameworks/base/core/res/res/xml/eri.xml">the
stock eri.xml for the Sprint Galaxy Nexus</a> or
<a href="https://github.com/CyanogenMod/android_device_samsung_toro/blob/ics/overlay/frameworks/base/core/res/res/xml/eri.xml">the
CyanogenMod eri.xml for the Verizon Wireless Galaxy Nexus</a>. In particular,
this file instructs the OS whether to consider a network (tower) to be roaming
(so whether a roaming icon is displayed), and gives the name of the network
(tower) to be shown in the UI. It must be stressed that this file <em>has no
functional effect</em>; all it changes is how the OS displays information about
networks. Since APK packages are just ZIP archives, it is easy to replace the
+eri.xml</code> within to change roaming and name settings for networks; note,
however, that the file inside the APK is not a plain text XML, but some compiled
binary form; you may need to Google for the appropriate binary form pulled from
another phone.</p></div>
<div class="paragraph"><p>The last configuration file is <code>/system/etc/apns-conf.xml</code>. This file contains
APN settings for 4G and MMS. See the stock APN settings file for the
<a href="https://android.googlesource.com/device/samsung/crespo4g/+/refs/heads/jb-release/4g-apns-conf.xml">Sprint
Nexus S 4G</a> or the
<a href="https://github.com/CyanogenMod/android_vendor_cm/blob/ics/prebuilt/common/etc/apns-conf-cdma.xml">default
CyanogenMod APN settings</a>.</p></div>
</div>
<div class="sect2">
<h3 id="_step_by_step_guide">Step-by-step guide</h3>
<div class="paragraph"><p>If you&#8217;re interested in learning more about how exactly this works, you&#8217;re
welcome to take a look at my follow-up article
<a href="/posts/flashing-a-sprint-nexus-s-4g-to-verizon.html">Flashing a Sprint Nexus
S 4G to Verizon</a>, which documents the process of flashing an actual phone.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 15, 2012
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/carrier-programming-on-cdma-android-phones.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/tag/featured.html">&larr; Previous</a></li>
    <li class="next"><a href="https://seasonofcode.com/tag/featured3.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>