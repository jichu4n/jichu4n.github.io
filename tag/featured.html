<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code - Featured</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <link href="http://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="http://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="http://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="http://seasonofcode.com/theme/style.min.css?ddff292a" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="http://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="http://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="http://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="http://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="http://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="http://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="http://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="http://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="http://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="http://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="http://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="http://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="http://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html" rel="bookmark">
      Custom Domain E-mails With Postfix and Gmail: The Missing Tutorial
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-11-06T16:50:00-08:00">
          Nov 06, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="http://seasonofcode.com/tag/misc.html">Misc</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Custom domain e-mail addresses, like <code>john@johnscompany.com</code>, are cool and
professional-looking. Would <em>you</em> want to e-mail potential clients as
<code>john123@gmail.com</code>?</p></div>
<div class="paragraph"><p>On the other hand, Gmail has great reliability, speed, spam filtration, and app
support. Wouldn&#8217;t it be great if we could send and receive e-mail as
<code>john@johnscompany.com</code>, but right from the comfort of our Gmail account?</p></div>
<div class="paragraph"><p>Today, if we want to <strong>use Gmail to send and receive e-mails on a custom domain</strong>,
we have a couple of options:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong><a href="http://www.google.com/work/apps/business/">Google Apps for Work</a></strong> is Google&#8217;s
  own offering. It&#8217;s simple to set up and manage, but it&#8217;s pretty pricey at
  $5/mo per user, especially if we don&#8217;t need the bundled collaborative
  features like Google Docs and Calendar.
</p>
</li>
<li>
<p>
<strong>Third-party services</strong> could get the job done at a
  lower price point; for example, <a href="https://pobox.com/">Pobox</a> offers plans
  starting at $20/yr. The downside is that we will have to trust another
  organization with our e-mail.
</p>
</li>
<li>
<p>
<strong>Set up our own e-mail forwarding server</strong>. It&#8217;s fairly easy (if we
  follow this guide :) and if we already have shared / dedicated hosting or a
  VPS, this is basically free and gives us total control over our e-mail.
</p>
</li>
</ul></div>
<div class="paragraph"><p>If you want to host <strong>custom domain e-mails in Gmail without paying for Google
Apps</strong> or a third-party service, this tutorial is for you. It will show you how
to quickly set up you own e-mail forwarding / relay server, and how to integrate
it seamlessly with Gmail.</p></div>
<div class="sect2">
<h3 id="_prerequisites">Prerequisites</h3>
<div class="paragraph"><p>For this tutorial, we&#8217;ll assume we have access to:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>VPS or shared / dedicated hosting</strong>, with a dedicated IP address and capable
  of listening on ports 25 and 587. We will use a Ubuntu server for
  the examples.
</p>
</li>
<li>
<p>
<strong>DNS records for our domain</strong>. How DNS records are manipulated depends on the
  DNS hosting provider (or DNS server configuration).
</p>
</li>
</ul></div>
<div class="paragraph"><p>We&#8217;ll assume</p></div>
<div class="ulist"><ul>
<li>
<p>
We have a domain <code>example.com</code>;
</p>
</li>
<li>
<p>
We have a server <code>myserver.example.com</code>;
</p>
</li>
<li>
<p>
We want to use the Gmail account <code>john123@gmail.com</code> to manage
  <code>john@example.com</code>.
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_step_1_dns_setup">Step 1: DNS Setup</h3>
<div class="paragraph"><p>The first step in setting up our e-mail forwarding server is to add MX, PTR and
<a href="http://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> DNS records for our
server. This is really important as many e-mail providers, in order to prevent
spam, will refuse to talk to mail servers without proper MX, PTR and SPF records
set up. How to update DNS records will depend on the DNS hosting provider.</p></div>
<div class="paragraph"><p>The following is what we need:</p></div>
<div class="ulist"><ul>
<li>
<p>
An <strong>MX</strong> record for <code>example.com</code>, pointing to <code>myserver.example.com</code>.
</p>
<div class="paragraph"><p>This tells the world that e-mails to <code>&lt;whatever&gt;@example.com</code> should be
delivered to the server <code>myserver.example.com</code>.</p></div>
</li>
<li>
<p>
An <strong>A</strong> record for <code>myserver.example.com</code>, pointing to the IP address of our
  server.
</p>
</li>
<li>
<p>
A <strong>PTR</strong> (reverse DNS) record mapping the IP address of our server to
  <code>myserver.example.com</code>.
</p>
<div class="paragraph"><p>This allows Gmail to verify the legitimacy of our server via its IP when Gmail
receives a forwarded e-mail from it.</p></div>
</li>
<li>
<p>
A <strong>TXT</strong> record, with key <code>example.com</code> and value <code>v=spf1 mx ~all</code>.
</p>
<div class="paragraph"><p>This is an <a href="http://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> record; it
tells Gmail that the servers specified in the MX records of <code>example.com</code>, in
this case only <code>myserver.example.com</code>, are allowed to send e-mails purporting to
be from <code>&lt;whatever&gt;@example.com</code>. All other servers attempting to do the same
will be rejected. This should be a sane default value, but feel free to custom
it as you like.</p></div>
</li>
</ul></div>
<div class="paragraph"><p>DNS records will take a while (depending on our provider, up to a day) to
propagate. Until they do, e-mails forwarded by our new e-mail server may get
marked as spam or rejected outright.</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_receiving_e_mail">Step 2: Receiving E-mail</h3>
<div class="paragraph"><p>We&#8217;ll first set up an e-mail forwarding server which will let we receive e-mails
sent to our domains.</p></div>
<div class="paragraph"><p>We will use <a href="http://www.postfix.org">Postfix</a> as the e-mail server. Let&#8217;s start by
installing the necessary packages. We will assume a Ubuntu server in the
examples below; if you&#8217;re using a different distribution, please consult your
distribution&#8217;s documentation for the right commands.</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ sudo DEBIAN_FRONTEND=noninteractive apt-get install postfix</code></pre>
</div></div>
<div class="paragraph"><p>In the above command, we skip the <code>debconf</code> configuration UI with
<code>DEBIAN_FRONTEND=noninteractive</code> as we will edit the configuration files
directly.</p></div>
<div class="sect3">
<h4 id="_etc_postfix_main_cf">/etc/postfix/main.cf</h4>
<div class="paragraph"><p>Open up <code>/etc/postfix/main.cf</code> in your favorite editor. This file will come
pre-populated with a bunch of config options and comments.  Replace the contents
of the file with the following (you can comment out the original contents for
reference):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># /etc/postfix/main.cf</span>

<span class="c"># Host and site name.</span>
<span class="n">myhostname</span> <span class="o">=</span> <span class="n">myserver</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">mydomain</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">myorigin</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>

<span class="c"># Virtual aliases.</span>
<span class="n">virtual_alias_domains</span> <span class="o">=</span> <span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">virtual_alias_maps</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">virtual</span>
</pre></div></div></div>
<div class="paragraph"><p>The first few lines are pretty straightforward; they tell Postfix how to
identify itself to the world. The last two lines tell Postfix to forward e-mails
sent to <code>&lt;whatever&gt;@example.com</code> to another e-mail provider (Gmail), and that the
forwarding is configured in the database file <code>/etc/postfix/virtual</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_etc_postfix_virtual">/etc/postfix/virtual</h4>
<div class="paragraph"><p>Let&#8217;s now open up <code>/etc/postfix/virtual</code> and fill in our forwarding
configuration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># /etc/postfix/virtual</span>

<span class="c"># Forwarding mapping, one from-to address pair per line. The format is:</span>
<span class="c">#     &lt;forward-from-addr&gt; &lt;whitespace&gt; &lt;forward-to-addr&gt;</span>
john@example.com        john123@gmail.com
</pre></div></div></div>
<div class="paragraph"><p>We can add as many forwarding rules as you want, one on each line.  We can use
any number of tabs / whitespaces between the forward-from and forward-to
addresses.</p></div>
</div>
<div class="sect3">
<h4 id="_update_lookup_table">Update lookup table</h4>
<div class="paragraph"><p>It turns out that Postfix doesn&#8217;t actually read <code>/etc/postfix/virtual</code>
(surprise!); instead, what it reads is a lookup table generated from it.
So, let&#8217;s generate the lookup table from our <code>/etc/postfix/virtual</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postmap /etc/postfix/virtual
</pre></div></div></div>
<div class="paragraph"><p><strong>Note</strong>: we must re-run this command every time we modify
<code>/etc/postfix/virtual</code>!</p></div>
</div>
<div class="sect3">
<h4 id="_re_start_postfix">(Re)start Postfix</h4>
<div class="paragraph"><p>It&#8217;s now time to (re)start Postfix with our new configuration:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postfix start
<span class="nv">$ </span>sudo postfix reload
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_testing">Testing</h4>
<div class="paragraph"><p>We should test our brand-new Postfix server by sending an e-mail to our
forward-from address. You might want to check out
<a href="http://articles.slicehost.com/2008/8/6/postfix-using-telnet-to-test-postfix">these</a>
<a href="https://workaround.org/ispmail/lenny/test-mail-through-telnet">tutorials</a> for
testing directly with the <code>telnet</code> command.</p></div>
<div class="paragraph"><p>If you received the e-mail in your Gmail inbox, congratulations! Otherwise,
check the Postfix logs at <code>/var/log/mail.log</code> (or with <code>journalctl -u postfix</code>
if using Systemd) for errors. The most likely cause of issues is that DNS
records have not propagated yet, in which case we&#8217;re likely to see a "rate
limited" or "rejected for spam" type error message.</p></div>
<div class="paragraph"><p>If we only want to <em>receive</em> but don&#8217;t care about <em>sending</em> e-mails as
<code>john@example.com</code>, then this is all we need.</p></div>
<div class="paragraph"><p>Otherwise, let&#8217;s move on to
configuring Postfix to support sending e-mails from Gmail.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_sending_e_mail">Step 3: Sending E-mail</h3>
<div class="paragraph"><p>Gmail requires a relay server (a server that will send e-mails to their
destination on behalf it) to speak
<a href="http://en.wikipedia.org/wiki/Transport_Layer_Security">TLS</a>, which protects the
communication between Gmail and the relay server.</p></div>
<div class="paragraph"><p>We will use <a href="http://www.cyrusimap.org/">Cyrus SASL</a> for this task. To install:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo apt-get install sasl2-bin libsasl2-modules
</pre></div></div></div>
<div class="sect3">
<h4 id="_user_name_amp_password">User name &amp; password</h4>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Open_mail_relay">Open relays</a> are a terrible idea.
We want to protect our e-mail server with a user name and password so that it
will let Gmail send e-mails through it, but block spammers and other evil
actors.</p></div>
<div class="paragraph"><p>Cyrus SASL supports several backends for storing user names and passwords,
including MySQL and PAM. However, we will go with the simplest backend&#8201;&#8212;&#8201;a
plain database file.</p></div>
<div class="paragraph"><p>Let&#8217;s create the user name / password database file in the default location
<code>/etc/sasldb2</code>, with a single user named <code>smtp</code> (we can change the user name to
anything we want):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo saslpasswd2 -c -u example.com smtp
</pre></div></div></div>
<div class="paragraph"><p>Verify with:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo sasldblistusers2
</pre></div></div></div>
<div class="paragraph"><p>Now, we make sure only Postfix can read this file:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo chmod <span class="m">400</span> /etc/sasldb2
<span class="nv">$ </span>sudo chown postfix /etc/sasldb2
</pre></div></div></div>
<div class="paragraph"><p>Lastly, we tell Cyrus SASL to use the file-based database to authenticate.
Create the file <code>/etc/postfix/sasl/smtpd.conf</code>:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>pwcheck_method: auxprop
auxprop_plugin: sasldb
mech_list: PLAIN LOGIN CRAM-MD5 DIGEST-MD5 NTLM
log_level: 7</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_ssl_certificate">SSL Certificate</h4>
<div class="paragraph"><p>We need an SSL certificate to enable TLS. While a proper SSL certificate signed
by a Certificate Authority (CA) can be pricey, it turns out that a simple
self-signed certificate suffices and works just fine.</p></div>
<div class="paragraph"><p>So, let&#8217;s generate one.</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
<strong>Generate an RSA private/public key pair.</strong> Note that you MUST supply a password
  to this command; the password will be removed in step 3.
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl genrsa -des3 -out example.key 1024
</pre></div></div></div>
</li>
<li>
<p>
<strong>Generate a Certificate Signing Request (CSR).</strong> Make sure to enter
  <code>myserver.example.com</code> when prompted for the "Common Name".
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl req -new -key example.key -out example.csr
</pre></div></div></div>
</li>
<li>
<p>
<strong>Remove RSA private/public key password.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>mv example.key example.key.orig
<span class="nv">$ </span>openssl rsa -in example.key.orig -out example.key
</pre></div></div></div>
</li>
<li>
<p>
<strong>Generate a self-signed certificate.</strong> In the example, the generated
  certificate will be valid for 10 years.
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>openssl x509 -req <span class="se">\</span>
    -days <span class="m">3650</span> -in example.csr -signkey example.key -out example.crt
</pre></div></div></div>
</li>
<li>
<p>
<strong>Create a PEM file.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>cat example.crt example.key &gt; example.pem
</pre></div></div></div>
</li>
<li>
<p>
<strong>Move and protect the PEM file.</strong>
</p>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo mv example.pem /etc/postfix/example.pem
<span class="nv">$ </span>sudo chmod <span class="m">400</span> /etc/postfix/example.pem
<span class="nv">$ </span>sudo chown postfix /etc/postfix/example.pem
</pre></div></div></div>
</li>
</ol></div>
<div class="paragraph"><p><strong>Note:</strong> Make sure to protect the generated private key and certificate with care!</p></div>
</div>
<div class="sect3">
<h4 id="_relay_server">Relay server</h4>
<div class="paragraph"><p>The final step is to configure Postfix to enable relaying of e-mail on behalf of
Gmail.</p></div>
<div class="paragraph"><p>Let&#8217;s open up <code>/etc/postfix/master.cf</code>. This file should already contain a bunch
of config options, some of which are commented out. Uncomment the lines starting
with <code>submission</code> and edit them to match the following:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>submission inet n       -       n       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=may
  -o smtpd_tls_cert_file=/etc/postfix/example.pem
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_reject_unlisted_recipient=no
  -o smtpd_relay_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING</code></pre>
</div></div>
<div class="paragraph"><p>A Postfix restart is due after all these changes:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">$ </span>sudo postfix reload
</pre></div></div></div>
<div class="paragraph"><p>If all went well, you should see Postfix serving a relay server, protected by
our user name and password in <code>/etc/sasldb2</code>, on port 587.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_configure_gmail">Step 4: Configure Gmail</h3>
<div class="paragraph"><p>Finally, let&#8217;s log in to Gmail and tell it about our brand new server. (Note
that the new Inbox UI does not yet support all the settings available in the
legacy interface at the time of writing, so these instructions apply to the
legacy interface.)</p></div>
<div class="paragraph"><p>Let&#8217;s go to <em>Settings</em> &gt; <em>Accounts and Import</em> and click <em>Add another email
address you own</em>.
<div align="center"><img src="/assets/files/gmail_1.png"></div>
In the dialog that pops up, fill in our target e-mail address and click <em>Next
Step</em>.
<div align="center"><img src="/assets/files/gmail_2.png"></div>
In the next dialog, enter the address of our e-mail server
(<code>myserver.example.com</code>), and the user name and password we set up using
<code>saslpasswd2</code> above. Make sure the user name is suffixed with our domain name
(so <code>smtp@example.com</code> rather than just <code>smtp</code>). Check that the correct port
(587) and the correct security protocol (TLS) are selected, then click <em>Add
Account</em>.
<div align="center"><img src="/assets/files/gmail_3.png"></div>
If all goes well, we should see a dialog like the following:
<div align="center"><img src="/assets/files/gmail_4.png"></div>
And we should receive an e-mail, forwarded by our mail server set up in the
first part, to our <code>john123@gmail.com</code> address. Click on the link inside the
e-mail and we&#8217;re done!</p></div>
<div class="paragraph"><p>Now, in any e-mail compose / reply window, you should be able to select
<code>john@example.com</code> in the drop-down list next to "From". Congrats!</p></div>
<div class="paragraph"><p>If, on the other hand, you see an error like the following:
<div align="center"><img src="/assets/files/gmail_5.png"></div>
You should check the Postfix logs at <code>/var/log/mail.log</code> (or with <code>journalctl -u
postfix</code> if using Systemd) for any errors.</p></div>
</div>
<div class="sect2">
<h3 id="_optional_step_5_setup_dkim_and_srs">[Optional] Step 5: Setup DKIM and SRS</h3>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DKIM</a>, short for
<em>DomainKeys Identified Mail</em>, is e-mail validation system for preventing e-mail
spoofing. <a href="https://support.google.com/mail/answer/180707?hl=en">Google recommends
setting up DKIM</a>; if we don&#8217;t, the e-mail messages that we forward to Gmail have
a higher probability of getting marked as spam.</p></div>
<div class="paragraph"><p><a href="http://en.wikipedia.org/wiki/Sender_Rewriting_Scheme">SRS</a>, short for <em>Sender
Rewriting Scheme</em>, is a relatively new standard that e-mail forwarding servers
are recommended to adopt, and it also helps reduce the likelihood of our
forwarded e-mail messages getting marked as spam.</p></div>
<div class="paragraph"><p>Thus, while technically optional, it&#8217;s a good idea to configure our Postfix
server to support both these standards. See my follow-up tutorial on
<a href="/posts/setting-up-dkim-and-srs-in-postfix.html">Setting Up DKIM And SRS In
Postfix</a> for a detailed step-by-step guide.</p></div>
</div>
<div class="sect2">
<h3 id="_conclusion">Conclusion</h3>
<div class="paragraph"><p>In this post, we have set up a Postfix e-mail server that accomplishes the
following:</p></div>
<div class="ulist"><ul>
<li>
<p>
E-mails sent to <code>john@example.com</code> is received by Postfix on
  <code>myserver.example.com</code> port 25, and forwarded to <code>john123@gmail.com</code>;
</p>
</li>
<li>
<p>
Gmail will let you select <code>john@example.com</code> as a "from" address when
  composing / replying to an e-mail, and will relay such e-mails through Postfix
  on <code>myserver.example.com</code> port 587 using a configured user name / password
  combination.
</p>
</li>
</ul></div>
<div class="paragraph"><p>I hope you found this guide useful, and if you have any thoughts / questions,
you&#8217;re more than welcome to leave a comment below. Cheers!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Nov 06, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="http://seasonofcode.com/tag/misc.html">Misc</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/custom-domain-e-mails-with-postfix-and-gmail-the-missing-tutorial.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html" rel="bookmark">
      How X Window Managers Work, And How To Write One (Part II)
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-06-08T23:14:00-07:00">
          Jun 08, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>In <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Part
I of this series</a>, we examined the role of X window managers on a modern
Linux/BSD desktop, and how they interact with the X server and applications. In
Part II, we will dig down into the dirty details and walk through the code of a
basic reparenting, non-compositing window manager,
<a href="https://github.com/jichuan89/basic_wm">basic_wm</a>.</p></div>
<div class="sect2">
<h3 id="_introduction">Introduction</h3>
<div class="paragraph"><p>Before we start with the code, let&#8217;s go over a couple of basic implementation
choices such as language and API.</p></div>
<div class="sect3">
<h4 id="_language">Language</h4>
<div class="paragraph"><p>You can write a window manager in <a href="http://xmonad.org">Haskell</a>,
<a href="http://qtile.org">Python</a>, <a href="http://www.nongnu.org/stumpwm/">Lisp</a>,
<a href="https://github.com/BurntSushi/wingo">Go</a>,
<a href="http://escher.sourceforge.net/">Java</a>, or any other language that has X bindings
- i.e., a library for talking to an X server.</p></div>
<div class="paragraph"><p>I chose C++ for <a href="https://github.com/jichuan89/basic_wm">basic_wm</a>, our example
window manager, mainly because the C libraries for X11 are the best documented.
In addition to books such as the
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual</a>, documentation can be found in the form of widely available
<a href="http://www.xfree86.org/current/manindex3.html">man pages</a> (e.g., try <code>man
XOpenDisplay</code> at a terminal). Example usage and common patterns abound in the
source code of many great window managers written in the past three decades.</p></div>
<div class="paragraph"><p>We will use C++11 and C++14 features where convenient, so you will need a
compatible compiler (GCC 4.9 or higher, or Clang 3.4 or higher) if you want to
play with the source code.</p></div>
</div>
<div class="sect3">
<h4 id="a-tale-of-two-x-libraries">A Tale of Two X Libraries</h4>
<div class="paragraph"><p>There are two official C libraries for X:
<a href="http://en.wikipedia.org/wiki/Xlib">Xlib</a> and
<a href="http://en.wikipedia.org/wiki/Xcb">XCB</a>. Xlib, hailing from 1985, was the original
X client library, and was the only official X client library until the
introduction of XCB in 2001. The two libraries have very different philosophies:
whereas Xlib tries to hide the X protocol behind a friendly C API with lots of
bells and whistles, XCB directly exposes the plumbing beneath.</p></div>
<div class="paragraph"><p>In practice, this different manifests itself most prominently in how the two
libraries handle the fundamental asynchronous nature of the X protocol. Xlib
attempts to hide the asynchronous X protocol behind a mixed
synchronous and asynchronous API, whereas XCB is fully asynchronous.</p></div>
<div class="paragraph"><p>For example, to lookup the attributes (e.g., size and position) of a window, you
would write the following using Xlib:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">XWindowAttributes</span> <span class="n">attrs</span><span class="p">;</span>
<span class="n">XGetWindowAttributes</span><span class="p">(</span><span class="n">display</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">attrs</span><span class="p">);</span>
<span class="c1">// Do stuff.</span>
</pre></div></div></div>
<div class="paragraph"><p>Under the hood,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XGetWindowAttributes.3.html"><code>XGetWindowAttributes</code>()</a>
sends a request to the X server and blocks until it receives a response; in
other words, it is <em>synchronous</em>. On the other hand, using XCB, you would write
this instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">xcb_get_window_attributes_cookie_t</span> <span class="n">cookie</span> <span class="o">=</span>
    <span class="n">xcb_get_window_attributes</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
<span class="c1">// Do other stuff while waiting for reply.</span>
<span class="kt">xcb_get_window_attributes_reply_t</span><span class="o">*</span> <span class="n">reply</span> <span class="o">=</span>
    <span class="n">xcb_get_window_attributes_reply</span><span class="p">(</span>
        <span class="n">connection</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="k">nullptr</span><span class="p">);</span>
<span class="c1">// Do stuff.</span>
<span class="n">free</span><span class="p">(</span><span class="n">reply</span><span class="p">);</span>
</pre></div></div></div>
<div class="paragraph"><p>The function <code>xcb_get_window_attributes</code> merely sends the request to the X
server, and returns immediately without waiting for the reply; in other words,
it is <em>asynchronous</em>. The client program must subsequently call
<code>xcb_get_window_attributes_reply</code> to block on the response.</p></div>
<div class="paragraph"><p>The advantage of the asynchronous approach is obvious if we consider an example
where we need to retrieve the attributes of, say, 5 windows. Using XCB, we can
fire off all 5 requests to the X server at once, and then wait for 5 responses.
With Xlib, we have to wait for the response to each request before we can send
the next one. Therefore, we only block for one round-trip network latency using
XCB, compared to 5 with Xlib.</p></div>
<div class="paragraph"><p>The downside of XCB&#8217;s fully asynchronous approach is verbosity and a less
programmer-friendly API.  The Xlib code above looks like your average C library
call; the XCB code above is significantly more involved.</p></div>
<div class="paragraph"><p>However, it is important to note that whereas XCB is fully asynchronous, Xlib
isn&#8217;t fully synchronous; rather, <strong>Xlib has a mixture of synchronous and
asynchronous APIs</strong>. In general, functions that do not return values (e.g.,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XConfigureWindow.3.html">XResizeWindow</a>,
which changes the size of a window) are asynchronous, while functions that
return values (e.g.,
<a href="http://manpages.ubuntu.com/manpages/en/man3/XGetWindowAttributes.3.html">XGetGeometry</a>,
which return the size and position of a window) are synchronous:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>Xlib saves up requests instead of sending them to the server immediately, so
that the client program can continue running instead of waiting to gain access
to the network after every Xlib call. This is possible because most Xlib calls
do not require immediate action by the server. This grouping of requests by the
client before sending them over the network also increases the performance of
most networks, because it makes the network transactions longer and less
numerous, reducing the total overhead involved.</p></div>
<div class="paragraph"><p>Xlib sends the buffer full of requests to the server under three conditions.</p></div>
<div class="paragraph"><p>The most common is when an application calls an Xlib routine to wait for an
event but no matching event is currently available on Xlib’s queue. Since, in
this case, the application must wait for an appropriate event anyway, it makes
sense to flush the request buffer.</p></div>
<div class="paragraph"><p>Second, Xlib calls that get information from the server require a reply before
the program can continue, and therefore, the request buffer is sent and all the
requests acted on before the information is returned.</p></div>
<div class="paragraph"><p>Third, the client would like to be able to flush the request buffer manually in
situations where no user events and no calls to query the server are expected.
One good example of this third case is an animated game, where the display
changes even when there is no user input.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual §2.1.2
</div></div>
<div class="paragraph"><p>This is <em>the</em> most confusing aspect of Xlib, and was a source of endless
frustration for those new to X programming. One of the major motivations for the
creation of XCB was to eliminate this unnecessary complexity.</p></div>
<div class="paragraph"><p>Most popular window managers have already been ported to XCB from Xlib for the
performance benefits. (If you are interested, you can read up on
<a href="http://www.mini-dweeb.org/~arnau/docs/dueti/project/report.pdf">how they ported
Awesome</a> and
<a href="http://blog.martin-graesslin.com/blog/2013/02/porting-kwin-to-xcb-making-c-usable-through-raii/">KWin</a>).
I chose Xlib for <a href="https://github.com/jichuan89/basic_wm">basic_wm</a>, however,
because for pedagogical example code readability is of course much more
important than performance. In fact, I would recommend starting with Xlib first
for any project and worry about porting to XCB later, as Xlib is much easier to
work with.</p></div>
<div class="paragraph"><p>While an in-depth discussion of the merits of Xlib and XCB is beyond the scope
of this discussion, I do recommend you check out
<a href="http://www.x.org/wiki/guide/xlib-and-xcb/">the official article on Xlib vs. XCB</a>
as it presents a fascinating case study of API design.</p></div>
</div>
<div class="sect3">
<h4 id="_dependencies_and_building">Dependencies and Building</h4>
<div class="paragraph"><p>The only additional library used by the example
<a href="https://github.com/jichuan89/basic_wm">basic_wm</a> code is
<a href="https://code.google.com/p/google-glog/">google-glog</a>, Google&#8217;s open source C++
logging library. (It is available on Debian/Ubuntu as <code>libgoogle-glog-dev</code>, on
Fedora as <code>glog</code>, and on Arch Linux as <code>google-glog</code>.)</p></div>
<div class="paragraph"><p>The recommended way to build the source code is with
<a href="http://www.scons.org/">SCons</a>, although <code>g++ *.cpp</code> will also do the trick if you
supply all the libraries correctly.</p></div>
<div class="paragraph"><p>To test it, you will likely need
<a href="http://www.freedesktop.org/wiki/Software/Xephyr/">Xephyr</a> along with a couple of
simple X programs such as <code>xeyes</code> or <code>xterm</code>.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_step_1_setup_and_teardown">Step 1: Setup and Teardown</h3>
<div class="paragraph"><p>Let&#8217;s start off with a skeleton implementation of the <code>WindowManager</code> class,
which will encapsulate all the window management logic in our example. All it
will do for now is set up a connection to the X server on construction, and
close that connection on destruction.</p></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.hpp"><code>window_manager.hpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">extern</span> <span class="s">&quot;C&quot;</span> <span class="p">{</span>
<span class="cp">#include &lt;X11/Xlib.h&gt;</span>
<span class="p">}</span>
<span class="cp">#include &lt;memory&gt;</span>

<span class="k">class</span> <span class="nc">WindowManager</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="c1">// Factory method for establishing a connection to an X server and creating a</span>
  <span class="c1">// WindowManager instance.</span>
  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">Create</span><span class="p">();</span>
  <span class="c1">// Disconnects from the X server.</span>
  <span class="o">~</span><span class="n">WindowManager</span><span class="p">();</span>
  <span class="c1">// The entry point to this class. Enters the main event loop.</span>
  <span class="kt">void</span> <span class="nf">Run</span><span class="p">();</span>

 <span class="k">private</span><span class="o">:</span>
  <span class="c1">// Invoked internally by Create().</span>
  <span class="n">WindowManager</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">);</span>

  <span class="c1">// Handle to the underlying Xlib Display struct.</span>
  <span class="n">Display</span><span class="o">*</span> <span class="n">display_</span><span class="p">;</span>
  <span class="c1">// Handle to root window.</span>
  <span class="k">const</span> <span class="n">Window</span> <span class="n">root_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#include &quot;window_manager.hpp&quot;</span>
<span class="cp">#include &lt;glog/logging.h&gt;</span>

<span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Create</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Open X display.</span>
  <span class="n">Display</span><span class="o">*</span> <span class="n">display</span> <span class="o">=</span> <span class="n">XOpenDisplay</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">display</span> <span class="o">==</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to open X display &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">XDisplayName</span><span class="p">(</span><span class="k">nullptr</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// 2. Construct WindowManager instance.</span>
  <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span><span class="p">(</span><span class="k">new</span> <span class="n">WindowManager</span><span class="p">(</span><span class="n">display</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">WindowManager</span><span class="o">::</span><span class="n">WindowManager</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">)</span>
    <span class="o">:</span> <span class="n">display_</span><span class="p">(</span><span class="n">CHECK_NOTNULL</span><span class="p">(</span><span class="n">display</span><span class="p">)),</span>
      <span class="n">root_</span><span class="p">(</span><span class="n">DefaultRootWindow</span><span class="p">(</span><span class="n">display_</span><span class="p">))</span> <span class="p">{</span>
<span class="p">}</span>

<span class="n">WindowManager</span><span class="o">::~</span><span class="n">WindowManager</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">XCloseDisplay</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span> <span class="cm">/* TODO */</span> <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>The <code>main</code> function in
<a href="https://github.com/jichuan89/basic_wm/blob/master/main.cpp"><code>main.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#include &lt;cstdlib&gt;</span>
<span class="cp">#include &lt;glog/logging.h&gt;</span>
<span class="cp">#include &quot;window_manager.hpp&quot;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">**</span> <span class="n">argv</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">google</span><span class="o">::</span><span class="n">InitGoogleLogging</span><span class="p">(</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">WindowManager</span><span class="o">&gt;</span> <span class="n">window_manager</span><span class="p">(</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">Create</span><span class="p">());</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">window_manager</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Failed to initialize window manager.&quot;</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">EXIT_FAILURE</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">window_manager</span><span class="o">-&gt;</span><span class="n">Run</span><span class="p">();</span>

  <span class="k">return</span> <span class="n">EXIT_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>Even if you have never programmed Xlib before, this should not be hard to
understand. <code>WindowManager::Create()</code> is a
<a href="http://google-styleguide.googlecode.com/svn/trunk/cppguide.xml#Doing_Work_in_Constructors">static
factory method</a> that sets up a connection to an X server via
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XOpenDisplay()</code></a>;
we will let
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XOpenDisplay()</code></a>
figure out which X server to connect to from the <code>DISPLAY</code> environment variable.
The connection is represented by the opaque <code>Display</code> structure. We call
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/XOpenDisplay.3.html"><code>XCloseDisplay()</code></a>
on the saved <code>Display*</code> in the destructor to close the connection.</p></div>
<div class="paragraph"><p>The other function of note is
<a href="http://manpages.ubuntu.com/manpages/trusty/en/man3/AllPlanes.3.html"><code>DefaultRootWindow()</code></a>,
which returns the default root window for a given X server. Technically, an X
server may have several root windows in some rare multihead setups, but let&#8217;s
not worry about that here.</p></div>
<div class="paragraph"><p>If you run this program now, it should connect to the X server, close the
connection, and exit. Hooray!</p></div>
</div>
<div class="sect2">
<h3 id="_step_2_initialization">Step 2: Initialization</h3>
<div class="paragraph"><p>Now, let&#8217;s dig into the mysterious <code>Run()</code> function above. We&#8217;ll start with the
initialization steps required after opening an X server connection.
In
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.hpp"><code>window_manager.hpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">class</span> <span class="nc">WindowManager</span> <span class="p">{</span>
  <span class="p">...</span>
  <span class="c1">// Xlib error handler.</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">OnXError</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">);</span>
  <span class="c1">// Xlib error handler used to determine whether another window manager is</span>
  <span class="c1">// running. It is set as the error handler right before selecting substructure</span>
  <span class="c1">// redirection mask on the root window, so it is invoked if and only if</span>
  <span class="c1">// another window manager is running.</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="nf">OnWMDetected</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">);</span>
  <span class="c1">// Whether an existing window manager has been detected. Set by OnWMDetected.</span>
  <span class="k">static</span> <span class="kt">bool</span> <span class="n">wm_detected_</span><span class="p">;</span>
  <span class="c1">// A mutex for protecting wm_detected_.</span>
  <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">mutex</span> <span class="n">wm_detected_mutex_</span><span class="p">;</span>
<span class="p">};</span>
</pre></div></div></div>
<div class="paragraph"><p>In
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Initialization.</span>
  <span class="c1">//   a. Select events on root window. Use a special error handler so we can</span>
  <span class="c1">//   exit gracefully if another window manager is already running.</span>
  <span class="p">{</span>
    <span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span> <span class="n">lock</span><span class="p">(</span><span class="n">wm_detected_mutex_</span><span class="p">);</span>

    <span class="n">wm_detected_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
    <span class="n">XSetErrorHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">OnWMDetected</span><span class="p">);</span>
    <span class="n">XSelectInput</span><span class="p">(</span>
        <span class="n">display_</span><span class="p">,</span>
        <span class="n">root_</span><span class="p">,</span>
        <span class="n">SubstructureRedirectMask</span> <span class="o">|</span> <span class="n">SubstructureNotifyMask</span><span class="p">);</span>
    <span class="n">XSync</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wm_detected_</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">LOG</span><span class="p">(</span><span class="n">ERROR</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Detected another window manager on display &quot;</span>
                 <span class="o">&lt;&lt;</span> <span class="n">XDisplayString</span><span class="p">(</span><span class="n">display_</span><span class="p">);</span>
      <span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="c1">//   b. Set error handler.</span>
  <span class="n">XSetErrorHandler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">WindowManager</span><span class="o">::</span><span class="n">OnXError</span><span class="p">);</span>

  <span class="c1">// 2. Main event loop.</span>
  <span class="p">...</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnWMDetected</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// In the case of an already running window manager, the error code from</span>
  <span class="c1">// XSelectInput is BadAccess. We don&#39;t expect this handler to receive any</span>
  <span class="c1">// other errors.</span>
  <span class="n">CHECK_EQ</span><span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">error_code</span><span class="p">),</span> <span class="n">BadAccess</span><span class="p">);</span>
  <span class="c1">// Set flag.</span>
  <span class="n">wm_detected_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="c1">// The return value is ignored.</span>
  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">OnXError</span><span class="p">(</span><span class="n">Display</span><span class="o">*</span> <span class="n">display</span><span class="p">,</span> <span class="n">XErrorEvent</span><span class="o">*</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Print e */</span> <span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>We first select substructure redirection and substructure notify events on the
root window. This is discussed in more detail in the
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#substructure-redirection">Substructure
Redirection</a> section in Part I; to recap, this allows the window manager to
intercept requests from top level windows, and subscribe to events concerning the
same. Only one X client can select substructure redirection on the root window
at any given time; the second client to attempt to do so will get a <code>BadAccess</code>
error.</p></div>
<div class="paragraph"><p>Catching this error is somewhat tricky, however.
<a href="http://manpages.ubuntu.com/manpages/en/man3/XSelectInput.3.html"><code>XSelectInput</code></a>,
like most Xlib functions, does not actually send a request to the X server, but
instead only <em>queues</em> the request and returns. Hence, we have to explicitly
flush the request queue with
<a href="http://manpages.ubuntu.com/manpages/en/man3/XSync.3.html"><code>XSync</code></a> (see our
discussion above in <a href="#a-tale-of-two-x-libraries">A Tale of Two X Libraries</a>).
We set up a temporary error handler to catch errors.</p></div>
<div class="paragraph"><p>Next, we set up our regular error handler which will be invoked for any future
errors.  Our implementation, which logs the error and continues, will be an
important debugging aid as we implement and test our window manager. I will not
show it here for the sake of brevity; for reference, check it out in
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>.</p></div>
</div>
<div class="sect2">
<h3 id="_step_3_the_event_loop">Step 3: The Event Loop</h3>
<div class="paragraph"><p>Now let&#8217;s add to <code>Run()</code> method above the signature construct of every modern
GUI program - the event loop. In
<a href="https://github.com/jichuan89/basic_wm/blob/master/window_manager.cpp"><code>window_manager.cpp</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kt">void</span> <span class="n">WindowManager</span><span class="o">::</span><span class="n">Run</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// 1. Initialization.</span>
  <span class="p">...</span>

  <span class="c1">// 2. Main event loop.</span>
  <span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
    <span class="c1">// 1. Get next event.</span>
    <span class="n">XEvent</span> <span class="n">e</span><span class="p">;</span>
    <span class="n">XNextEvent</span><span class="p">(</span><span class="n">display_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="p">);</span>
    <span class="n">LOG</span><span class="p">(</span><span class="n">INFO</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Received event: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">ToString</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

    <span class="c1">// 2. Dispatch event.</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">case</span> <span class="nl">CreateNotify</span><span class="p">:</span>
        <span class="n">OnCreateNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xcreatewindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">DestroyNotify</span><span class="p">:</span>
        <span class="n">OnDestroyNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xdestroywindow</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="k">case</span> <span class="nl">ReparentNotify</span><span class="p">:</span>
        <span class="n">OnReparentNotify</span><span class="p">(</span><span class="n">e</span><span class="p">.</span><span class="n">xreparent</span><span class="p">);</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="p">...</span>
      <span class="c1">// etc. etc.</span>
      <span class="p">...</span>
      <span class="k">default</span><span class="o">:</span>
        <span class="n">LOG</span><span class="p">(</span><span class="n">WARNING</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Ignored event&quot;</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>If you have done low-level GUI programming before, this should look fairly
familiar. We sit in an event loop and repeatedly fetch the next event with
<a href="http://manpages.ubuntu.com/manpages/en/man3/XNextEvent.3.html"><code>XNextEvent()</code></a> and
dispatch it to the appropriate handlers.</p></div>
<div class="paragraph"><p>The structure of the <code>XEvent</code> type is typical of a polymorphic C structure.
Each type of event carries different attributes and corresponds to an event
<code>struct</code>, such as <code>XKeyEvent</code>, <code>XButtonEvent</code>, and <code>XConfigureEvent</code>. The first
field of each <code>struct</code> is always <code>int type</code>. The <code>XEvent</code> type is a C
<code>union</code> of all the event <code>structs</code> plus <code>int type</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_XKeyEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="c1">// Fields specific to XKeyEvent.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XKeyEvent</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">_XButtonEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="c1">// Fields specific to XButtonEvent.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XButtonEvent</span><span class="p">;</span>

<span class="c1">// etc.</span>
<span class="p">...</span>

<span class="k">typedef</span> <span class="k">union</span> <span class="n">_XEvent</span> <span class="p">{</span>
  <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
  <span class="n">XKeyEvent</span> <span class="n">xkey</span><span class="p">;</span>
  <span class="n">XButtonEvent</span> <span class="n">xbutton</span><span class="p">;</span>
  <span class="c1">// etc.</span>
  <span class="p">...</span>
<span class="p">}</span> <span class="n">XEvent</span><span class="p">;</span>
</pre></div></div></div>
<div class="paragraph"><p>This way, the type is always available regardless of the type of event and
requires no additional storage. This, of course, is essentially C++ object
inheritance, and the same pattern can be observed in
<a href="http://en.wikipedia.org/wiki/GObject">GTK+/GLib</a>,
<a href="https://docs.python.org/3/c-api/structures.html">Python&#8217;s C API</a>, and many other
object-oriented C APIs.</p></div>
<div class="paragraph"><p>In <code>basic_wm</code>, the event handlers follow the naming convention of <code>OnFoo()</code>,
where <code>Foo</code> is the type of the event, so it should be straightforward to figure
out who does what.</p></div>
</div>
<div class="sect2">
<h3 id="_what_8217_s_next">What&#8217;s Next</h3>
<div class="paragraph"><p>We now have a basic skeleton for our window manager, and we can start filling in
the meat - the event handlers. The million-dollar question is, what events does
a window manager handle, and what should it do with them?</p></div>
<div class="paragraph"><p>In the next installment of this series, we&#8217;ll answer that question by diving
into the complex ways window managers, clients and the user interact with each
other via X events. In the meantime, you&#8217;re more than welcome to check out the
code for <code>basic_wm</code> <a href="https://github.com/jichuan89/basic_wm">on GitHub</a> or browse
the cross-referenced code <a href="http://code.openhub.net/project?pid=&amp;ipid=568869">on
Open Hub</a>.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Jun 08, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html" rel="bookmark">
      DEBUG trap and PROMPT_COMMAND in Bash
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-06-08T11:50:00-07:00">
          Jun 08, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/linux.html">Linux</a>,            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="sect2">
<h3 id="_the_debug_trap">The DEBUG trap</h3>
<div class="paragraph"><p>The DEBUG trap is an extremely handy feature of Bash. The idea is pretty
straightforward: if you run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nb">trap</span> <span class="s2">&quot;echo Hello&quot;</span> DEBUG
</pre></div></div></div>
<div class="paragraph"><p>then Bash will run <code>echo Hello</code> before it executes each subsequent command. For
example:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ ls
Hello
file1 file2
~/Scratch $ echo Bye
Hello
Bye</code></pre>
</div></div>
<div class="paragraph"><p>A caveat, however, is that the DEBUG trap is triggered once per <em>simple</em>
command; if you have command lists or control structures, the trap will be
triggered multiple times. For example, using the setup above:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1 &amp;&amp; echo 2; echo 3
Hello
1
Hello
2
Hello
3
~/Scratch $ if [ -e /etc/passwd ]; then echo "/etc/passwd exists"; fi
Hello
Hello
/etc/passwd exists</code></pre>
</div></div>
<div class="paragraph"><p>What if we only want to run a command once per composite command, like the
<a href="http://zsh.sourceforge.net/Doc/Release/Functions.html"><code>preexec</code></a> hook in
<a href="http://en.wikipedia.org/wiki/Z_shell">zsh</a>?</p></div>
<div class="paragraph"><p>Enter <code>PROMPT_COMMAND</code>.</p></div>
</div>
<div class="sect2">
<h3 id="_prompt_command">PROMPT_COMMAND</h3>
<div class="paragraph"><p>The idea behind <code>PROMPT_COMMAND</code> is also very simple: if you run</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;echo Bye&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>then Bash will execute <code>echo Bye</code> before it prints each subsequent prompt (i.e.,
after it has finished executing the previous command line). For example, using
the setup above:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1; echo 2
Hello
1
Hello
2
Hello
Bye</code></pre>
</div></div>
<div class="paragraph"><p>Note that the DEBUG trap is triggered again for <code>PROMPT_COMMAND</code>, in addition to
the user-supplied commands.</p></div>
</div>
<div class="sect2">
<h3 id="_combining_the_debug_trap_and_code_prompt_command_code">Combining the DEBUG trap and <code>PROMPT_COMMAND</code></h3>
<div class="paragraph"><p>By combining the DEBUG trap and <code>PROMPT_COMMAND</code>, we can now hack Bash to
run some code right before and right after executing a full command. For
example, try adding this to your <code>~/.bashrc</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># This will run before any command is executed.</span>
<span class="k">function</span> PreCommand<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> -z <span class="s2">&quot;</span><span class="nv">$AT_PROMPT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="k">return</span>
  <span class="k">fi</span>
  <span class="nb">unset </span>AT_PROMPT

  <span class="c"># Do stuff.</span>
  <span class="nb">echo</span> <span class="s2">&quot;Running PreCommand&quot;</span>
<span class="o">}</span>
<span class="nb">trap</span> <span class="s2">&quot;PreCommand&quot;</span> DEBUG

<span class="c"># This will run after the execution of the previous full command line.  We don&#39;t</span>
<span class="c"># want it PostCommand to execute when first starting a bash session (i.e., at</span>
<span class="c"># the first prompt).</span>
<span class="nv">FIRST_PROMPT</span><span class="o">=</span>1
<span class="k">function</span> PostCommand<span class="o">()</span> <span class="o">{</span>
  <span class="nv">AT_PROMPT</span><span class="o">=</span>1

  <span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;</span><span class="nv">$FIRST_PROMPT</span><span class="s2">&quot;</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
    <span class="nb">unset </span>FIRST_PROMPT
    <span class="k">return</span>
  <span class="k">fi</span>

  <span class="c"># Do stuff.</span>
  <span class="nb">echo</span> <span class="s2">&quot;Running PostCommand&quot;</span>
<span class="o">}</span>
<span class="nv">PROMPT_COMMAND</span><span class="o">=</span><span class="s2">&quot;PostCommand&quot;</span>
</pre></div></div></div>
<div class="paragraph"><p>The result:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>~/Scratch $ echo 1; echo 2 &amp;&amp; echo 3
Running PreCommand
1
2
3
Running PostCommand</code></pre>
</div></div>
<div class="paragraph"><p>This gives rise to some neat applications, such as
<a href="https://github.com/jichuan89/bash-command-timer">a command timer script</a> I wrote that
prints out the execution time of each command: <div align="center"><img
src="/assets/files/bash_command_timer_screenshot.gif" style="max-width: 657px;
width: 100%"></div>
Please feel free to
<a href="https://github.com/jichuan89/bash-command-timer">check it out on GitHub</a> :)</p></div>
<div class="paragraph"><p>Happy Bash hacking!</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Jun 08, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/linux.html">Linux</a>,          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/debug-trap-and-prompt_command-in-bash.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html" rel="bookmark">
      How X Window Managers Work, And How To Write One (Part I)
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-04-10T01:08:00-07:00">
          Apr 10, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Window managers are one of the core components of the modern Linux/BSD desktop.
It is not an exaggeration to say that they define to a large degree our
day-to-day user experience, as they are responsible for deciding how individual
windows look, move around, react to input, and organize themselves. Hence,
almost 30 years since <a href="http://en.wikipedia.org/wiki/Ultrix_Window_Manager">the
first X window manager</a>, we still argue over the merits of different window
managers, and new window managers continue to reinvent how we interact with our
digital world.</p></div>
<div class="paragraph"><p>In this series of posts, I hope to demystify how window managers work, and how
you might go about writing one yourself.</p></div>
<div class="paragraph"><p>I will be quoting quite heavily from the seminal
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual (3rd Ed, 1994)</a> by Adrian Nye and published by O&#8217;Reilly.
Despite its age, it remains amazingly relevant and is the best available
introductory text to the internals of X, which has not changed over the past two
decades as much as you&#8217;d think. Since you could buy the book plus shipping for
less than the price of a cup of coffee, I strongly recommend it to anyone
interested in learning more about X. In addition, its chapter 16 also covers the
basics of window management.</p></div>
<div class="sect2">
<h3 id="_the_role_of_an_x_window_manager">The Role of an X Window Manager</h3>
<div class="paragraph"><p>Let&#8217;s start with an examination of the role of the window manager in a modern
Linux/BSD desktop environment.</p></div>
<div class="sect3">
<h4 id="_the_rights_of_x_window_managers">The Rights of X Window Managers</h4>
<div class="paragraph"><p>Unlike other windowing systems such as Microsoft Windows or Mac OS X, X does not
dictate a window manager or how a window manager should behave. This decision is
to thank for the wild diversity of X window managers we see today.</p></div>
<div class="quoteblock">
<div class="content">X is somewhat unusual in that it does not mandate a particular type of window
manager. Its developers have tried to make X itself as free of window management
or user interface policy as possible.</div>
<div class="attribution">
&#8212; Xlib Programming Manual §1.2.3
</div></div>
<div class="paragraph"><p>In fact, it does not even require a window manager to be present at all:</p></div>
<div class="quoteblock">
<div class="content">Unlike citizens, the window manager has rights but not responsibilities.
Programs must be prepared to cooperate with any type of window manager or with
none at all [&#8230;].</div>
<div class="attribution">
&#8212; Xlib Programming Manual §1.2.3
</div></div>
<div class="paragraph"><p>This is in stark contrast to the integrative approach of other GUI systems. On
Mac OS X and <a href="https://unity.ubuntu.com/">Unity</a>, for example, an application could
not possibly function without the window manager, as the latter is responsible
for rendering a part of the application&#8217;s interface (e.g., menus).</p></div>
</div>
<div class="sect3">
<h4 id="_the_responsibilities_of_x_window_managers">The Responsibilities of X Window Managers</h4>
<div class="paragraph"><p>As you probably already know, X operates in a server-client model. An X <em>server</em>
controls one or more physical display devices as well as input devices (mouse,
keyboard, etc.). An application that wants to interact with these devices
assumes the role of an X <em>client</em>. An X server and its clients may run on the
same computer, in which case they communicate via
<a href="http://en.wikipedia.org/wiki/Unix_domain_socket">domain sockets</a>, or on different
computers, in which case they communicate through TCP/IP.</p></div>
<div class="paragraph"><p><strong>A window manager is a regular X client.</strong> It doesn&#8217;t have any superuser
privileges or keys to kernel backdoors; it is a normal user process that is
allowed by the X server to call a set of special APIs. X ensures that no more
than one window manager is running at any given point by denying a client access
to these APIs if another client currently has access. The first client to
attempt to access these APIs always succeeds.</p></div>
<div class="paragraph"><p>A window manager communicates with the windows it manages through two X
mechanisms: properties and events. We will discuss these in detail in later
sections, but the takeaway is that the communication happens through the X
server, not directly between the window manager and other applications.</p></div>
<div class="paragraph"><p>This is illustrated by the following diagram:</p></div>
<div class="paragraph" id="role-of-a-window-manager"><p><div align="center"><img
src="https://docs.google.com/drawings/d/1Kv8kYF3IeWnsMSuF04goBPi1WudQV3llyK4R5lu_ips/pub?w=554&h=402"
alt="Role of a Window Manager"
style="max-width: 554px; width: 100%;"></div></p></div>
</div>
</div>
<div class="sect2">
<h3 id="_how_an_x_window_manager_manages_windows">How an X Window Manager Manages Windows</h3>
<div class="paragraph"><p>Let&#8217;s now dive into the details of how a window manager does its job.</p></div>
<div class="sect3">
<h4 id="_the_window_hierarchy">The Window Hierarchy</h4>
<div class="paragraph"><p>When we think about modern GUIs, we usually use the term <em>widgets</em> or <em>controls</em>
to refer to UI elements such as buttons, scrollbars, or text boxes, and the term
<em>windows</em> to refer to a container for such widgets that has its own name and
can be independently moved around, closed, resized, etc..</p></div>
<div class="paragraph"><p>X, however, was designed to be as low-level as possible. The fundamental UI
model that X provides, upon which UI frameworks such as
<a href="http://www.gtk.org/">GTK+</a> and <a href="http://qt-project.org">Qt</a> are built, is that of an
<em>hierarchy of rectangles</em>. In X terminology, all top level windows, UI elements,
etc., are <em>windows</em>. A <em>window</em>, then, is any rectangular area that is an unit
of user interaction and/or graphic display.</p></div>
<div class="paragraph"><p>Windows are organized into a tree hierarchy. At the root of the hierarchy is the
<em>root window</em>, a virtual, invisible window that has the same size as the screen,
and is always present. Top level windows are direct children of the root
window. UI elements within a top level window are descendants of that window.</p></div>
<div class="paragraph"><p><div align="center"><img src="/assets/files/wm_sample_dialog.png" alt="An
example X window" style="max-width: 402px; width: 100%;"></div></p></div>
<div class="paragraph"><p>For example, consider the dialog box above from the <a href="http://www.xfce.org/">Xfce</a>
desktop environment. The entire dialog is an X <em>window</em>. Each UI element in the
dialog box - the magnifying glass icon, the text box, the green down arrow, the
Close and Launch buttons, and the icons int those buttons - is also an X
<em>window</em>.</p></div>
<div class="paragraph"><p>The whole dialog window is a child of the root window. The magnifying glass
icon, the text box, and the Close and Launch buttons are children of the dialog
window. The green down arrow is a child of the text box window, and the icons in
the Close and Launch buttons are children of those buttons respectively.</p></div>
<div class="paragraph"><p>An important thing to note about X windows is that a child window is clipped to
the boundaries of its parent:</p></div>
<div class="quoteblock">
<div class="content">A child may be positioned partially or completely outside its parent window, but
output to the child is displayed and input received only in the area where the
child overlaps with the parent.</div>
<div class="attribution">
&#8212; Xlib Programming Manual §2.2.2
</div></div>
<div class="paragraph"><p>For example, if we increase the width of the text box in the dialog above by
2x without changing the size of the dialog box, the portion of the text box that
extends outside of the dialog box will become invisible, and clicking on it will
not send an event to the text box.</p></div>
<div class="paragraph"><p>A window manager manages top level windows - that is, direct children of the
root window.</p></div>
</div>
<div class="sect3">
<h4 id="substructure-redirection">Substructure Redirection</h4>
<div class="paragraph"><p>In the absence of a window manager, when an application wants to reconfigure a
window - move, resize, show/hide, etc. - its request is directly processed by
the X server, and that&#8217;s the end of that. A window manager, however, needs to
intercept these requests. For example, a window manager may need to know that a
new top level window has been created and displayed, in order to draw window
decorations around it. It may also need to know that an existing top level
window has been resized, in order to update the window decorations to reflect
the change.</p></div>
<div class="paragraph"><p>A window manager can intercept such requests using a mechanism called
<em>substructure redirection</em>.</p></div>
<div class="paragraph"><p>This is how substructure redirection works. Suppose we have a window <em>W</em>, which
has a child window <em>C</em>. If a program <em>M</em> registers for the substructure
redirection of some types of requests on <em>W</em>, a matching request to modify <em>C</em>
will <em>not</em> be executed by the X server.  Instead, the X server redirects this
request to the program <em>M</em>, which can do whatever it wants with the request,
including granting the request with modifications or denying the request. More
formally,</p></div>
<div class="quoteblock">
<div class="content">The <em>structure</em>, as the term is used here, is the location, size, stacking
order, border width, and mapping status of a window. The <em>substructure</em> is all
these statistics about the children of a particular window. This is the complete
set of information about screen layout that the window manager might need in
order to implement its policy. <em>Redirection</em> means that an event is sent to the
client selecting redirection (usually the window manager), and the original
structure−changing request is not executed.</div>
<div class="attribution">
&#8212; Xlib Programming Manual §16.2
</div></div>
<div class="paragraph"><p>Note that only direct children of a window <em>W</em> is affected by substructure
redirection on <em>W</em>, not any windows further down the hierarchy.</p></div>
<div class="paragraph"><p>This gets interesting when we consider substructure redirection on the root
window:</p></div>
<div class="quoteblock">
<div class="content">When the window manager selects <code>SubstructureRedirectMask</code> on the root window,
an attempt by any other client to change the configuration of any child of the
root window will fail. Instead an event describing the layout change request
will be sent to the window manager. The window manager then reads the event and
determines whether to honor the request, modify it, or deny it completely. If it
decides to honor the request, it calls the routine that the client called that
triggered the event with the same arguments. If it decides to modify the
request, it calls the same routine but with modified arguments.</div>
<div class="attribution">
&#8212; Xlib Programming Manual §16.2
</div></div>
<div class="paragraph"><p>In other words, a window manager must register for substructure redirection on
the root window, which causes all creation, destruction, reconfiguration etc. of
top level windows - which are direct children of the root window - to be routed
to the window manager. This is the magic hook into the X server that window
managers rely on to do their job.</p></div>
<div class="paragraph"><p>This relationship is shown in the following diagram:
<div align="center"><img
src="https://docs.google.com/drawings/d/1ykdjiN-__H5-aWjic73c23K6g2MguBKLgwh9C2n-I5k/pub?w=602&amp;h=273"
alt="Role of a Window Manager"
style="max-width: 602px; width: 100%;"></div></p></div>
<div class="paragraph"><p>Finally, the X server only allows one running program to register for
substructure redirection on any given window at any given time. An attempt to
register for substructure redirection on a window will fail if another X client
has already done the same on the same window, and has not unregistered,
disconnected from the X server, or crashed. Since all window managers must
register for substructure redirection on the root window, this latter acts as a
locking mechanism that prevents two or more window managers from running
simultaneously on the same screen.</p></div>
</div>
<div class="sect3">
<h4 id="_reparenting">Reparenting</h4>
<div class="paragraph"><p>In the example dialog box above, we see a title bar with, for example, little
buttons for closing, maximizing, and minimizing the window. These UI elements
are not created by the application, but by the window manager, via a process
known as <em>reparenting</em> or <em>framing</em>:</p></div>
<div class="quoteblock">
<div class="content">
<div class="paragraph"><p>A window manager can decorate [top level] windows on the screen with titlebars
and place little boxes on the titlebar with which the window can be moved or
resized. This is only one possibility [&#8230;].</p></div>
<div class="paragraph"><p>To do this, the window manager creates a child of the root somewhat larger than
the top level window of the application. Then it calls
<a href="http://manpages.ubuntu.com/manpages/en/man3/XReparentWindow.3.html"><code>XReparentWindow()</code></a>,
specifying the top level window of the application as <code><em>win</em></code> and the new parent
[window it just created] as <code><em>parent</em></code>. <code><em>win</em></code> and all its descendants will
then be descendants of <code><em>parent</em></code>.</p></div>
</div>
<div class="attribution">
&#8212; Xlib Programming Manual §16.3
</div></div>
<div class="paragraph"><p>In other words, if we were to run an X application without a window manager
present, the top level window of the application would be a direct child of the
root window. With a window manager running, however, the top level window of the
application may be <em>reparented</em> by the window manager; it becomes a child of a
frame window which is created by the window manager, and which is itself a child
of the root window. The window manager can add other UI elements inside this
frame window alongside the application&#8217;s top level window as it sees fit.</p></div>
<div class="paragraph"><p>Therefore, I had lied to you just now: the dialog box above is actually a child
of a frame created by <a href="http://www.xfce.org">Xfce</a>'s window manager, Xfwm, along
with the other UI elements for window management.</p></div>
<div class="paragraph"><p>Reparenting is what allows different window managers to draw different window
decorations, and thereby achieve a consistent look-and-feel across windows.
However, there are also window managers that do <em>not</em> reparent at all: these are
called <em>non-reparenting</em> window managers. There are two reasons why a window
manager would not want to reparent:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
If a window manager does not draw window decorations around top level
   windows , it obviously has no need to reparent them. Examples:
   <a href="http://xmonad.org">xmonad</a>, <a href="http://dwm.suckless.org">dwm</a>.
</p>
</li>
<li>
<p>
Compositing window managers do not always need to reparent windows; we will
   discuss why below. Example: <a href="http://www.compiz.org/">Compiz</a>. This is not true
   for all compositing window managers, however; for example, GNOME&#8217;s default
   window manager, <a href="http://github.com/GNOME/mutter/">Mutter</a>, is a reparenting
   comopositing window manager.
</p>
</li>
</ol></div>
<div class="paragraph"><p>Let&#8217;s now consider substructure redirection in the context of reparenting. When
a top level window <em>W</em> is first shown (<em>map</em>'ped in X jargon), the window manager
is notified because it has registered for substructure redirection on the root
window, and a top level window is a direct child of the root window. It then
creates a frame <em>F</em> and reparents <em>W</em>, so that <em>W</em> becomes a child of <em>F</em>, which
itself is a child of the root window. But since now <em>W</em> is no longer a direct
child of the root window, the window manager will no longer be able to intercept
changes to <em>W</em>!</p></div>
<div class="paragraph"><p>Therefore, a reparenting window manager must also register for substructure
redirection on the frames it creates.</p></div>
</div>
<div class="sect3">
<h4 id="_compositing">Compositing</h4>
<div class="paragraph"><p>Compositing window managers are a relatively new development. Compositing
support in X  was added in late 2004, a full decade after the last edition of
<a href="http://www.amazon.com/Programming-Manual-Version-Definitive-Guides/dp/1565920023">Xlib
Programming Manual</a>. The first compositing window managers,
<a href="http://www.xfce.org">Xfwm</a> and <a href="http://www.compiz.org/">Compiz</a>, launched in early
2005.</p></div>
<div class="paragraph"><p>So, what exactly does a compositing window manager do?</p></div>
<div class="paragraph"><p>In our discussion above on substructure redirection and reparenting, we saw how
a window manager can respond to various requests for a top level window - to
display/hide it (<em>map</em>/<em>unmap</em> in X jargon), to resize it, to move it, etc.. But
we didn&#8217;t talk about how to deal with what&#8217;s <em>inside</em> the top level windows.</p></div>
<div class="paragraph"><p>Indeed, from the perspective of the window manager, top level windows are black
boxes; they each manage their own descendant windows (UI elements), perhaps
through a framework such as <a href="http://www.gtk.org">GTK+</a> or
<a href="http://qt-project.org/">Qt</a>, and the window manager has no right to interfere
there. The application that creates a top level window is responsible for
rendering and handling events for any descendant windows (UI elements), and does
so directly through X. This is shown in <a href="#role-of-a-window-manager">the first graph above</a>.</p></div>
<div class="paragraph"><p>As the computing power of graphics hardware grew, so did people&#8217;s expectations
from their window managers. With hardware acceleration, it became possible to
build much more computationally intensive user interfaces, such as the
(in)famous Desktop Cube in <a href="http://www.compiz.org">Compiz</a>:
<div align="center"><img src="/assets/files/wm_compiz.png"
style="max-width: 640px; width: 100%;"></div>
or the Shift Switcher:
<div align="center"><img src="/assets/files/wm_compiz_2.png"
style="max-width: 640px; width: 100%;"></div>
Let&#8217;s take a moment to think about how we can implement an interface such as the
Shift Switcher above. When the user triggers our wonderful interface, we need
to:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Render each top level window and all its descendant windows (UI elements) to
   an off-screen, in-memory buffer, instead of directly to the hardware.
</p>
</li>
<li>
<p>
Transform (rotate, contort, etc.) each buffer according to our design.
</p>
</li>
<li>
<p>
Composite the transformed buffers into a final buffer along with background
   and anything else we need to display.
</p>
</li>
<li>
<p>
Create an <em>overlay</em> window that covers the entire screen and hides all other
   windows.
</p>
</li>
<li>
<p>
Render the final buffer into the overlay window.
</p>
</li>
</ol></div>
<div class="paragraph"><p>There are a number of challenges:</p></div>
<div class="ulist"><ul>
<li>
<p>
We must be able to retrieve the contents of top level windows. However, top
  level windows render directly through X.
</p>
</li>
<li>
<p>
We need to update our interface in real time as the contents of the
  top level windows change. However, top level windows render directly through
  X and do not notify window managers when their contents change.
</p>
</li>
<li>
<p>
A top level window <em>A</em> may normally overlap with another top level window
  <em>B</em>, and thus a portion of <em>B</em> isn&#8217;t currently visible. Our interface,
  however, must capture the <em>full</em> rendering of <em>A</em> and <em>B</em>, regardless of
  overlapping regions.
</p>
</li>
<li>
<p>
The compositing process is computationally intensive and requires hardware
  acceleration to function adequately.
</p>
</li>
</ul></div>
<div class="paragraph"><p>It is clear that none of this is possible without heavy cooperation from the X
server. Enter
<a href="http://cgit.freedesktop.org/xorg/proto/compositeproto/tree/compositeproto.txt">the
Composite extension</a>:</p></div>
<div class="quoteblock">
<div class="content">Many user interface operations would benefit from having pixel contents of
window hierarchies available without respect to sibling and antecedent clipping.
In addition, placing control over the composition of these pixel contents into a
final screen image in an external application will enable a flexible system for
dynamic application content presentation.</div>
<div class="attribution">
&#8212; X Composite Extension
</div></div>
<div class="paragraph"><p>The Composite extension provides is a mechanism to request the X server not to
render a specific window and its descendants directly to hardware, but to a
special buffer maintained by the X server, and do so without the normal clipping
and overlap computations. This buffer can then be read and used by the client
that made the request.</p></div>
<div class="paragraph"><p>In fact, that&#8217;s exactly what a compositing window manager does: it will ask X to
render each top level window to an off-screen, in-memory buffer and composite
the results into an overlay window. And it needs to do this not just for fancy
interfaces, but also to achieve effects like translucency, window animations,
soft shadows, and the like.</p></div>
<div class="paragraph"><p>This is illustrated in the following diagram:
<div align="center"><img
src="https://docs.google.com/drawings/d/1eK05Uzlr2ix4NpsiEBUu42IwZ3DEjX8MvYTiE3-chqA/pub?w=573&amp;h=509"
style="max-width: 573px; width: 100%;"></div></p></div>
<div class="paragraph"><p>Let&#8217;s end this section by considering whether a compositing window manager
should reparent top level windows.</p></div>
<div class="paragraph"><p>Since a compositing window manager knows the size and position of all top level
windows, it&#8217;s trivial for it to just draw window decorations during compositing
into the overlay window using graphics operations, without ever creating an
actual frame window and reparenting. Some compositing window managers do operate
this way.</p></div>
<div class="paragraph"><p>On the other hand, a window manager may need to support both a compositing and a
non-compositing mode, for compatibility with older or unsupported graphics
hardware. In this case, it needs to implement reparenting and frame windows for
non-compositing mode anyway, so additionally implementing drawing window
decorations using graphics operations becomes redundant. This is why some other
compositing window managers still choose to reparent.</p></div>
</div>
</div>
<div class="sect2">
<h3 id="_ready_for_some_code">Ready For Some Code?</h3>
<div class="paragraph"><p>If you&#8217;ve read everything up to this point, you&#8217;re probably holding back the
urge to cry out "<em>Enough talk - show me some code!</em>" I don&#8217;t blame you.</p></div>
<div class="paragraph"><p>In <a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html">the
next installment</a> in this series, I will walk you through a basic
implementation of a reparenting, non-compositing window manager. Impatient?
Check out the code <a href="https://github.com/jichuan89/basic_wm">on GitHub</a> or browse
the cross-referenced code <a href="http://code.openhub.net/project?pid=&amp;ipid=568869">on
Open Hub</a>.</p></div>
<div class="paragraph"><p><strong>Next chapter:</strong>
<a href="/posts/how-x-window-managers-work-and-how-to-write-one-part-ii.html"><strong>How X
Window Managers Work, And How To Write One (Part II)</strong></a></p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Apr 10, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="http://seasonofcode.com/tag/window-manager.html">Window Manager</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/how-x-window-managers-work-and-how-to-write-one-part-i.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="http://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html" rel="bookmark">
      The Most Popular Fonts On The Web: A Study
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-04-04T23:04:00-07:00">
          Apr 04, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,            <a href="http://seasonofcode.com/tag/misc.html">Misc</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="http://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p><link rel="image_src"
href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/embed/oimg?id=1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc&oid=65057078&zx=ey1naahah70j">
If you&#8217;ve ever worked on a web site, you already know that choosing the right
fonts is one of the most important aesthetic decisions in the design of a site.
But, like all aesthetic decisions, it is a highly subjective.</p></div>
<div class="paragraph"><p>I decided to try to bring a little bit of objectivity into the equation by
finding out, empirically, what fonts the most popular sites on the web are using
today.</p></div>
<div class="sect2">
<h3 id="_methodology">Methodology</h3>
<div class="paragraph"><p>I wrote a Python program that crawls the front page of the 100,000 most popular
web sites according to <a href="http://www.alexa.com/topsites">Alexa&#8217;s top sites list</a>.
It parses the HTML using
<a href="http://www.crummy.com/software/BeautifulSoup/">BeautifulSoup</a>, and parses all
in-line and linked CSS stylesheets using <a href="http://cthedot.de/cssutils/">cssutils</a>.
It then looks for <code>font</code> and <code>font-family</code> rules in the CSS rules, and stores
the normalized form of each font in those rules in order. The result is kept in
a <a href="https://sqlite.org">SQLite</a> database for analysis.</p></div>
<div class="paragraph"><p>This all sounds pretty straightforward, but in fact it took me two weeks to
build a crawler that doesn&#8217;t choke on all the crazy crap people throw at
browsers. I will write up some of the more interesting cases in a separate post.</p></div>
<div class="paragraph"><p>The final crawl success rate was about 96%. The size of all HTML and stylesheets
downloaded was about 30GB.</p></div>
</div>
<div class="sect2">
<h3 id="_the_most_popular_first_choice_fonts">The Most Popular First-Choice Fonts</h3>
<div class="paragraph"><p>First, let&#8217;s take a look at the first-choice/most preferred fonts, i.e., the
ones that appear first in <code>font-family</code> rules. These fonts most closely
represent the intention of the web site designers without compatibility
compromises.</p></div>
<div class="paragraph"><p>For each font, we calculate the number of distinct web sites that have at least
one CSS <code>font</code> or <code>font-family</code> rule that lists the font as the first choice.
This means that if a site has two rules, one listing Arial and another
listing Times, it will count towards both. Thus, the numbers add up to much
higher than the total number of sites.</p></div>
<div class="paragraph"><p>Without further ado, here&#8217;s the breakdown of the top fonts on the web:
<div align="center"><iframe
height=620
style="max-width: 610px; width: 100%"
src="//docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=65057078"
seamless frameborder=0 scrolling=yes></iframe></div>
(The chart is interactive - hover/click to see actual numbers.)</p></div>
<div class="paragraph"><p>A couple of observations:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Sans-serif fonts dominate the web.</strong> The top 25 fonts list only includes 4
  serif fonts, compared to 16 sans-serif fonts. The most popular serif-font,
  Georgia, ranks #4 on the list with about 20% of sites.
</p>
</li>
<li>
<p>
<strong>Monospace fonts get no love.</strong> Most sites don&#8217;t bother
  specifying a custom monospace font; the most common monospace font
  specification just uses the browser default (12%). The most popular monospace
  font, Monaco, is featured on 7.2% of sites. Both of these are quite high, in
  fact, considering that we only crawl the front page of these sites.
</p>
</li>
<li>
<p>
<strong>The most popular fonts of each family:</strong>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Sans-serif:</strong> Arial (#1, 62%)
</p>
</li>
<li>
<p>
<strong>Serif:</strong> Georgia (#4, 20%)
</p>
</li>
<li>
<p>
<strong>Monospace:</strong> Monaco (#11, 7.2%)
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Old Microsoft fonts still reign over the web.</strong> The top non-Microsoft font,
  Helvetica Neue, ranks #6 with an impressive 18% of top web sites.
</p>
</li>
<li>
<p>
<strong><a href="http://fortawesome.github.io/Font-Awesome/">Font Awesome</a> is awesome</strong>. About
  4.6% of the top 100K sites already use it for universal icons.
</p>
</li>
<li>
<p>
<strong>The Chinese web is on the rise.</strong> 3 out of the top 25 fonts are Chinese fonts,
  compared to 21 Latin fonts (and 1 symbol font). No other scripts made their
  way into the list.
</p>
</li>
</ul></div>
<div class="sect3">
<h4 id="_what_if_we_considered_8230">What If We Considered&#8230;</h4>
<div class="ulist"><ul>
<li>
<p>
<strong>Fonts in all positions</strong>: (<a href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=940843634">graph</a>) not much difference.
</p>
</li>
<li>
<p>
<strong>The top 1,000 web sites only</strong>: (<a href="https://docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=1208179553">graph</a>) even more Arial (#1, 74%).
</p>
</li>
</ul></div>
</div>
</div>
<div class="sect2">
<h3 id="_the_most_popular_heading_fonts">The Most Popular Heading Fonts</h3>
<div class="paragraph"><p>Next, let&#8217;s look at first-choice fonts used in headings or titles.</p></div>
<div class="paragraph"><p>I used a really crude metric to determine whether a CSS rule matches a heading:
whether the CSS selector is for an <code>H1</code>&#8230;<code>H6</code> tag or contains the strings
"heading" or "title". While this finds only a subset of actual headings, it is
not a bad approximation as it matches rules on about 58% of the top 100,000
web sites.</p></div>
<div class="paragraph"><p>Let&#8217;s start with the graph:
<div align="center"><iframe
height=620
style="max-width: 610px; width: 100%"
src="//docs.google.com/spreadsheets/d/1LxHdYqTqK7b9Subq2F23IHRrhEYoYm7xdVPQMZexaNc/gviz/chartiframe?oid=1659247262"
seamless frameborder=0 scrolling=yes></iframe></div>
Observations:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>Header fonts are more diverse.</strong> While Microsoft fonts still reign supreme, a
  number or more exotic fonts are also on the list. In terms of distribution,
  there&#8217;s a much longer tail. It may be a sign that designers pay a lot
  more attention to fonts used in headings.
</p>
</li>
<li>
<p>
<strong>Serif fonts are more popular in headings than elsewhere.</strong> While Arial still
  claims to top spot with 27.31% of sites, the top serif font, Georgia, rises to
  2nd place with 9% of sites.
</p>
</li>
<li>
<p>
<strong>No monospace fonts in headings.</strong> Not surprising.
</p>
</li>
<li>
<p>
Among Chinese fonts, <strong>宋体 is more commonly used for body text, while 雅黑 (or
  Yahei) is more commonly used for heading text.</strong>
</p>
</li>
</ul></div>
</div>
<div class="sect2">
<h3 id="_concluding_thoughts">Concluding Thoughts</h3>
<div class="paragraph"><p>Arial and friends are the <a href="http://screenfont.ca/fonts/today/interim/">most</a>
<a href="http://pxlnv.com/blog/guaahhhhhhh-come-on/">hated</a>
<a href="http://www.prepressure.com/fonts/interesting/most-hated">fonts</a>
<a href="http://enjoytherandom.com/hipster-hitler-hates-arial/">ever</a>. Quoting
<a href="http://www.marksimonson.com/notebook/view/the-scourge-of-arial">The Scourge of
Arial</a>:</p></div>
<div class="quoteblock">
<div class="content">Despite its pervasiveness, a professional designer would rarely - at least for
the moment - specify Arial.</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>And yet, Arial is still the default font on the vast majority of sites on
the web, followed closely by its friends. Why?</p></div>
<div class="paragraph"><p>Quoting <a href="http://www.64notes.com/design/stop-helvetica-arial/">Stop Using Arial &amp;
Helvetica</a>:</p></div>
<div class="quoteblock">
<div class="content">Some people actually have a reason to use them but most use it mindlessly - just
because everyone else does. Often, no thought is given to design of the site,
let alone typography.</div>
<div class="attribution">
</div></div>
<div class="paragraph"><p>This is pretty sad. Paraphrasing
<a href="http://www.dtelepathy.com/blog/graveyard/stop-using-lame-fonts">Stop Using Lame
Fonts</a>, a good font stack has the potential to really make a site design shine,
and it&#8217;s a shame web designers aren&#8217;t exploiting this opportunity.</p></div>
</div>
<div class="sect2">
<h3 id="_caveats">Caveats</h3>
<div class="paragraph"><p>There are a couple of caveats with this dataset.</p></div>
<div class="paragraph"><p>First, I am only surveying the landing page of each site. For many sites,
notably those whose main interface is hidden behind a login (Facebook, Evernote,
etc.), we may not be finding the styles that matter most to users. However, I
figured since it would be pretty poor design to build a landing page that is
aesthetically inconsistent with the rest of the site, it is not very likely that
the font selection on the landing page would be too different from the fonts
used elsewhere on the site. Of course, without creating fake accounts on these sites,
we have no way to verify.</p></div>
<div class="paragraph"><p>The numbers are not weighted by prominence on the web pages. One could argue
that the font of the main body text on a page should carry more weight than that
of the tiny disclaimer text at the bottom which no one reads. It would be tricky
to determine what the right weight function is though.</p></div>
<div class="paragraph"><p>The numbers are not weighted by the prominence of the web sites. For example, we
could make it so that Google&#8217;s use of Arial would get more weight than some
random obscure site&#8217;s use of Arial, as Google&#8217;s choice impacts many more users
and was probably the result of deliberation by a team of expert designers.
Again, it&#8217;s not entirely obvious how the weights should be assigned.</p></div>
<div class="paragraph"><p>I am only looking at CSS rules in <code>&lt;style&gt;</code> tags or linked stylesheets. That
means I am ignoring <code>style="&#8230;"</code> attributes in tags, <code>&lt;font&gt;</code> elements, or
dynamically assigned fonts (i.e., through JavaScript). I would be surprised if
this turns out to be a big loss though.</p></div>
</div>
<div class="sect2">
<h3 id="_next_steps">Next Steps</h3>
<div class="paragraph"><p>I can think of quite a few other useful questions one might find the answer to
from this dataset:</p></div>
<div class="ulist"><ul>
<li>
<p>
What are the most common font pairings?
</p>
</li>
<li>
<p>
What are the popular choices for heading fonts, given that I&#8217;ve chosen font X
  as my body text font?
</p>
</li>
<li>
<p>
What are the most common fonts on news sites/forums/productivity web
  apps/social media sites?
</p>
</li>
<li>
<p>
Is there any correlation between font choice and site popularity?
</p>
</li>
</ul></div>
<div class="paragraph"><p>What do you think?</p></div>
<div class="paragraph"><p>Please feel free to <a href="https://www.mediafire.com/?xqrk731716v078l">download</a> the top
100 first-choice fonts as a CSV file.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Apr 04, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="http://seasonofcode.com/tag/featured.html">Featured</a>,          <a href="http://seasonofcode.com/tag/misc.html">Misc</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="http://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="http://seasonofcode.com/posts/the-most-popular-fonts-on-the-web-a-study.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <!--- <li class="previous disabled"><a>&larr; Previous</a></li> -->
    <li class="next"><a href="http://seasonofcode.com/tag/featured2.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text">&copy; <a href="http://seasonofcode.com">Season of Code</a></p>
      </div>
    </footer>
    <script src="http://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="http://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>