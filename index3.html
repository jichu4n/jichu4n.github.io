<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <title>Season of Code</title>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <link rel="shortcut icon" href="https://seasonofcode.com/assets/favicon.ico" />
      <link href="https://seasonofcode.com/theme/asciidoc.min.css?0e298cf5" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/bootstrap/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://seasonofcode.com/theme/font-awesome/css/font-awesome.min.css" rel="stylesheet" />
      <link href="https://seasonofcode.com/theme/style.min.css?2f610ad0" rel="stylesheet" />
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://seasonofcode.com/theme/html5shiv.min.js"></script>
    <script src="https://seasonofcode.com/theme/respond.min.js"></script>
    <![endif]-->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://seasonofcode.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Season of Code Full Atom Feed" />

<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-21264754-1', 'auto');
  ga('send', 'pageview');

</script>

<!-- Piwik -->
<script type="text/javascript">
  var _paq = _paq || [];
  _paq.push(["setDomains", ["*.seasonofcode.com"]]);
  _paq.push(['trackPageView']);
  _paq.push(['enableLinkTracking']);
  (function() {
    var u="//a.chu4n.com/";
    _paq.push(['setTrackerUrl', u+'js/']);
    _paq.push(['setSiteId', 2]);
    var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
    g.type='text/javascript'; g.async=true; g.defer=true; g.src=u+'js/'; s.parentNode.insertBefore(g,s);
  })();
</script>
<noscript><p><img src="//a.chu4n.com/js/?idsite=2" style="border:0;" alt="" /></p></noscript>
<!-- End Piwik Code -->

    <meta name="google-site-verification" content="g_MrQjKfWWKOccQYg--leY8NlSev0om0sy2vrBLYoZU">
    <meta name="google-site-verification" content="_r0m7LYlH2JjDgeTysX9Fv0OzQG1xUEAU6x2uSr9nH8">

    <meta name="msvalidate.01" content="F10D3C66876F50983761BFE53E2B943A4">

  <meta name="robots" content="noindex, follow">
  </head>
  <body id="index" class="archive">
    <!--[if lt IE 7]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
    <![endif]-->
    <nav id="header" class="navbar navbar-fixed-top navbar-inverse" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <i class="fa fa-bars fa-lg"></i>
          </button>
          <a class="navbar-brand" href="https://seasonofcode.com">
            season <span class="of">of</span> code
          </a>
        </div>
        <div class="collapse navbar-collapse navbar-right">
          <ul class="nav navbar-nav">
            <li>
              <a href="https://seasonofcode.com/tag/featured.html">Featured</a>
            </li>
            <li id="header-tags-dropdown" class="dropdown">
              <a href="#" class="dropdown-toggle" data-toggle="dropdown"
                role="button">Tags <i class="fa fa-caret-down"></i></a>
              <ul class="dropdown-menu">
                  <li><a href="https://seasonofcode.com/tag/android.html">Android</a></li>
                  <li><a href="https://seasonofcode.com/tag/c.html">C++</a></li>
                  <li><a href="https://seasonofcode.com/tag/featured.html">Featured</a></li>
                  <li><a href="https://seasonofcode.com/tag/linux.html">Linux</a></li>
                  <li><a href="https://seasonofcode.com/tag/misc.html">Misc</a></li>
                  <li><a href="https://seasonofcode.com/tag/projects.html">Projects</a></li>
                  <li><a href="https://seasonofcode.com/tag/python.html">Python</a></li>
                  <li><a href="https://seasonofcode.com/tag/window-manager.html">Window Manager</a></li>
              </ul>
            </li>
            <li>
              <a href="https://seasonofcode.com/archives.html">Archives</a>
            </li>
            <li><a href="https://seasonofcode.com/pages/about.html">About</a></li>
          </ul>
        </div>
        <!-- /.navbar-collapse -->
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-xs-12 col-md-8 col-md-offset-2">
    <section id="content" class="content">
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html" rel="bookmark">
      Python: Multiprocessing and Exceptions
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-03-10T22:54:00-07:00">
          Mar 10, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/python.html">Python</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Python&#8217;s
<a href="http://docs.python.org/3/library/multiprocessing.html"><code>multiprocessing</code></a> module
provides an interface for spawning and managing child processes that is familiar
to users of the <a href="http://docs.python.org/3/library/threading.html"><code>threading</code></a>
module. One problem with the <code>multiprocessing</code> module, however, is that
<strong>exceptions in spawned child processes don&#8217;t print stack traces</strong>:</p></div>
<div class="paragraph"><p>Consider the following snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">somelib</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">somelib</span><span class="o">.</span><span class="n">somefunc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div></div></div>
<div class="paragraph"><p>and the following error message:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "test.py", line 9, in &lt;module&gt;
    print(pool.map(f, range(5)))
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 228, in map
    return self._map_async(func, iterable, mapstar, chunksize).get()
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 564, in get
    raise self._value
ZeroDivisionError: division by zero</code></pre>
</div></div>
<div class="paragraph"><p>What triggered the <code>ZeroDivisionError</code>? Did <code>somelib.somefunc(x)</code> return 0, or
did some other computation in <code>somelib.somefunc()</code> cause the exception? You will
notice that we only see the stack trace of the main process, whereas the stack
trace of the code that actually triggered the exception in the worker processes
is not shown at all.</p></div>
<div class="paragraph"><p>Luckily, Python provides a handy
<a href="http://docs.python.org/3/library/traceback.html"><code>traceback</code></a> module for working
with exceptions and stack traces. All we have to do is catch the exception
inside the worker process, and print it. Let&#8217;s change the code above to read:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">multiprocessing</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">somelib</span>

<span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">somelib</span><span class="o">.</span><span class="n">somefunc</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="s">&#39;Caught exception in worker thread (x = </span><span class="si">%d</span><span class="s">):&#39;</span> <span class="o">%</span> <span class="n">x</span><span class="p">)</span>

    <span class="c"># This prints the type, value, and stack trace of the</span>
    <span class="c"># current exception being handled.</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">print</span><span class="p">()</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&#39;__main__&#39;</span><span class="p">:</span>
  <span class="k">with</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">Pool</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)))</span>
</pre></div></div></div>
<div class="paragraph"><p>Now, if you run the same code again, you will see something like this:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Caught exception in worker thread (x = 0):
Traceback (most recent call last):
  File "test.py", line 7, in f
    return 1 / somelib.somefunc(x)
  File "/path/to/somelib.py", line 2, in somefunc
    return 1 / x
ZeroDivisionError: division by zero

Traceback (most recent call last):
  File "test.py", line 16, in &lt;module&gt;
    print(pool.map(f, range(5)))
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 228, in map
    return self._map_async(func, iterable, mapstar, chunksize).get()
  File "/usr/lib/python3.3/multiprocessing/pool.py", line 564, in get
    raise self._value
ZeroDivisionError: division by zero</code></pre>
</div></div>
<div class="paragraph"><p>The printed traceback reveals <code>somelib.somefunc()</code> to be the actual culprit.</p></div>
<div class="paragraph"><p>In practice, you may want to save the exception and the stack trace somewhere.
For that, you can use the
<a href="http://docs.python.org/3/library/traceback.html#traceback.print_exc"><code>file</code></a>
argument of
<a href="http://docs.python.org/3/library/traceback.html#traceback.print_exc"><code>print_exc</code></a>
in combination with
<a href="http://docs.python.org/3/library/io.html?highlight=stringio#io.StringIO"><code>StringIO</code></a>.
For example:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">io</span>  <span class="c"># Import StringIO in Python 2</span>
<span class="o">...</span>

<span class="k">def</span> <span class="nf">Work</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="o">...</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">exc_buffer</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">(</span><span class="nb">file</span><span class="o">=</span><span class="n">exc_buffer</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
        <span class="s">&#39;Uncaught exception in worker process:</span><span class="se">\n</span><span class="si">%s</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="n">exc_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span>
    <span class="k">raise</span> <span class="n">e</span>
</pre></div></div></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Mar 10, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/python.html">Python</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/python-multiprocessing-and-exceptions.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/c-access-specifiers-and-overriding.html" rel="bookmark">
      C++: Access Specifiers and Overriding
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-03-01T00:19:00-08:00">
          Mar 01, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/c.html">C++</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/c-access-specifiers-and-overriding.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>Consider the following C++ code:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">#include &lt;iostream&gt;</span>
<span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">A</span> <span class="p">{</span>
 <span class="k">public</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">f</span><span class="p">()</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">B</span><span class="o">:</span> <span class="k">public</span> <span class="n">A</span> <span class="p">{</span>
 <span class="k">private</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">f</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B::f()&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="k">class</span> <span class="nc">C</span><span class="o">:</span> <span class="k">public</span> <span class="n">B</span> <span class="p">{</span>
 <span class="k">protected</span><span class="o">:</span>
  <span class="k">virtual</span> <span class="kt">void</span> <span class="n">f</span><span class="p">()</span> <span class="p">{</span>
   <span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;C::f()&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">endl</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">B</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">B</span><span class="p">();</span>
  <span class="c1">// This is NOT legal:</span>
  <span class="c1">//   b-&gt;f();</span>
  <span class="n">C</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">C</span><span class="p">();</span>
  <span class="c1">// Nor is this:</span>
  <span class="c1">//   c-&gt;f();</span>

  <span class="c1">// Why is this legal?</span>
  <span class="n">A</span> <span class="o">*</span><span class="n">a1</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
  <span class="n">a1</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">();</span>  <span class="c1">// Prints &quot;B::f()&quot;</span>
  <span class="n">A</span> <span class="o">*</span><span class="n">a2</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
  <span class="n">a2</span><span class="o">-&gt;</span><span class="n">f</span><span class="p">();</span>  <span class="c1">// Prints &quot;C::f()&quot;</span>

  <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div></div></div>
<div class="paragraph"><p>My first reaction, and perhaps yours too, is that this code shouldn&#8217;t be legal.
The base class <code>A</code> defines a public pure virtual method <code>f()</code> that must be
overridden in derived classes. But the <code>f()</code> implementations in both derived
classes are non-public; <code>B</code> and <code>C</code> actually <em>don&#8217;t</em> conform to the interface of
the base class (unless casted to the base class), as shown in the first block in
<code>main</code>.</p></div>
<div class="paragraph"><p>It turns out, however, that in C++ a method in a derived class overrides a
method in a base class <strong>regardless of the access specifiers of the two methods</strong>.
In other words, it does not matter whether the method is declared in the base
class as <code>public</code>, <code>protected</code>, or <code>private</code>, nor does it matter how the method
is declared in the derived class; as long as they have the same signature, the
method in the inherit class always overrides the method in the base class:</p></div>
<div class="quoteblock">
<div class="content">If a virtual member function <code>vf</code> is declared in a class <code>Base</code> and in a class
<code>Derived</code>, derived directly or indirectly from <code>Base</code>, a member function <code>vf</code>
with <strong>the same name</strong>, <strong>parameter-type-list</strong> (8.3.5), <strong>cv-qualification</strong>, and
<strong>ref- qualifier</strong> (or absence of same) as <code>Base::vf</code> is declared, then
<code>Derived::vf</code> is also virtual (whether or not it is so declared) and <strong>it
<em>overrides</em> <code>Base::vf</code></strong>.</div>
<div class="attribution">
&#8212; C++ standard §10.3.2
</div></div>
<div class="paragraph"><p>(Emphasis mine.)</p></div>
<div class="paragraph"><p>You will notice that access specifiers&#8201;&#8212;&#8201;<code>public</code>, <code>private</code>, etc.&#8201;&#8212;&#8201;are
specifically omitted from the list of criteria for determining an override
relationship. Thus, the above code works exactly as if both <code>B::f()</code> and
<code>C::f()</code> had been declared <code>public</code>.</p></div>
<div class="paragraph"><p>Another consequence of this rather bizarre omission is that the language
actually allows you to <code>public</code>-ly inherit from a base class, and yet <em>not</em>
conform to its public interface unless casted to the base class, as illustrated
in the first block in <code>main</code> above. Or, from the derived class&#8217;s perspective,
the language allows clients to legally access methods explicitly marked
<code>private</code> or <code>protected</code> through a cast to the base class.</p></div>
<div class="paragraph"><p>So, accidental omission or well thought-out design decision? Any ideas?</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Mar 01, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/c.html">C++</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/c-access-specifiers-and-overriding.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/c-access-specifiers-and-overriding.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/how-to-set-default-fonts-and-font-aliases-on-linux.html" rel="bookmark">
      How To Set Default Fonts and Font Aliases on Linux
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-02-22T01:32:00-08:00">
          Feb 22, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/linux.html">Linux</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/how-to-set-default-fonts-and-font-aliases-on-linux.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="sect3">
<h4 id="_font_woes">Font Woes</h4>
<div class="paragraph"><p>It&#8217;s fairly straightforward to set the default font used in native apps on a
modern Linux desktop, or the default fonts used to render web pages in your
browser of choice.</p></div>
<div class="paragraph"><p>But if you&#8217;re reading this, you probably know that that&#8217;s far from the end of
the story. You might have noticed that Firefox and Chrome rudely ignore your
font settings for many websites. This is because many (if not most) popular
sites, including <a href="http://www.google.com">Google</a>, <a href="http://www.yahoo.com">Yahoo</a>,
<a href="http://www.facebook.com">Facebook</a> or <a href="http://github.com">GitHub</a>, specify
preferred fonts for text:</p></div>
<div class="tableblock">
<table rules="none"
style="margin-left:auto; margin-right:auto;"
width="80%"
frame="void"
cellspacing="0" cellpadding="4">
<col width="16%" />
<col width="83%" />
<thead>
<tr>
<th align="left" valign="top"> Site                  </th>
<th align="left" valign="top"> Font Specification</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Google</p></td>
<td align="left" valign="top"><p class="table"><code>arial, sans-serif</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Yahoo</p></td>
<td align="left" valign="top"><p class="table"><code>Helvetica Neue, Helvetica, Arial</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Facebook</p></td>
<td align="left" valign="top"><p class="table"><code>lucida grande, tahoma, verdana, arial, sans-serif</code></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">GitHub</p></td>
<td align="left" valign="top"><p class="table"><code>Helvetica, arial, freesans, clean, sans-serif</code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>(Retrieved on 02/21/2014)</p></div>
<div class="paragraph"><p>You might immediately notice that the most commonly used fonts on these sites,
Arial and Helvetica, are fonts that come bundled with Microsoft Windows, and are
most likely <em>not</em> installed on your Linux system. In this case, what font is
<em>actually</em> used is anyone&#8217;s guess. If they <em>are</em> installed (e.g., via a package
like <a href="https://aur.archlinux.org/packages/ttf-ms-fonts/">ttf-ms-fonts</a> or directly
copied from a Windows machine), well, you still probably want to display your
favorite font instead :)</p></div>
<div class="paragraph"><p>So, let&#8217;s find out what your default fonts and aliases are with <code>fc-match</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">for</span> family in serif sans-serif monospace Arial Helvetica Verdana <span class="s2">&quot;Times New Roman&quot;</span> <span class="s2">&quot;Courier New&quot;</span><span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$family</span><span class="s2">: &quot;</span>
  <span class="nb">fc</span>-match <span class="s2">&quot;</span><span class="nv">$family</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div></div></div>
<div class="paragraph"><p>This is what I get on my machine by default:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>serif: DejaVuSerif.ttf: "DejaVu Serif" "Book"
sans-serif: DejaVuSans.ttf: "DejaVu Sans" "Book"
monospace: DejaVuSansMono.ttf: "DejaVu Sans Mono" "Book"
Arial: DejaVuSans.ttf: "DejaVu Sans" "Book"
Helvetica: n019003l.pfb: "Nimbus Sans L" "Regular"
Verdana: DejaVuSans.ttf: "DejaVu Sans" "Book"
Times New Roman: DejaVuSerif.ttf: "DejaVu Serif" "Book"
Courier New: DejaVuSansMono.ttf: "DejaVu Sans Mono" "Book"</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_font_configuration_files">Font Configuration Files</h4>
<div class="paragraph"><p>So, assuming you&#8217;ve installed your fonts of choice (via a package, copying to
<code>/usr/share/fonts</code> or <code>~/.fonts</code> - please verify with the <code>fc-list</code> command),
how do you set them as default in all apps and web sites?</p></div>
<div class="paragraph"><p>Well, there are two places where fonts are configured: system-wide configuration
resides in <code>/etc/fonts/</code>, and per-user configs are stored in
<code>~/.config/fontconfig/fonts.conf</code> (note that this used to be <code>~/.fonts.conf</code>
before <code>fontconfig</code> 2.10.1). For simplicity&#8217;s sake, we&#8217;ll do it in
<code>~/.config/fontconfig/fonts.conf</code>.</p></div>
<div class="paragraph"><p>Let&#8217;s open up <code>~/.config/fontconfig/fonts.conf</code>, or create it if it doesn&#8217;t
already exist. Put the following skeleton structure in there:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="cp">&lt;?xml version=&#39;1.0&#39;?&gt;</span>
<span class="cp">&lt;!DOCTYPE fontconfig SYSTEM &#39;fonts.dtd&#39;&gt;</span>
<span class="nt">&lt;fontconfig&gt;</span>
<span class="nt">&lt;/fontconfig&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>We will put all of our custom configuration between <code>&lt;fontconfig&gt;</code> and
<code>&lt;/fontconfig&gt;</code>.</p></div>
</div>
<div class="sect3">
<h4 id="_setting_default_fonts">Setting Default Fonts</h4>
<div class="paragraph"><p>First, let&#8217;s set the default serif, sans serif, and monospace fonts. I&#8217;ll use
the beautiful <a href="http://en.wikipedia.org/wiki/Croscore_fonts">Chrome OS fonts</a> as an
example
(<a href="https://aur.archlinux.org/packages/ttf-chromeos-fonts/"><code>ttf-chromeos-fonts</code></a> if
you&#8217;re running <a href="http://www.archlinux.org">Arch Linux</a>). Insert the following
between <code>&lt;fontconfig&gt;</code> and <code>&lt;/fontconfig&gt;</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="c">&lt;!-- Set preferred serif, sans serif, and monospace fonts. --&gt;</span>
  <span class="nt">&lt;alias&gt;</span>
    <span class="nt">&lt;family&gt;</span>serif<span class="nt">&lt;/family&gt;</span>
    <span class="nt">&lt;prefer&gt;&lt;family&gt;</span>Tinos<span class="nt">&lt;/family&gt;&lt;/prefer&gt;</span>
  <span class="nt">&lt;/alias&gt;</span>
  <span class="nt">&lt;alias&gt;</span>
    <span class="nt">&lt;family&gt;</span>sans-serif<span class="nt">&lt;/family&gt;</span>
    <span class="nt">&lt;prefer&gt;&lt;family&gt;</span>Arimo<span class="nt">&lt;/family&gt;&lt;/prefer&gt;</span>
  <span class="nt">&lt;/alias&gt;</span>
  <span class="nt">&lt;alias&gt;</span>
    <span class="nt">&lt;family&gt;</span>sans<span class="nt">&lt;/family&gt;</span>
    <span class="nt">&lt;prefer&gt;&lt;family&gt;</span>Arimo<span class="nt">&lt;/family&gt;&lt;/prefer&gt;</span>
  <span class="nt">&lt;/alias&gt;</span>
  <span class="nt">&lt;alias&gt;</span>
    <span class="nt">&lt;family&gt;</span>monospace<span class="nt">&lt;/family&gt;</span>
    <span class="nt">&lt;prefer&gt;&lt;family&gt;</span>Cousine<span class="nt">&lt;/family&gt;&lt;/prefer&gt;</span>
  <span class="nt">&lt;/alias&gt;</span>
</pre></div></div></div>
</div>
<div class="sect3">
<h4 id="_aliasing_microsoft_fonts">Aliasing Microsoft Fonts</h4>
<div class="paragraph"><p>Now, we will create aliases for commonly used fonts like Arial and Helvetica, so
that our favorite fonts will always be used instead of these fonts, e.g. when
requested by a web site.</p></div>
<div class="paragraph"><p>Insert the following between <code>&lt;fontconfig&gt;</code> and <code>&lt;/fontconfig&gt;</code>, after the
previous snippet:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>  <span class="c">&lt;!-- Aliases for commonly used MS fonts. --&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Arial<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Arimo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Helvetica<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Arimo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Verdana<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Arimo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Tahoma<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Arimo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="c">&lt;!-- Insert joke here --&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Comic Sans MS<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Arimo<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Times New Roman<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Tinos<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Times<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Tinos<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
  <span class="nt">&lt;match&gt;</span>
    <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Courier New<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
    <span class="nt">&lt;edit</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">mode=</span><span class="s">&quot;assign&quot;</span> <span class="na">binding=</span><span class="s">&quot;strong&quot;</span><span class="nt">&gt;</span>
      <span class="nt">&lt;string&gt;</span>Cousine<span class="nt">&lt;/string&gt;</span>
    <span class="nt">&lt;/edit&gt;</span>
  <span class="nt">&lt;/match&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>Note that the Microsoft fonts are aliased directly to the our preferred
substitute fonts. Aliasing to generic families (serif, sans-serif etc.) may or
may not work depending on your configuration in <code>/etc/fonts</code> (they didn&#8217;t work
for me), so it&#8217;s safer this way.</p></div>
<div class="paragraph"><p>This list is of course by no means definitive; add/remove aliases as you like.</p></div>
</div>
<div class="sect3">
<h4 id="_the_result">The Result</h4>
<div class="paragraph"><p>You&#8217;ll need to log out and back in for all applications to update. You should
see the difference immediately:</p></div>
<div class="paragraph"><div class="title">Google search results, before (Arial):</div><p><span class="image">
<img src="/assets/files/font_config_before.png" alt="/assets/files/font_config_before.png" width="500" />
</span></p></div>
<div class="paragraph"><div class="title">Google search results, after (Arimo):</div><p><span class="image">
<img src="/assets/files/font_config_after.png" alt="/assets/files/font_config_after.png" width="500" />
</span></p></div>
<div class="paragraph"><p>You can verify that the aliases have been set up correctly with <code>fc-match</code>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">for</span> family in serif sans-serif monospace Arial Helvetica Verdana <span class="s2">&quot;Times New Roman&quot;</span> <span class="s2">&quot;Courier New&quot;</span><span class="p">;</span> <span class="k">do</span>
  <span class="nb">echo</span> -n <span class="s2">&quot;</span><span class="nv">$family</span><span class="s2">: &quot;</span>
  <span class="nb">fc</span>-match <span class="s2">&quot;</span><span class="nv">$family</span><span class="s2">&quot;</span>
<span class="k">done</span>
</pre></div></div></div>
<div class="paragraph"><p>which should now give you something like:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>serif: Tinos-Regular.ttf: "Tinos" "Regular"
sans-serif: Arimo-Regular.ttf: "Arimo" "Regular"
monospace: Cousine-Regular.ttf: "Cousine" "Regular"
Arial: Arimo-Regular.ttf: "Arimo" "Regular"
Helvetica: Arimo-Regular.ttf: "Arimo" "Regular"
Verdana: Arimo-Regular.ttf: "Arimo" "Regular"
Times New Roman: Tinos-Regular.ttf: "Tinos" "Regular"
Courier New: Cousine-Regular.ttf: "Cousine" "Regular"</code></pre>
</div></div>
</div>
<div class="sect3">
<h4 id="_other_notes">Other Notes</h4>
<div class="paragraph"><p>Some existing examples you may find online show the following syntax:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c">&lt;!-- Deprecated syntax --&gt;</span>
<span class="nt">&lt;match</span> <span class="na">target=</span><span class="s">&quot;pattern&quot;</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span><span class="nt">&gt;</span>
  <span class="nt">&lt;test</span> <span class="na">name=</span><span class="s">&quot;family&quot;</span> <span class="na">qual=</span><span class="s">&quot;any&quot;</span><span class="nt">&gt;&lt;string&gt;</span>Arial<span class="nt">&lt;/string&gt;&lt;/test&gt;</span>
  ...
<span class="nt">&lt;/match&gt;</span>
</pre></div></div></div>
<div class="paragraph"><p>This will produce an error message like</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Fontconfig error: "/home/username/.config/fontconfig/fonts.conf", line 38: invalid attribute 'name'</code></pre>
</div></div>
<div class="paragraph"><p>The fix is to change <code>&lt;match target="pattern" name="family"&gt;</code> to just <code>&lt;match&gt;</code>,
as shown above.</p></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 22, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/linux.html">Linux</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/how-to-set-default-fonts-and-font-aliases-on-linux.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/how-to-set-default-fonts-and-font-aliases-on-linux.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html" rel="bookmark">
      Unicode I/O and Locales in Python
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2014-02-20T17:51:00-08:00">
          Feb 20, 2014
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/python.html">Python</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I recently ran into a weird error when running some Python code in a chroot jail.</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="n">s</span> <span class="o">=</span> <span class="s">&#39;你好&#39;</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>gave me</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python3.3/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 0: ordinal not in range(128)</code></pre>
</div></div>
<div class="paragraph"><p>The same happened with interprocess I/O:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="s">&#39;/usr/bin/cat&#39;</span><span class="p">,</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">universal_newlines</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
  <span class="p">(</span><span class="n">cmd_stdout</span><span class="p">,</span> <span class="n">cmd_stderr</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>gave me</p></div>
<div class="listingblock">
<div class="content">
<pre><code>Traceback (most recent call last):
  File "&lt;stdin&gt;", line 1, in &lt;module&gt;
  File "/usr/lib/python3.3/subprocess.py", line 578, in check_output
    output, unused_err = process.communicate(timeout=timeout)
  File "/usr/lib/python3.3/subprocess.py", line 908, in communicate
    stdout = _eintr_retry_call(self.stdout.read)
  File "/usr/lib/python3.3/subprocess.py", line 479, in _eintr_retry_call
    return func(*args)
  File "/usr/lib/python3.3/encodings/ascii.py", line 26, in decode
    return codecs.ascii_decode(input, self.errors)[0]
UnicodeDecodeError: 'ascii' codec can't decode byte 0xe4 in position 0: ordinal not in range(128)</code></pre>
</div></div>
<div class="paragraph"><p>It turns out that Python <code>str</code>'s are encoded to/decoded from raw bytes during
I/O (<code>print</code>, file I/O, IPC, etc) using the <em>default</em> system locale encoding.
The advantage is that, if your system locale is set up correctly, everything
just works - there&#8217;s no explicit encoding/decoding between strings and bytes.
The downside is that your Python code that runs fine on one machine can fail
mysteriously on a different machine.</p></div>
<div class="paragraph"><p>In my case, the chroot jail yielded:</p></div>
<div class="listingblock">
<div class="content">
<pre><code>$ locale
LANG=C
LC_CTYPE="C"
LC_NUMERIC="C"
LC_TIME="C"
LC_COLLATE="C"
LC_MONETARY="C"
LC_MESSAGES="C"
LC_PAPER="C"
LC_NAME="C"
LC_ADDRESS="C"
LC_TELEPHONE="C"
LC_MEASUREMENT="C"
LC_IDENTIFICATION="C"
LC_ALL=</code></pre>
</div></div>
<div class="sect3">
<h4 id="_solution_a">Solution A</h4>
<div class="paragraph"><p>The simplest solution is to set the system locale, either just for the Python
program or for your shell. For example,</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Run ./my_program.py with a custom LANG value.</span>
<span class="nv">LANG</span><span class="o">=</span>en_US.utf-8 ./my_program.py
</pre></div></div></div>
<div class="paragraph"><p>or</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Set locale for current shell session.</span>
<span class="nb">export </span><span class="nv">LANG</span><span class="o">=</span>en_US.utf-8
./my_program.py
</pre></div></div></div>
<div class="paragraph"><p>In fact, it&#8217;s probably a good idea to add the <code>export</code> line to your <code>~/.bashrc</code>,
or follow however your Linux distro decides locales should be set.</p></div>
</div>
<div class="sect3">
<h4 id="_solution_b">Solution B</h4>
<div class="paragraph"><p>On the other hand, you can explicitly set the encoding used during I/O in your
Python code.</p></div>
<div class="paragraph"><p>For file I/O, in Python 3.x, you can set the <code>encoding</code> argument of
<a href="http://docs.python.org/3.3/library/functions.html#open"><code>open</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Python 3.x</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>In Python 2.x, you can use
<a href="http://docs.python.org/2/library/codecs.html#codecs.open"><code>codecs.open</code></a>:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Python 2.x</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="k">with</span> <span class="n">codecs</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="p">)</span>
</pre></div></div></div>
<div class="paragraph"><p>Alternatively, you can use raw mode for file I/O:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/asdf&#39;</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div></div></div>
<div class="paragraph"><p>For IPC with <code>subprocess</code>, you must <strong>not</strong> use <code>universal_newlines=True</code>, as that
will always attempt to encode/decode using the system locale. Instead:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="k">with</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
    <span class="s">&#39;/usr/bin/cat&#39;</span><span class="p">,</span>
    <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
    <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span> <span class="k">as</span> <span class="n">proc</span><span class="p">:</span>
  <span class="p">(</span><span class="n">cmd_stdout_bytes</span><span class="p">,</span> <span class="n">cmd_stderr_bytes</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">(</span><span class="s">&#39;你好&#39;</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
  <span class="p">(</span><span class="n">cmd_stdout</span><span class="p">,</span> <span class="n">cmd_stderr</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">cmd_stdout_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">cmd_stderr_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">))</span>
</pre></div></div></div>
</div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 20, 2014
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/python.html">Python</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/unicode-io-and-locales-in-python.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
        <section class="article content">
<article itemscope itemtype="http://schema.org/Article">
  <header>
    <h2 class="entry-title">
      <a itemprop="name" href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html" rel="bookmark">
      Disabling Screen-Off Animation In Android
      </a>
    </h2>
    <!--googleoff: snippet-->
    <aside>
      <ul class="article-meta text-muted small">
        <li class="article-author">
          By <span itemprop="author">Chuan Ji</span>
        </li>
        <li class="spacer">|</li>
        <li class="article-date">
        <span itemprop="datePublished" content="2013-02-02T02:41:49-08:00">
          Feb 02, 2013
        </span>
        </li>
        <li class="spacer">|</li>
        <li>
          Tags:
            <a href="https://seasonofcode.com/tag/android.html">Android</a>,            <a href="https://seasonofcode.com/tag/featured.html">Featured</a>        </li>
        <li class="spacer">|</li>
        <li class="article-comments-count">
          <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html#disqus_thread">Comments</a>
        </li>
      </ul>
    </aside>
    <!--googleon: snippet-->
  </header>

  <div itemprop="articleBody" class="entry-content">
    <div class="paragraph"><p>I am impressed by the amazing progress Android&#8217;s UI has made since its
inception. With each iteration, likewise in software as in hardware, its
usability and aesthetics have steadily improved to the point where I can now
confidently buy one for my mom to replace the iPhone I recommended to her only
last year.</p></div>
<div class="paragraph"><p>On the other hand, one particular "feature" I intensely dislike is the
screen-off animation that emulates the brief white flash you see when an old CRT
TV monitor is powering off. Introduced in Gingerbread (2.3), it seems not to
bother most people as much as it bothers me, and even seems to be quite popular
(e.g., <a href="http://forum.xda-developers.com/showthread.php?t=1890526">this thread</a>).</p></div>
<div class="paragraph"><p>I was glad to learn though that a number of people find it as annoying as I do,
for example in
<a href="http://forum.cyanogenmod.org/topic/64185-any-way-to-disable-the-screen-off-animation-in-101/">this thread</a>
and <a href="http://code.google.com/p/cyanogenmod/issues/detail?id=6519">this bug</a>.</p></div>
<div class="paragraph"><p>As a CyanogenMod fan, I was quite happy with the straightforward checkbox in the
Settings app in CyanogenMod 9 that toggled whether to play this animation. In
CM10, this option was removed, but there was an easy hack involving changing
window animation scale in the developer settings, as explained in the
<a href="http://code.google.com/p/cyanogenmod/issues/detail?id=6519">second link above</a>.</p></div>
<div class="paragraph"><p>So when I updated to CM10.1 M1, I was very unpleasantly surprised to find that
this hack does not work any more either. I tried to immediately downgrade to
CM10, but then discovered that doing so requires a full data wipe (of
course&#8230;). A quick search pulled up
<a href="http://forum.xda-developers.com/showthread.php?t=1989397">this thread</a> which
proposes a simple prop edit, but the following posts in the thread suggest mixed
results.</p></div>
<div class="paragraph"><p>So, stuck with CM10.1, and really disgusted at this turn of events, I finally
decided to put on my hax0r gloves and get this annoying "feature" out of my face
once and for all.</p></div>
<div class="paragraph"><p><strong>Poking Around</strong></p></div>
<div class="paragraph"><p>I went to <a href="http://androidxref.com/">androidxref.com</a> and started searching
the Android source code for "screen off animation". (OK, I actually started out
with <em>grep</em>, but it didn&#8217;t take me long to realize
<a href="http://androidxref.com/">androidxref.com</a> was about sixty million times
faster - it&#8217;s really pretty cool.)</p></div>
<div class="paragraph"><p>I quickly found why changing the window animation scale in <strong>Jelly Bean 4.1 (and
CM10)</strong> disables the screen-off animation. The two snippets of of code
implementing this behavior are at
<a href="http://androidxref.com/4.0.4/xref/frameworks/base/services/java/com/android/server/PowerManagerService.java#470">line 470</a> and
<a href="http://androidxref.com/4.0.4/xref/frameworks/base/services/java/com/android/server/PowerManagerService.java#2228">line 2228</a>
of <code>PowerManagerService.java</code>.</p></div>
<div class="paragraph"><p>In <strong>Jelly Bean 4.2 (and CM10.1)</strong>, however, these parts of the code have been
completely refactored. The snippet of code that launches the screen-off
animation is now found at
<a href="http://androidxref.com/4.2_r1/xref/frameworks/base/services/java/com/android/server/power/DisplayPowerController.java#704">line 704</a>
of <code>DisplayPowerController.java</code>. Note that this new <code>DisplayPowerController</code>
class has been factored out of the old <code>PowerManagerService</code> class, and both
have moved into a separate <code>power</code> sub-directory.</p></div>
<div class="paragraph"><p><strong>The Hacking</strong></p></div>
<div class="paragraph"><p><em>Disclaimer: I am <strong>NOT</strong> responsible for anything that happens to your phone or
you or your house or your relationship with your wife if you follow the
instructions down here. If you don&#8217;t know what you&#8217;re doing and are scared of
bricking your phone, just give up and go watch Superbowl. Please.</em></p></div>
<div class="paragraph"><p>What did <em>not</em> change, I found, is that this code gets packaged into
<code>/system/framework/services.jar</code> on the Android system. So, let&#8217;s take a look at
this file as found in the CM10.1 image on my phone:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Copy services.jar from phone to current directory.</span>
adb pull /system/framework/services.jar
<span class="c"># Disassemble.</span>
apktool d services.jar
</pre></div></div></div>
<div class="paragraph"><p>(<code><a href="http://code.google.com/p/android-apktool/">apktool</a></code> is a tool that
extracts and disassembles Android APK/JAR files, and is available for Linux,
Windows and OS X.) This produces a directory, <code>services.jar.out</code>, which contains
the disassembled code of <code>services.jar</code> we just pulled from a connected phone. I
dived into the <code>DisplayPowerController</code> code and edited the <em>else</em> clause at
<a href="http://androidxref.com/4.2_r1/xref/frameworks/base/services/java/com/android/server/power/DisplayPowerController.java#704">line 704</a>
to essentially just say <code>setScreenOn(false);</code> directly instead of running
the animation first. If you look at the dissassembled code, you&#8217;d realize Dalvik
bytecode is really quite readable and easy to hack, especially since the line
number hints allow you to directly map a line in the Java source code to the
corresponding Dalvik instructions. I just had the Java source file on
<a href="http://androidxref.com">androidxref.com</a> open in a browser tab for reference
and killed instructions line by line. You can
<a href="http://www.mediafire.com/?5e8s5kzblav4a5g">download my patch here</a> and apply
it like this:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre>patch -d services.jar.out -Np1 &lt; path/to/disable_screen_off_animation.patch
</pre></div></div></div>
<div class="paragraph"><p>(For CM10.1 nightlies (after the MR1.1 merge) and CM10.1 M2, use
<a href="http://www.mediafire.com/download.php?drw5t67v24tb4x9">this patch</a> instead.
The same piece of code was shuffled around to
<a href="https://github.com/CyanogenMod/android_frameworks_base/blob/f6f6b1d37c1d5a8ba687e4d09761eb762f7269af/services/java/com/android/server/power/DisplayPowerController.java#L777">line 777</a>. For CM10.1 M3, use
<a href="http://www.mediafire.com/download.php?3xghfg9yfqyj9o7">this patch</a> instead.)</p></div>
<div class="paragraph"><p>Now re-assemble the code and push it back on to the device:</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Re-assemble modified sources as services-mod.jar.</span>
apktool b services.jar.out services-mod.jar
<span class="c"># Copy services-mod.jar to /sdcard/ on phone.</span>
adb push services-mod.jar /sdcard/
<span class="c"># Remount /system partition as read-write in order to modify it.</span>
adb shell su -c <span class="s1">&#39;mount -o rw,remount /system&#39;</span>
<span class="c"># Overwrite original services.jar on phone with services-mod.jar as root.</span>
adb shell su -c <span class="s1">&#39;cp /sdcard/services-mod.jar /system/framework/services.jar&#39;</span>
<span class="c"># Reboot phone for this to take effect.</span>
adb reboot
</pre></div></div></div>
<div class="paragraph"><p>When the phone reboots, it will say Android is upgrading and will rebuild Dalvik
cache for each application, so it might take a while. But hey, it&#8217;s worth it.</p></div>
<div class="paragraph"><p><strong>Parting Words</strong></p></div>
<div class="paragraph"><p>The final product, if you just want to replace the <code>services.jar</code> on your phone, is here:</p></div>
<div class="ulist"><ul>
<li>
<p>
<strong>CyanogenMod 10.1 M1</strong> - tested on Galaxy Nexus (maguro) and Nexus S (crespo), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?16dhrvk7esr77br">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 M2</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?kdd4af6h81bq8">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 M3</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?78cvqi6qe0s3yoy">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>CyanogenMod 10.1 RC1</strong> - tested on Galaxy Nexus (maguro), should work on other phones as well (can&#8217;t promise - let me know):
</p>
<div class="ulist"><ul>
<li>
<p>
<a href="http://www.mediafire.com/?w1527lnv5eoh8kl">services-mod.jar</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Stock 4.2.2 (takju/JDQ39)</strong> - for <a href="https://developers.google.com/android/nexus/images#takjujdq39">"takju" factory image from Google</a>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Note</strong>: use this to replace <code>services.<strong>odex</strong></code>, not <code>services.<strong>jar</strong></code>!
</p>
</li>
<li>
<p>
<a href="http://www.mediafire.com/?g5guv4hkcvt9owm">services-mod.odex</a>
</p>
</li>
</ul></div>
</li>
<li>
<p>
<strong>Stock 4.2.2 (yakju/JDQ39)</strong> - for <a href="https://developers.google.com/android/nexus/images#yakjujdq39">"yakju" factory image from Google</a>
</p>
<div class="ulist"><ul>
<li>
<p>
<strong>Note</strong>: use this to replace <code>services.<strong>odex</strong></code>, not <code>services.<strong>jar</strong></code>!
</p>
</li>
<li>
<p>
<a href="http://www.mediafire.com/?8ttffv118tnxgp5">services-mod.odex</a>
</p>
</li>
</ul></div>
</li>
</ul></div>
<div class="paragraph"><p>Apply the <code>services-mod.jar</code> to your phone like this (obviously assuming you
have adb working and root):</p></div>
<div class="listingblock">
<div class="content"><div class="highlight"><pre><span class="c"># Copy services-mod.jar to /sdcard/ on phone.</span>
adb push services-mod.jar /sdcard/
<span class="c"># Remount /system partition as read-write in order to modify it.</span>
adb shell su -c <span class="s1">&#39;mount -o rw,remount /system&#39;</span>
<span class="c"># Overwrite original services.jar on phone with services-mod.jar as root.</span>
adb shell su -c <span class="s1">&#39;cp /sdcard/services-mod.jar /system/framework/services.jar&#39;</span>
<span class="c"># Reboot phone for this to take effect.</span>
adb reboot
</pre></div></div></div>
<div class="paragraph"><p>Or, I suppose, you could just use ES File Explorer with root mode enabled, mount
<code>/system</code> as read-write and copy the file to <code>/system/framework/services.jar</code> on
the phone.</p></div>
<div class="paragraph"><p>Note that a reboot is needed after you replace the <code>services.jar</code> whatever you
do, and upon the first reboot the "Android is upgrading" dialog will pop up.</p></div>

  </div>

  <footer class="article-info text-muted small">
    <ul class="article-meta text-right">
      <li class="article-author">
        By Chuan Ji
      </li>
      <li class="spacer">|</li>
      <li class="article-date">
        Feb 02, 2013
      </li>
      <li class="spacer">|</li>
      <li>
        Tags:
          <a href="https://seasonofcode.com/tag/android.html">Android</a>,          <a href="https://seasonofcode.com/tag/featured.html">Featured</a>      </li>
      <li class="spacer">|</li>
      <li class="article-comments-count">
        <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html#disqus_thread">Comments</a>
      </li>
      <li class="spacer">|</li>
      <li class="article-link">
        <a href="https://seasonofcode.com/posts/disabling-screen-off-animation-in-android.html">Permalink</a>
      </li>
    </ul>
  </footer>
</article>        </section>
        <div class="article-divider">
          <span class="bullet_1">&bull;</span>
          <span class="bullet_2">&bull;</span>
          <span class="bullet_3">&bull;</span>
          <span class="bullet_4">&bull;</span>
          <span class="bullet_5">&bull;</span>
        </div>
<div>
  <ul class="pager">
    <li class="previous"><a href="https://seasonofcode.com/index2.html">&larr; Previous</a></li>
    <li class="next"><a href="https://seasonofcode.com/index4.html">Next &rarr;</a></li>
  </ul>
</div>
    </section>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
        <p class="footer-text text-muted">&copy; 2015 Chuan Ji</p>
      </div>
    </footer>
    <script src="https://seasonofcode.com/theme/jquery.min.js"></script>
    <script src="https://seasonofcode.com/theme/bootstrap/js/bootstrap.min.js"></script>

<script type="text/javascript">
  var disqus_shortname = 'cjix';
  (function () {
      var s = document.createElement('script');
      s.async = true;
      s.type = 'text/javascript';
      s.src = '//' + disqus_shortname + '.disqus.com/count.js';
      (document.getElementsByTagName('HEAD')[0] ||
       document.getElementsByTagName('BODY')[0]).appendChild(s);
  }());
</script>

  </body>
</html>